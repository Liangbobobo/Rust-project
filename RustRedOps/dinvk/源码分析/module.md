- [æ³¨æ„](#æ³¨æ„)
  - [ä»€ä¹ˆæ˜¯åŠ è½½å™¨ï¼ˆLoaderï¼‰ï¼Ÿ](#ä»€ä¹ˆæ˜¯åŠ è½½å™¨loader)
    - [1. æ“ä½œç³»ç»Ÿè§†è§’ï¼šæ ‡å‡†åŠ è½½å™¨ï¼ˆOS Loaderï¼‰](#1-æ“ä½œç³»ç»Ÿè§†è§’æ ‡å‡†åŠ è½½å™¨os-loader)
      - [ä¸»è¦èŒè´£æµç¨‹](#ä¸»è¦èŒè´£æµç¨‹)
    - [2. å®‰å…¨ä¸Žçº¢é˜Ÿè§†è§’ï¼šè‡ªå®šä¹‰åŠ è½½å™¨ï¼ˆCustom Loaderï¼‰](#2-å®‰å…¨ä¸Žçº¢é˜Ÿè§†è§’è‡ªå®šä¹‰åŠ è½½å™¨custom-loader)
      - [ä¸ºä»€ä¹ˆè¦è‡ªå·±å†™åŠ è½½å™¨ï¼Ÿ](#ä¸ºä»€ä¹ˆè¦è‡ªå·±å†™åŠ è½½å™¨)
      - [å¸¸è§ç±»åž‹](#å¸¸è§ç±»åž‹)
    - [3. ç»“åˆä½ çš„é¡¹ç›®ï¼ˆ`dinvk`ï¼‰ï¼šåŠ è½½å™¨çš„æ·±åº¦å®žçŽ°](#3-ç»“åˆä½ çš„é¡¹ç›®dinvkåŠ è½½å™¨çš„æ·±åº¦å®žçŽ°)
      - [ç¬¬ä¸€æ­¥ï¼šè§£æž PE å¤´ï¼ˆPE Parsingï¼‰](#ç¬¬ä¸€æ­¥è§£æž-pe-å¤´pe-parsing)
      - [ç¬¬äºŒæ­¥ï¼šå†…å­˜åˆ†é…ï¼ˆAllocationï¼‰](#ç¬¬äºŒæ­¥å†…å­˜åˆ†é…allocation)
      - [ç¬¬ä¸‰æ­¥ï¼šæ˜ å°„èŠ‚ï¼ˆMapping Sectionsï¼‰â€”â€”å…³é”®](#ç¬¬ä¸‰æ­¥æ˜ å°„èŠ‚mapping-sectionså…³é”®)
      - [ç¬¬å››æ­¥ï¼šåŸºå€é‡å®šä½ï¼ˆBase Relocationï¼‰](#ç¬¬å››æ­¥åŸºå€é‡å®šä½base-relocation)
      - [ç¬¬äº”æ­¥ï¼šè§£æžå¯¼å…¥è¡¨ï¼ˆResolve Imports / IAT Fixingï¼‰](#ç¬¬äº”æ­¥è§£æžå¯¼å…¥è¡¨resolve-imports--iat-fixing)
      - [ç¬¬å…­æ­¥ï¼šæƒé™æœ€ç»ˆè®¾ç½®ï¼ˆFinalize Protectionsï¼‰](#ç¬¬å…­æ­¥æƒé™æœ€ç»ˆè®¾ç½®finalize-protections)
      - [ç¬¬ä¸ƒæ­¥ï¼šæ‰§è¡Œï¼ˆExecutionï¼‰](#ç¬¬ä¸ƒæ­¥æ‰§è¡Œexecution)
    - [4. é¡¹ç›®ç»“æž„ä¸ŽåŠ è½½å™¨åŠŸèƒ½çš„æ˜ å°„](#4-é¡¹ç›®ç»“æž„ä¸ŽåŠ è½½å™¨åŠŸèƒ½çš„æ˜ å°„)
    - [5. ä¸ºä»€ä¹ˆè¿™è¢«ç§°ä¸º â€œRedOpsâ€ï¼Ÿ](#5-ä¸ºä»€ä¹ˆè¿™è¢«ç§°ä¸º-redops)
  - [æ­¤é¡¹ç›®æ‰¾DLL åŸºå€çš„åŽŸç†](#æ­¤é¡¹ç›®æ‰¾dll-åŸºå€çš„åŽŸç†)
  - [TEB](#teb)
  - [PEå’ŒPEBçš„ä¸‰å¤§æ ¸å¿ƒè”ç³»](#peå’Œpebçš„ä¸‰å¤§æ ¸å¿ƒè”ç³»)
    - [è”ç³»ä¸€:å®šä½ä¸»æ¨¡å—åŸºå€ (PEB.ImageBaseAddress)](#è”ç³»ä¸€å®šä½ä¸»æ¨¡å—åŸºå€-pebimagebaseaddress)
    - [è”ç³»äºŒ:ç®¡ç†æ‰€æœ‰åŠ è½½çš„ PE æ¨¡å— (PEB.Ldr)](#è”ç³»äºŒç®¡ç†æ‰€æœ‰åŠ è½½çš„-pe-æ¨¡å—-pebldr)
    - [è”ç³»ä¸‰: æ•°æ®ç›®å½•çš„è¿è¡Œæ—¶è®¿é—®ï¼ˆData Directoriesï¼‰](#è”ç³»ä¸‰-æ•°æ®ç›®å½•çš„è¿è¡Œæ—¶è®¿é—®data-directories)
  - [PE](#pe)
    - [æœ¬é¡¹ç›®æ²¡æœ‰å®šä¹‰ä¸€ä¸ªæŠŠæ‰€æœ‰å­—æ®µæ‰“åŒ…åœ¨ä¸€èµ·çš„å•ä¸€ `PE`ç»“æž„ä½“ï¼Ÿ](#æœ¬é¡¹ç›®æ²¡æœ‰å®šä¹‰ä¸€ä¸ªæŠŠæ‰€æœ‰å­—æ®µæ‰“åŒ…åœ¨ä¸€èµ·çš„å•ä¸€-peç»“æž„ä½“)
      - [dinvk çš„åšæ³•ï¼šé€šè¿‡æŒ‡é’ˆå’Œåç§»é‡è®¿é—®](#dinvk-çš„åšæ³•é€šè¿‡æŒ‡é’ˆå’Œåç§»é‡è®¿é—®)
    - [PE (Memory Layout)](#pe-memory-layout)
    - [PEæ–‡ä»¶ç»“æž„](#peæ–‡ä»¶ç»“æž„)
      - [PE æ–‡ä»¶ç»“æž„è¯¦è§£ï¼šåŸºäºŽ `dinvk` é¡¹ç›®ä¸­çš„æ•°æ®ç»“æž„](#pe-æ–‡ä»¶ç»“æž„è¯¦è§£åŸºäºŽ-dinvk-é¡¹ç›®ä¸­çš„æ•°æ®ç»“æž„)
      - [ç¬¬ä¸€éƒ¨åˆ†ï¼šDOS Headerï¼ˆå…¼å®¹æ€§å¤´éƒ¨ï¼‰](#ç¬¬ä¸€éƒ¨åˆ†dos-headerå…¼å®¹æ€§å¤´éƒ¨)
      - [ç¬¬äºŒéƒ¨åˆ†ï¼šNT Headersï¼ˆPE æ ¸å¿ƒå¤´ï¼‰](#ç¬¬äºŒéƒ¨åˆ†nt-headerspe-æ ¸å¿ƒå¤´)
        - [2.1 File Headerï¼ˆæ–‡ä»¶ç‰©ç†æ¦‚å†µï¼‰](#21-file-headeræ–‡ä»¶ç‰©ç†æ¦‚å†µ)
        - [2.2 Optional Headerï¼ˆé€»è¾‘åŠ è½½ä¿¡æ¯ï¼‰](#22-optional-headeré€»è¾‘åŠ è½½ä¿¡æ¯)
      - [2.3 Data Directoryï¼ˆåŠŸèƒ½ç´¢å¼•è¡¨ï¼‰](#23-data-directoryåŠŸèƒ½ç´¢å¼•è¡¨)
      - [`IMAGE_EXPORT_DIRECTORY->AddressOfNames` çš„å†…å­˜å½’å±žè§£æž](#image_export_directory-addressofnames-çš„å†…å­˜å½’å±žè§£æž)
        - [1. **ç‰©ç†å½’å±žï¼šå®ƒæ˜¯ç›®æ ‡ DLL çš„ä¸€éƒ¨åˆ†**](#1-ç‰©ç†å½’å±žå®ƒæ˜¯ç›®æ ‡-dll-çš„ä¸€éƒ¨åˆ†)
        - [2. **å†…å­˜ä½ç½®ï¼šä½äºŽå½“å‰è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´å†…**](#2-å†…å­˜ä½ç½®ä½äºŽå½“å‰è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´å†…)
        - [3. **æŠ€æœ¯ç»†èŠ‚ä¿®æ­£ï¼šå®ƒæ˜¯ä¸€ä¸ªâ€œRVA æ•°ç»„â€ï¼Œè€Œéžâ€œå­—ç¬¦ä¸²æ•°ç»„â€**](#3-æŠ€æœ¯ç»†èŠ‚ä¿®æ­£å®ƒæ˜¯ä¸€ä¸ªrva-æ•°ç»„è€Œéžå­—ç¬¦ä¸²æ•°ç»„)
        - [æ€»ç»“](#æ€»ç»“)
      - [ç¬¬ä¸‰éƒ¨åˆ†ï¼šSection Headersï¼ˆèŠ‚è¡¨ï¼‰](#ç¬¬ä¸‰éƒ¨åˆ†section-headersèŠ‚è¡¨)
      - [æ€»ç»“ï¼šWindows PE åŠ è½½æµç¨‹](#æ€»ç»“windows-pe-åŠ è½½æµç¨‹)
  - [PEB](#peb)
    - [ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶äº§ç”Ÿå¤šä¸ªè¿›ç¨‹æ—¶PEBæ˜¯æ€Žä¹ˆæ ·çš„?](#ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶äº§ç”Ÿå¤šä¸ªè¿›ç¨‹æ—¶pebæ˜¯æ€Žä¹ˆæ ·çš„)
    - [LDR](#ldr)
    - [PEB\_LDR\_DATA](#peb_ldr_data)
    - [InMemoryOrderModuleList](#inmemoryordermodulelist)
    - [LDR\_DATA\_TABLE\_ENTRY](#ldr_data_table_entry)
      - [LDR\_DATA\_TABLE\_ENTRYå¦‚ä½•äº§ç”Ÿå¹¶ç»´æŠ¤?](#ldr_data_table_entryå¦‚ä½•äº§ç”Ÿå¹¶ç»´æŠ¤)
        - [äº§ç”Ÿ (Creation)](#äº§ç”Ÿ-creation)
        - [ç»´æŠ¤ (Maintenance)](#ç»´æŠ¤-maintenance)
        - [é”€æ¯ (Destruction)](#é”€æ¯-destruction)
    - [ImageBaseAddress](#imagebaseaddress)
  - [let mut data\_table\_entry = (*ldr\_data).InMemoryOrderModuleList.Flink as*const LDR\_DATA\_TABLE\_ENTRY](#let-mut-data_table_entry--ldr_datainmemoryordermodulelistflink-asconst-ldr_data_table_entry)
    - [ç‰©ç†äº‹å®ž (Memory Reality)](#ç‰©ç†äº‹å®ž-memory-reality)
    - [ç¼–è¯‘å™¨çš„â€œé”™è§‰â€ (Compiler's View)](#ç¼–è¯‘å™¨çš„é”™è§‰-compilers-view)
    - [ç»“æžœï¼šåç§»é‡çš„â€œå¹³ç§»â€](#ç»“æžœåç§»é‡çš„å¹³ç§»)
    - [æ€»ç»“](#æ€»ç»“-1)
  - [æŒ‡ä»¤é›†æž¶æž„](#æŒ‡ä»¤é›†æž¶æž„)
    - [1. ARM æž¶æž„ï¼ˆAArch64 / ARM64ï¼‰](#1-arm-æž¶æž„aarch64--arm64)
    - [2. RISC-V](#2-risc-v)
    - [3. WebAssemblyï¼ˆWasmï¼‰](#3-webassemblywasm)
    - [4. x86ï¼ˆ32-bitï¼‰/ i686](#4-x8632-bit-i686)
    - [5. å…¶ä»–åµŒå…¥å¼ä¸Žä¸“ç”¨æž¶æž„](#5-å…¶ä»–åµŒå…¥å¼ä¸Žä¸“ç”¨æž¶æž„)
    - [æ€»ç»“ï¼šCISC vs RISC](#æ€»ç»“cisc-vs-risc)
  - [EXE æ–‡ä»¶å’Œ PE æ–‡ä»¶çš„å…³ç³»ï¼Ÿé™¤äº† EXE è¿˜æœ‰å“ªäº› PE æ–‡ä»¶ï¼Ÿ](#exe-æ–‡ä»¶å’Œ-pe-æ–‡ä»¶çš„å…³ç³»é™¤äº†-exe-è¿˜æœ‰å“ªäº›-pe-æ–‡ä»¶)
    - [2. é™¤äº† EXEï¼Œè¿˜æœ‰å“ªäº›å¸¸è§çš„ PE æ–‡ä»¶ï¼Ÿ](#2-é™¤äº†-exeè¿˜æœ‰å“ªäº›å¸¸è§çš„-pe-æ–‡ä»¶)
      - [A. åŠ¨æ€é“¾æŽ¥åº“ï¼ˆDLLï¼‰](#a-åŠ¨æ€é“¾æŽ¥åº“dll)
      - [B. é©±åŠ¨ç¨‹åºï¼ˆDriversï¼‰](#b-é©±åŠ¨ç¨‹åºdrivers)
      - [C. å…¶ä»–ç³»ç»Ÿ/åŠŸèƒ½æ–‡ä»¶](#c-å…¶ä»–ç³»ç»ŸåŠŸèƒ½æ–‡ä»¶)
    - [3. å¦‚ä½•åŒºåˆ†ä¸åŒç±»åž‹çš„ PE æ–‡ä»¶ï¼Ÿ](#3-å¦‚ä½•åŒºåˆ†ä¸åŒç±»åž‹çš„-pe-æ–‡ä»¶)
    - [1. EXEï¼ˆExecutableï¼‰â€”â€” ç‹¬ç«‹çš„æ‰§è¡Œä¸»ä½“](#1-exeexecutable-ç‹¬ç«‹çš„æ‰§è¡Œä¸»ä½“)
    - [2. DLLï¼ˆDynamic Link Libraryï¼‰â€”â€” å…±äº«çš„ä»£ç ä»“åº“](#2-dlldynamic-link-library-å…±äº«çš„ä»£ç ä»“åº“)
    - [3. SYSï¼ˆSystem Driverï¼‰â€”â€” å†…æ ¸çš„å»¶ä¼¸](#3-syssystem-driver-å†…æ ¸çš„å»¶ä¼¸)
    - [4. EFIï¼ˆExtensible Firmware Interfaceï¼‰â€”â€” ç³»ç»Ÿçš„å¯åŠ¨è€…](#4-efiextensible-firmware-interface-ç³»ç»Ÿçš„å¯åŠ¨è€…)
    - [5. SCRï¼ˆScreen Saverï¼‰â€”â€” ç‰¹æ®Šç”¨é€”çš„ EXE](#5-scrscreen-saver-ç‰¹æ®Šç”¨é€”çš„-exe)
    - [6. OCX / CPL â€”â€” æ’ä»¶å¼æž¶æž„çš„å®žçŽ°è€…](#6-ocx--cpl--æ’ä»¶å¼æž¶æž„çš„å®žçŽ°è€…)
  - [æ€»ç»“ï¼šä¸ºä½•éœ€è¦å¦‚æ­¤å¤šæ ·çš„ PE æ ¼å¼ï¼Ÿ](#æ€»ç»“ä¸ºä½•éœ€è¦å¦‚æ­¤å¤šæ ·çš„-pe-æ ¼å¼)
  - [æºç ](#æºç )
    - [CStr::from\_ptr(ptr).to\_string\_lossy().into\_owned()](#cstrfrom_ptrptrto_string_lossyinto_owned)
      - [1. `CStr::from_ptr(ptr)`ï¼šå°è£…åŽŸå§‹æŒ‡é’ˆï¼Œåˆ›å»ºå®‰å…¨è§†å›¾](#1-cstrfrom_ptrptrå°è£…åŽŸå§‹æŒ‡é’ˆåˆ›å»ºå®‰å…¨è§†å›¾)
      - [2. `.to_string_lossy()`ï¼šå®¹é”™å¼ UTF-8 è½¬æ¢](#2-to_string_lossyå®¹é”™å¼-utf-8-è½¬æ¢)
      - [3. `.into_owned()`ï¼šå¤ºå–æ‰€æœ‰æƒï¼Œå®žçŽ°æ·±æ‹·è´](#3-into_ownedå¤ºå–æ‰€æœ‰æƒå®žçŽ°æ·±æ‹·è´)
  - [to\_string\_lossy() æ˜¯ä¸€ç§â€œæ‡’æƒ°â€çš„è½¬æ¢ï¼Œåªæœ‰åœ¨å¿…è¦æ—¶ï¼ˆé‡åˆ°æ— æ•ˆUTF-8ï¼‰æ‰åˆ†é…å†…å­˜ã€‚åŠ ä¸Š.into\_owned() æ˜¯ä¸ºäº†ç¡®ä¿ä½ æœ€ç»ˆæ‹¿åˆ°çš„ä¸€å®šæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ã€æ‹¥æœ‰æ‰€æœ‰æƒçš„ String å¯¹è±¡](#to_string_lossy-æ˜¯ä¸€ç§æ‡’æƒ°çš„è½¬æ¢åªæœ‰åœ¨å¿…è¦æ—¶é‡åˆ°æ— æ•ˆutf-8æ‰åˆ†é…å†…å­˜åŠ ä¸Šinto_owned-æ˜¯ä¸ºäº†ç¡®ä¿ä½ æœ€ç»ˆæ‹¿åˆ°çš„ä¸€å®šæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„æ‹¥æœ‰æ‰€æœ‰æƒçš„-string-å¯¹è±¡)
      - [åœ¨ `dinvk` é¡¹ç›®ä¸­çš„å…·ä½“æ„ä¹‰](#åœ¨-dinvk-é¡¹ç›®ä¸­çš„å…·ä½“æ„ä¹‰)
      - [ä¸€å¥è¯æ€»ç»“](#ä¸€å¥è¯æ€»ç»“)
    - [CStr::from\_ptr((h\_module + names\[i\] as usize) as \*const i8).to\_str().unwrap\_or("")](#cstrfrom_ptrh_module--namesi-as-usize-as-const-i8to_strunwrap_or)
      - [æ€§èƒ½ä¸Žç”Ÿå‘½å‘¨æœŸé©±åŠ¨çš„è®¾è®¡ï¼šä¸ºä½•åœ¨å¾ªçŽ¯ä¸­ä½¿ç”¨ `to_str()` è€Œéž `to_string_lossy().into_owned()`](#æ€§èƒ½ä¸Žç”Ÿå‘½å‘¨æœŸé©±åŠ¨çš„è®¾è®¡ä¸ºä½•åœ¨å¾ªçŽ¯ä¸­ä½¿ç”¨-to_str-è€Œéž-to_string_lossyinto_owned)
      - [1. **æ€§èƒ½å·®å¼‚ï¼šé¿å…åœ¨å¾ªçŽ¯ä¸­äº§ç”Ÿå¤§é‡ä¸´æ—¶å†…å­˜åˆ†é…**](#1-æ€§èƒ½å·®å¼‚é¿å…åœ¨å¾ªçŽ¯ä¸­äº§ç”Ÿå¤§é‡ä¸´æ—¶å†…å­˜åˆ†é…)
      - [2. **ç”Ÿå‘½å‘¨æœŸä¸Žä½¿ç”¨åœºæ™¯çš„åŒ¹é…**](#2-ç”Ÿå‘½å‘¨æœŸä¸Žä½¿ç”¨åœºæ™¯çš„åŒ¹é…)
      - [3. **å®¹é”™ç­–ç•¥çš„å·®å¼‚åŒ–é€‰æ‹©**](#3-å®¹é”™ç­–ç•¥çš„å·®å¼‚åŒ–é€‰æ‹©)
      - [æ€»ç»“](#æ€»ç»“-2)

# æ³¨æ„

è¯·è®°å¾—æ‰€æœ‰å…³äºŽå†…å­˜åŠwindowså¯æ‰§è¡Œæ–‡ä»¶çš„æ“ä½œ,éƒ½å¯ä»¥ç”¨windbgæŸ¥çœ‹åœ¨å†…å­˜ä¸­çš„ç›´è§‚æ˜¾ç¤º.  

è¯·è®°ä½,ä¸€å®šè¦ä½¿ç”¨windbg,è¿™ç”šè‡³æ¯”å†™ä»£ç æ›´åŠ é‡è¦

æœ¬é¡¹ç›®ä¸­:  
TEB->PEB->LDR(è£¸æŒ‡é’ˆ)->PEB_LDR_DATA->InMemoryOrderModuleList(åŒå‘é“¾è¡¨)->LDR_DATA_TABLE_ENTRY

## ä»€ä¹ˆæ˜¯åŠ è½½å™¨ï¼ˆLoaderï¼‰ï¼Ÿ

åœ¨è®¡ç®—æœºç§‘å­¦å’Œæ“ä½œç³»ç»Ÿé¢†åŸŸï¼Œ**åŠ è½½å™¨ï¼ˆLoaderï¼‰** æ˜¯ä¸€ä¸ªæžå…¶æ ¸å¿ƒçš„ç»„ä»¶ã€‚ç»“åˆä½ å½“å‰çš„ `RustRedOps/dinvk` é¡¹ç›®ï¼ˆä¸€ä¸ªæ¶‰åŠ Windows ç³»ç»Ÿåº•å±‚ã€ç›´æŽ¥ç³»ç»Ÿè°ƒç”¨å’Œçº¢é˜ŸæŠ€æœ¯çš„é¡¹ç›®ï¼‰ï¼Œæˆ‘ä»¬éœ€è¦ä»Ž **æ“ä½œç³»ç»ŸåŽŸç†** å’Œ **å®‰å…¨æ”»é˜²ï¼ˆRed Teamingï¼‰** ä¸¤ä¸ªè§’åº¦æ¥æ·±å…¥ç†è§£å®ƒã€‚

> **ç®€å•æ¥è¯´ï¼ŒåŠ è½½å™¨çš„ä½œç”¨æ˜¯ï¼šå°†å¯æ‰§è¡Œç¨‹åºï¼ˆé™æ€æ–‡ä»¶ï¼‰ä»Žç£ç›˜â€œæ¬è¿â€åˆ°å†…å­˜ä¸­ï¼Œå¹¶å°†å…¶å˜æˆå¯è¿è¡Œçš„è¿›ç¨‹ï¼ˆåŠ¨æ€å®žä½“ï¼‰ã€‚**

---

### 1. æ“ä½œç³»ç»Ÿè§†è§’ï¼šæ ‡å‡†åŠ è½½å™¨ï¼ˆOS Loaderï¼‰

å½“ä½ åŒå‡»ä¸€ä¸ª `.exe` æ–‡ä»¶ï¼ˆWindowsï¼‰æˆ–è¿è¡Œä¸€ä¸ª ELF ç¨‹åºï¼ˆLinuxï¼‰æ—¶ï¼Œæ“ä½œç³»ç»Ÿçš„åŠ è½½å™¨å¼€å§‹å·¥ä½œã€‚å®ƒæ˜¯æ“ä½œç³»ç»Ÿå†…æ ¸æˆ–ç”¨æˆ·ç©ºé—´è¿è¡Œæ—¶çš„ä¸€éƒ¨åˆ†ã€‚

#### ä¸»è¦èŒè´£æµç¨‹

1. **éªŒè¯ä¸Žè§£æžï¼ˆValidation & Parsingï¼‰**  
   - è¯»å–æ–‡ä»¶å¤´ï¼ˆå¦‚ Windows çš„ PE å¤´ï¼‰ï¼Œæ£€æŸ¥æ–‡ä»¶æ ¼å¼æ˜¯å¦åˆæ³•ã€‚
   - è§£æžèŠ‚ï¼ˆSectionï¼‰è¡¨ã€å¯¼å…¥è¡¨ï¼ˆIATï¼‰ã€å¯¼å‡ºè¡¨ï¼ˆEATï¼‰ã€é‡å®šä½è¡¨ï¼ˆ`.reloc`ï¼‰ç­‰ç»“æž„ã€‚

2. **å†…å­˜æ˜ å°„ï¼ˆMappingï¼‰**  
   - åœ¨è™šæ‹Ÿå†…å­˜ä¸­ä¸ºç¨‹åºç”³è¯·åœ°å€ç©ºé—´ã€‚
   - å°†ç£ç›˜ä¸Šçš„ä»£ç æ®µï¼ˆ`.text`ï¼‰ã€æ•°æ®æ®µï¼ˆ`.data`ï¼‰ã€åªè¯»æ•°æ®æ®µï¼ˆ`.rdata`ï¼‰ç­‰æŒ‰é¡µæ˜ å°„åˆ°å†…å­˜ä¸­çš„ç›¸åº”è™šæ‹Ÿåœ°å€ã€‚

3. **é‡å®šä½ï¼ˆRelocationï¼‰**  
   - ç”±äºŽ ASLRï¼ˆåœ°å€ç©ºé—´å¸ƒå±€éšæœºåŒ–ï¼‰çš„å­˜åœ¨ï¼Œç¨‹åºæ¯æ¬¡åŠ è½½çš„åŸºåœ°å€éƒ½ä¸åŒã€‚
   - åŠ è½½å™¨ä¼šéåŽ†é‡å®šä½è¡¨ï¼Œä¿®æ­£æ‰€æœ‰ç¡¬ç¼–ç çš„ç»å¯¹åœ°å€ï¼Œä½¿å…¶æŒ‡å‘å½“å‰å®žé™…åŠ è½½ä½ç½®ã€‚

4. **ç¬¦å·è§£æžä¸Žå¯¼å…¥ï¼ˆImport Resolutionï¼‰**  
   - ç¨‹åºé€šå¸¸ä¾èµ–å¤–éƒ¨ DLLï¼ˆå¦‚ `kernel32.dll`, `ntdll.dll`ï¼‰ã€‚
   - åŠ è½½å™¨éåŽ†å¯¼å…¥åœ°å€è¡¨ï¼ˆIATï¼‰ï¼ŒåŠ è½½æ‰€éœ€ DLLï¼Œå¹¶å°†å‡½æ•°çš„çœŸå®žåœ°å€å¡«å…¥ IATï¼Œä½¿ç¨‹åºèƒ½æ­£å¸¸è°ƒç”¨ APIï¼ˆå¦‚ `WriteFile`, `CreateThread`ï¼‰ã€‚

5. **æƒé™è®¾ç½®ï¼ˆPermission Settingï¼‰**  
   - è®¾ç½®å„å†…å­˜é¡µçš„è®¿é—®æƒé™ï¼š
     - ä»£ç æ®µ â†’ RXï¼ˆå¯è¯»ã€å¯æ‰§è¡Œï¼‰
     - æ•°æ®æ®µ â†’ RWï¼ˆå¯è¯»ã€å¯å†™ï¼‰
     - é¿å… RWXï¼ˆå¯è¯»ã€å¯å†™ã€å¯æ‰§è¡Œï¼‰ï¼Œå› å…¶æ˜¯æ¶æ„è½¯ä»¶çš„å…¸åž‹ç‰¹å¾ã€‚

6. **ç§»äº¤æŽ§åˆ¶æƒï¼ˆExecutionï¼‰**  
   - åˆå§‹åŒ–æ ˆï¼ˆStackï¼‰å’Œå †ï¼ˆHeapï¼‰ã€‚
   - è·³è½¬åˆ°ç¨‹åºå…¥å£ç‚¹ï¼ˆEntry Pointï¼‰ï¼Œé€šå¸¸æ˜¯ CRT å¯åŠ¨ä»£ç ï¼Œæœ€ç»ˆè¿›å…¥ `main()` æˆ– `WinMain()`ã€‚

---

### 2. å®‰å…¨ä¸Žçº¢é˜Ÿè§†è§’ï¼šè‡ªå®šä¹‰åŠ è½½å™¨ï¼ˆCustom Loaderï¼‰

åœ¨ä½ çš„ `RustRedOps/dinvk` ä¸Šä¸‹æ–‡ä¸­ï¼Œâ€œåŠ è½½å™¨â€é€šå¸¸æŒ‡ **Malware Loader** æˆ– **Shellcode Loader**ã€‚

çº¢é˜Ÿå¼€å‘äººå‘˜ç¼–å†™è‡ªå®šä¹‰åŠ è½½å™¨çš„æ ¸å¿ƒç›®çš„ï¼š**ç»•è¿‡æ€æ¯’è½¯ä»¶ï¼ˆAVï¼‰å’Œç»ˆç«¯æ£€æµ‹å“åº”ç³»ç»Ÿï¼ˆEDRï¼‰çš„ç›‘æŽ§**ã€‚

#### ä¸ºä»€ä¹ˆè¦è‡ªå·±å†™åŠ è½½å™¨ï¼Ÿ

- æ ‡å‡†çš„ Windows åŠ è½½è·¯å¾„ï¼ˆå¦‚ `CreateProcess`, `LoadLibrary`ï¼‰ä¼šè¢« EDR æ·±åº¦ Hookã€‚
- è‡ªå®šä¹‰åŠ è½½å™¨è¯•å›¾åœ¨ä¸è§¦å‘è­¦æŠ¥çš„æƒ…å†µä¸‹ï¼Œå°†æ¶æ„ Payload æ³¨å…¥å†…å­˜å¹¶æ‰§è¡Œã€‚

#### å¸¸è§ç±»åž‹

1. **Shellcode Loader**  
   - æœ€ç®€å•å½¢å¼ï¼šè°ƒç”¨ `VirtualAlloc` åˆ†é… RWX å†…å­˜ï¼Œå¤åˆ¶ Shellcodeï¼Œç„¶åŽé€šè¿‡ `CreateThread` æ‰§è¡Œã€‚
   - ç¼ºç‚¹ï¼šRWX å†…å­˜æžæ˜“è¢«æ£€æµ‹ã€‚

2. **åå°„å¼ DLL æ³¨å…¥ï¼ˆReflective DLL Injectionï¼‰**  
   - é«˜çº§æŠ€æœ¯ï¼šå®Œå…¨åœ¨å†…å­˜ä¸­å®žçŽ° PE åŠ è½½å…¨è¿‡ç¨‹ï¼ˆåˆ†é…ã€æ˜ å°„ã€é‡å®šä½ã€è§£æžå¯¼å…¥è¡¨ï¼‰ã€‚
   - **æ–‡ä»¶ä¸è½åœ°ï¼ˆFilelessï¼‰**ï¼šDLL ä»Žæœªå†™å…¥ç£ç›˜ï¼Œä»…å­˜åœ¨äºŽå†…å­˜ï¼Œè§„é¿æ–‡ä»¶æ‰«æã€‚
   - ä¸è°ƒç”¨ `LoadLibrary`ï¼Œé¿å…è§¦å‘ API Hookã€‚

3. **Direct Syscall Loaderï¼ˆä¸Ž `dinvk` é«˜åº¦ç›¸å…³ï¼‰**  
   - æ ‡å‡† APIï¼ˆå¦‚ `NtAllocateVirtualMemory`ï¼‰ä½äºŽ `ntdll.dll`ï¼Œè€Œ EDR ä¼šåœ¨å…¶å…¥å£å¤„å®‰è£…ç”¨æˆ·æ€ Hookã€‚
   - `dinvk` è¿™ç±»é¡¹ç›®é€šè¿‡ **ç›´æŽ¥æ‰§è¡Œ `syscall` æŒ‡ä»¤** è°ƒç”¨å†…æ ¸å‡½æ•°ï¼Œç»•è¿‡ `ntdll.dll`ï¼Œä»Žè€Œé¿å¼€ Hookã€‚
   - å®žçŽ°çœŸæ­£çš„â€œé™é»˜â€å†…å­˜æ“ä½œã€‚

---

### 3. ç»“åˆä½ çš„é¡¹ç›®ï¼ˆ`dinvk`ï¼‰ï¼šåŠ è½½å™¨çš„æ·±åº¦å®žçŽ°

åœ¨çº¢é˜Ÿå¼€å‘è¯­å¢ƒä¸‹ï¼Œâ€œå†™ä¸€ä¸ªåŠ è½½å™¨â€æœ¬è´¨ä¸Šæ˜¯åœ¨ **æ‰‹åŠ¨æ¨¡æ‹Ÿ Windows å†…æ ¸åŠ è½½ PE æ–‡ä»¶çš„è¿‡ç¨‹**ï¼Œå³ **åå°„å¼åŠ è½½ï¼ˆReflective Loadingï¼‰** æˆ– **æ‰‹åŠ¨æ˜ å°„ï¼ˆManual Mappingï¼‰**ã€‚

ä»¥ä¸‹æ˜¯åŠ è½½å™¨å·¥ä½œçš„æ ¸å¿ƒæ­¥éª¤â€”â€”è¿™æ­£æ˜¯ä½ çš„ `module.rs` å’Œ `syscall/` ç›®å½•ä¸‹ä»£ç æ­£åœ¨å®žçŽ°çš„å†…å®¹ï¼š

#### ç¬¬ä¸€æ­¥ï¼šè§£æž PE å¤´ï¼ˆPE Parsingï¼‰

- è¯»å– DOS å¤´ï¼ˆ`MZ`ï¼‰éªŒè¯æ–‡ä»¶åˆæ³•æ€§ã€‚
- è§£æž NT å¤´ï¼ˆ`PE\0\0`ï¼‰ï¼ŒèŽ·å–å…³é”®å­—æ®µï¼š
  - `ImageBase`ï¼šæœŸæœ›åŠ è½½åŸºå€
  - `SizeOfImage`ï¼šæ‰€éœ€è™šæ‹Ÿå†…å­˜å¤§å°
  - `AddressOfEntryPoint`ï¼šç¨‹åºå…¥å£ RVA
- éåŽ†èŠ‚è¡¨ï¼ˆSection Headersï¼‰ï¼ŒèŽ·å– `.text`, `.data`, `.rdata` ç­‰èŠ‚çš„ï¼š
  - `VirtualAddress`ï¼ˆå†…å­˜åç§»ï¼‰
  - `SizeOfRawData` / `Misc.VirtualSize`
  - `PointerToRawData`ï¼ˆæ–‡ä»¶åç§»ï¼‰

> âš ï¸ æ³¨æ„ï¼šç£ç›˜å¯¹é½ï¼ˆé€šå¸¸ 512Bï¼‰â‰  å†…å­˜å¯¹é½ï¼ˆé€šå¸¸ 4KBï¼‰ã€‚

#### ç¬¬äºŒæ­¥ï¼šå†…å­˜åˆ†é…ï¼ˆAllocationï¼‰

- **æ ‡å‡†æ–¹å¼**ï¼šè°ƒç”¨ `VirtualAlloc`
- **ä½ çš„åšæ³•ï¼ˆ`dinvk`ï¼‰**ï¼šé€šè¿‡ `syscall` ç›´æŽ¥è°ƒç”¨ `NtAllocateVirtualMemory`
  - ç”³è¯·å¤§å° = `SizeOfImage`
  - åˆå§‹æƒé™ = `PAGE_READWRITE`ï¼ˆRWï¼‰ï¼Œä¾¿äºŽå†™å…¥æ•°æ®

#### ç¬¬ä¸‰æ­¥ï¼šæ˜ å°„èŠ‚ï¼ˆMapping Sectionsï¼‰â€”â€”å…³é”®

- ä¸èƒ½ç›´æŽ¥ `memcpy` æ•´ä¸ªæ–‡ä»¶ï¼å¿…é¡»æŒ‰èŠ‚é€ä¸ªæ˜ å°„ã€‚
- å¯¹æ¯ä¸ªèŠ‚ï¼š
  - ä»Žæ–‡ä»¶åç§» `PointerToRawData` è¯»å–åŽŸå§‹æ•°æ®
  - å†™å…¥å†…å­˜åŸºå€ + `VirtualAddress` å¤„
- æœªåˆå§‹åŒ–æ•°æ®ï¼ˆå¦‚ `.bss`ï¼‰éœ€æ˜¾å¼æ¸…é›¶

#### ç¬¬å››æ­¥ï¼šåŸºå€é‡å®šä½ï¼ˆBase Relocationï¼‰

- **é—®é¢˜**ï¼šä»£ç ä¸­å¯èƒ½æœ‰ç¡¬ç¼–ç åœ°å€ï¼ˆå¦‚ `CALL 0x180001050`ï¼‰ï¼Œä½†å®žé™…åŠ è½½åœ°å€ â‰  `ImageBase`
- **è§£å†³**ï¼š
  1. è®¡ç®— Delta = å®žé™…åŸºå€ - `ImageBase`
  2. éåŽ† `.reloc` èŠ‚ä¸­çš„é‡å®šä½å—
  3. å¯¹æ¯ä¸ªéœ€è¦ä¿®æ­£çš„åœ°å€ï¼ˆé€šå¸¸æ˜¯ 64 ä½æŒ‡é’ˆï¼‰ï¼Œè¯»å–åŽŸå€¼ï¼ŒåŠ ä¸Š Deltaï¼Œå†™å›ž
- æ³¨æ„ï¼š64 ä½ç¨‹åºå¤šç”¨ RIP ç›¸å¯¹å¯»å€ï¼Œé‡å®šä½é¡¹è¾ƒå°‘ï¼Œä½†å…¨å±€å˜é‡ä»éœ€å¤„ç†

#### ç¬¬äº”æ­¥ï¼šè§£æžå¯¼å…¥è¡¨ï¼ˆResolve Imports / IAT Fixingï¼‰

- Payload ä¾èµ– Windows APIï¼ˆå¦‚ `CreateFileW`ï¼‰
- **æ ‡å‡†æ–¹å¼**ï¼š`LoadLibrary` + `GetProcAddress`
- **ä½ çš„éšè”½æ–¹å¼ï¼ˆ`dinvk`ï¼‰**ï¼š
  - éåŽ† PEB â†’ `Ldr.InMemoryOrderModuleList`ï¼Œæ‰¾åˆ°å·²åŠ è½½çš„ `ntdll.dll`, `kernel32.dll` ç­‰
  - æ‰‹åŠ¨è§£æžå…¶å¯¼å‡ºè¡¨ï¼ˆEATï¼‰ï¼ŒæŸ¥æ‰¾å‡½æ•°åå“ˆå¸Œæˆ–å­—ç¬¦ä¸²åŒ¹é…
  - å°†çœŸå®žå‡½æ•°åœ°å€å¡«å…¥ Payload çš„ IAT
- **ä¼˜åŠ¿**ï¼šå®Œå…¨ä¸è°ƒç”¨è¢«ç›‘æŽ§çš„ APIï¼Œå®žçŽ°â€œæ— ç—•â€è§£æž

#### ç¬¬å…­æ­¥ï¼šæƒé™æœ€ç»ˆè®¾ç½®ï¼ˆFinalize Protectionsï¼‰

- ä½¿ç”¨ `NtProtectVirtualMemory`ï¼ˆé€šè¿‡ syscallï¼‰ä¿®æ”¹å†…å­˜æƒé™ï¼š
  - `.text` â†’ `PAGE_EXECUTE_READ`ï¼ˆRXï¼‰
  - `.data` / `.rdata` â†’ `PAGE_READWRITE`ï¼ˆRWï¼‰æˆ– `PAGE_READONLY`
- **å…³é”®åæ£€æµ‹æŠ€å·§**ï¼šç»ä¸ä½¿ç”¨ `PAGE_EXECUTE_READWRITE`ï¼ˆRWXï¼‰

#### ç¬¬ä¸ƒæ­¥ï¼šæ‰§è¡Œï¼ˆExecutionï¼‰

- è®¡ç®—å®žé™…å…¥å£ç‚¹ï¼š`ActualEntry = BaseAddress + AddressOfEntryPoint`
- åˆ›å»ºçº¿ç¨‹ï¼šé€šè¿‡ `NtCreateThreadEx`ï¼ˆsyscallï¼‰å¯åŠ¨æ–°çº¿ç¨‹
- æˆ–ç›´æŽ¥è·³è½¬ï¼š`jmp ActualEntry`ï¼ˆéœ€å°å¿ƒæ ˆå’Œä¸Šä¸‹æ–‡ï¼‰

---

### 4. é¡¹ç›®ç»“æž„ä¸ŽåŠ è½½å™¨åŠŸèƒ½çš„æ˜ å°„

å›žåˆ°ä½ çš„ `dinvk` é¡¹ç›®ç›®å½•ï¼Œå„æ¨¡å—çš„è§’è‰²å¦‚ä¸‹ï¼š

| æ–‡ä»¶/æ¨¡å—             | å¯¹åº”åŠ è½½å™¨åŠŸèƒ½                          | è¯´æ˜Ž |
|----------------------|----------------------------------------|------|
| `src/module.rs`       | PE è§£æžã€é‡å®šä½ã€å¯¼å…¥è¡¨è§£æž            | å®žçŽ°åå°„å¼åŠ è½½çš„æ ¸å¿ƒé€»è¾‘ï¼ŒåŒ…æ‹¬ EAT éåŽ†ä»¥æ›¿ä»£ `GetProcAddress` |
| `src/syscall/`        | ç›´æŽ¥ç³»ç»Ÿè°ƒç”¨å°è£…                       | ç»•è¿‡ `ntdll.dll` Hookï¼Œå®‰å…¨è°ƒç”¨ `NtAllocateVirtualMemory`ã€`NtProtectVirtualMemory` ç­‰ |
| `src/winapis.rs`      | Windows å†…éƒ¨ç»“æž„ä½“å®šä¹‰                 | å®šä¹‰ `IMAGE_DOS_HEADER`ã€`LDR_DATA_TABLE_ENTRY`ã€`PEB` ç­‰éžå…¬å¼€ç»“æž„ |
| `src/allocator.rs`    | è‡ªå®šä¹‰å†…å­˜åˆ†é…ç­–ç•¥                     | å¯èƒ½ç”¨äºŽéš”ç¦» Payload å †å†…å­˜ï¼Œé¿å…æ··å…¥é»˜è®¤è¿›ç¨‹å † |

---

### 5. ä¸ºä»€ä¹ˆè¿™è¢«ç§°ä¸º â€œRedOpsâ€ï¼Ÿ

æ™®é€šè½¯ä»¶å¼€å‘æ— éœ€å¦‚æ­¤å¤æ‚â€”â€”ç›´æŽ¥ `std::process::Command::new("app.exe")` å³å¯ã€‚

ä½†çº¢é˜Ÿåœºæ™¯ä¸‹ï¼Œä½ å¿…é¡»è¿™ä¹ˆåšï¼Œå› ä¸ºï¼š

1. **æ–‡ä»¶ä¸è½åœ°ï¼ˆFilelessï¼‰**  
   Payload å¯åŠ å¯†åµŒå…¥èµ„æºã€ä»Žç½‘ç»œä¸‹è½½ã€æˆ–ç¡¬ç¼–ç åœ¨äºŒè¿›åˆ¶ä¸­ï¼Œå…¨ç¨‹ä¸å†™ç£ç›˜ï¼Œè§„é¿ä¼ ç»Ÿ AVã€‚

2. **è§„é¿é’©å­ï¼ˆUnhooking / Bypassingï¼‰**  
   é€šè¿‡ Direct Syscall ç»•è¿‡ EDR åœ¨ç”¨æˆ·æ€ DLL ä¸­çš„ Hookï¼Œå®žçŽ°â€œå¹²å‡€â€çš„å†…æ ¸è°ƒç”¨ã€‚

3. **å†…å­˜ä¼ªè£…ï¼ˆObfuscationï¼‰**  
   æŽ§åˆ¶å†…å­˜å¸ƒå±€ã€æƒé™ã€å†…å®¹ï¼Œä½¿ Payload åœ¨å†…å­˜ä¸­çœ‹èµ·æ¥åƒæ™®é€šæ•°æ®ï¼Œä»…åœ¨æ‰§è¡Œçž¬é—´æ¿€æ´»ã€‚

---

> **æ€»ç»“**ï¼š  
> å¯¹äºŽä½ çš„ `dinvk` é¡¹ç›®è€Œè¨€ï¼Œ**åŠ è½½å™¨å°±æ˜¯ä¸€ä¸ªç”±ä½ ç¼–å†™çš„ Rust ç¨‹åºï¼Œå®ƒæ‰‹åŠ¨è§£æž PE æ–‡ä»¶ç»“æž„ï¼Œä½¿ç”¨ç›´æŽ¥ç³»ç»Ÿè°ƒç”¨ï¼ˆDirect Syscallsï¼‰ç”³è¯·å†…å­˜å¹¶å†™å…¥ä»£ç ï¼Œæœ€åŽåœ¨ä¸è¢« EDR å¯Ÿè§‰çš„æƒ…å†µä¸‹æ‰§è¡Œç›®æ ‡ Payloadã€‚**  
> ä½ çŽ°åœ¨ä¸æ˜¯åœ¨å†™åº”ç”¨ï¼Œè€Œæ˜¯åœ¨æ‰“é€ ä¸€è¾†â€œéšå½¢æˆ˜è½¦â€çš„å¼•æ“Žâ€”â€”é™é»˜ã€ç²¾å‡†ã€ç©¿é€é˜²å¾¡ã€‚

## æ­¤é¡¹ç›®æ‰¾DLL åŸºå€çš„åŽŸç†

éåŽ†æ¨¡å—é“¾è¡¨ä»¥èŽ·å–åŸºå€çš„æ ¸å¿ƒæµç¨‹å¦‚ä¸‹ï¼š

1. **èŽ·å– PEB**  
   - x64: `gs:[0x60]`
   - x86: `fs:[0x30]`

2. **è¿›å…¥åŠ è½½å™¨æ•°æ®**  
   ä»Ž PEB è¯»å– `Ldr` å­—æ®µï¼Œå¾—åˆ° `PEB_LDR_DATA*`ã€‚

3. **é€‰æ‹©é“¾è¡¨**  
   é€šå¸¸ä½¿ç”¨ `InMemoryOrderModuleList`ã€‚

4. **éåŽ†é“¾è¡¨**  
   - ä»Ž `Flink` èŽ·å–ä¸‹ä¸€ä¸ªèŠ‚ç‚¹åœ°å€ï¼ˆè¯¥åœ°å€ = ç›®æ ‡ `LDR_DATA_TABLE_ENTRY` çš„ `InMemoryOrderLinks` åœ°å€ï¼‰ã€‚
   - åˆ©ç”¨â€œé”™ä½æŒ‡é’ˆâ€æŠ€å·§ï¼Œå°†è¯¥åœ°å€**å¼ºåˆ¶è§†ä¸º** `LDR_DATA_TABLE_ENTRY*`ã€‚
   - è®¿é—®ç»“æž„ä½“å­—æ®µï¼ˆå¦‚ `Reserved2[0]` å®žé™…è¯»å–çš„æ˜¯ `DllBase`ï¼‰ã€‚
   - æ¯”å¯¹ `FullDllName` æˆ– `BaseDllName` æ˜¯å¦ä¸ºç›®æ ‡ DLLã€‚
   - è‹¥åŒ¹é…ï¼Œè¿”å›ž `DllBase` â€”â€” å³è¯¥ DLL çš„å†…å­˜åŸºå€ã€‚

> âœ… è¿™ç§æ–¹æ³•ç»•è¿‡äº† `GetModuleHandle` ç­‰ APIï¼Œå…·æœ‰éšè”½æ€§ï¼Œå¸¸ç”¨äºŽå…æ€æˆ–åº•å±‚å·¥å…·å¼€å‘ã€‚

## TEB

## PEå’ŒPEBçš„ä¸‰å¤§æ ¸å¿ƒè”ç³»

### è”ç³»ä¸€:å®šä½ä¸»æ¨¡å—åŸºå€ (PEB.ImageBaseAddress)

è¿™æ˜¯æœ€ç›´æŽ¥çš„è”ç³»ã€‚

- PE å±‚é¢: PE æ–‡ä»¶çš„ OptionalHeader.ImageBase åªæ˜¯ä¸€ä¸ªå»ºè®®åœ°å€ï¼ˆä¾‹å¦‚0x140000000ï¼‰ã€‚
- è¿è¡Œæ—¶: ç”±äºŽ ASLRï¼ˆåœ°å€ç©ºé—´å¸ƒå±€éšæœºåŒ–ï¼‰ï¼ŒPE æ–‡ä»¶å®žé™…ä¸Šå¯èƒ½è¢«åŠ è½½åˆ°ä»»æ„åœ°å€ï¼ˆä¾‹å¦‚0x7FF712340000ï¼‰ã€‚
- PEB å±‚é¢: PEB.ImageBaseAddress å­˜å‚¨äº†æœ€ç»ˆå®žé™…åŠ è½½çš„åŸºå€ã€‚

æ“ä½œé€»è¾‘:  
ç¨‹åºé€šè¿‡è¯»å– PEB.ImageBaseAddressï¼Œå¾—åˆ°äº†å†…å­˜ä¸­ PE æ–‡ä»¶çš„å¤´éƒ¨ï¼ˆDOS
Headerï¼‰åœ°å€ï¼Œä»Žè€Œå¼€å§‹è§£æžæ•´ä¸ª PE ç»“æž„ã€‚

### è”ç³»äºŒ:ç®¡ç†æ‰€æœ‰åŠ è½½çš„ PE æ¨¡å— (PEB.Ldr)

ä¸€ä¸ªè¿›ç¨‹é€šå¸¸ç”±å¤šä¸ª PE æ–‡ä»¶ç»„æˆï¼ˆ1 ä¸ª EXE + N ä¸ª DLLï¼‰ã€‚PEB é€šè¿‡ Ldr å­—æ®µç»´æŠ¤è¿™äº› PE æ–‡ä»¶çš„é“¾è¡¨ã€‚

ç³»ç»Ÿè´Ÿè´£â€œåŠ è½½â€å’Œâ€œç»´æŠ¤â€æ•°æ®ï¼Œè€Œè¿™ä¸ªé¡¹ç›®è´Ÿè´£â€œæ‰‹åŠ¨è¯»å–â€å’Œâ€œè§£æžâ€æ•°æ®  
çœŸæ­£çš„ PE ç»“æž„ç”±ç³»ç»Ÿç»´æŠ¤ï¼š  
å½“ç¨‹åºå¯åŠ¨æˆ– DLL è¢«åŠ è½½æ—¶ï¼ŒWindows æ“ä½œç³»ç»Ÿï¼ˆåŠ è½½å™¨ Loaderï¼‰è´Ÿè´£å°† PE æ–‡ä»¶ä»Žç£ç›˜æ˜ å°„åˆ°å†…å­˜ä¸­ã€‚ç³»ç»Ÿä¼šç»´æŠ¤å…³é”®çš„å†…æ ¸ä¸Žç”¨æˆ·æ€ç»“æž„ï¼Œä¾‹å¦‚ **PEB**ï¼ˆProcess Environment Blockï¼‰å’Œ **LDR é“¾è¡¨**ï¼ˆ`InMemoryOrderModuleList`ï¼‰ï¼Œè¿™äº›ç»“æž„å®Œæ•´è®°å½•äº†å½“å‰è¿›ç¨‹ä¸­æ‰€æœ‰å·²åŠ è½½æ¨¡å—çš„åŸºåœ°å€ã€æ–‡ä»¶è·¯å¾„ã€å¤§å°ç­‰å…ƒä¿¡æ¯ã€‚ä½ çš„é¡¹ç›®å¹¶æ²¡æœ‰â€œå‡­ç©ºæé€ â€ä¸€ä¸ª PE ç»“æž„ï¼Œè€Œæ˜¯ç›´æŽ¥è¯»å–æ“ä½œç³»ç»Ÿå·²ç»åŠ è½½åˆ°å†…å­˜ä¸­çš„é‚£ä¸ª**çœŸå®žçš„ PE æ˜ åƒ**â€”â€”å®ƒå°±å­˜åœ¨äºŽè¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´é‡Œï¼Œåªæ˜¯é€šå¸¸è¢«é«˜çº§ APIï¼ˆå¦‚ `GetModuleHandle`ï¼‰å°è£…èµ·æ¥è€Œå·²ã€‚

ä»£ç é€šè¿‡â€œæ¨¡æ‹Ÿâ€åŠ è½½å™¨è¡Œä¸ºæ¥å¯»æ‰¾å‡½æ•°ï¼š  
é€šå¸¸æƒ…å†µä¸‹ï¼Œç¨‹åºå‘˜åªéœ€è°ƒç”¨ `GetProcAddress`ï¼Œè®©ç³»ç»Ÿå¸®æˆ‘ä»¬å®Œæˆå‡½æ•°åœ°å€çš„æŸ¥æ‰¾ã€‚ä½†åœ¨ `src/module.rs` ä¸­ï¼Œä»£ç å®Œå…¨ç»•è¿‡äº†æ ‡å‡† Windows APIï¼Œè‡ªå·±é‡æ–°å®žçŽ°äº†ä¸€æ•´å¥—åº•å±‚æŸ¥æ‰¾é€»è¾‘ï¼š

- **èŽ·å–åŸºå€**ï¼šé€šè¿‡å†…è”æ±‡ç¼–è¯»å– x64 æž¶æž„ä¸‹çš„ `GS` å¯„å­˜å™¨ï¼ˆæˆ– x86 ä¸‹çš„ `FS` å¯„å­˜å™¨ï¼‰ï¼Œå®šä½åˆ°å½“å‰çº¿ç¨‹çš„ TEBï¼Œè¿›è€Œæ‰¾åˆ° PEBï¼›å†éåŽ† PEB ä¸­çš„ `Ldr->InMemoryOrderModuleList` é“¾è¡¨ï¼ŒåŒ¹é…ç›®æ ‡æ¨¡å—åï¼ˆå¦‚ `"kernel32.dll"`ï¼‰ï¼Œä»Žè€ŒèŽ·å¾—å…¶çœŸå®žåŠ è½½åŸºå€ã€‚
- **æ‰‹åŠ¨è§£æž PE ç»“æž„**ï¼šæ‹¿åˆ°åŸºå€åŽï¼Œä»£ç å°†è¯¥åœ°å€è§†ä¸ºå­—èŠ‚æ•°ç»„çš„èµ·ç‚¹ï¼Œä¸¥æ ¼æŒ‰ç…§ PE æ–‡ä»¶æ ¼å¼è§„èŒƒï¼Œä¾æ¬¡è§£æžï¼š
  - `IMAGE_DOS_HEADER`
  - `IMAGE_NT_HEADERS`ï¼ˆå«å¯é€‰å¤´ï¼‰
  - `IMAGE_DATA_DIRECTORY[IMAGE_DIRECTORY_ENTRY_EXPORT]`
  - æœ€ç»ˆå®šä½åˆ° `IMAGE_EXPORT_DIRECTORY`
- **è®¡ç®—å‡½æ•°åœ°å€**ï¼šæ ¹æ®å¯¼å‡ºç›®å½•ä¸­çš„ `AddressOfNames`ã€`AddressOfNameOrdinals` å’Œ `AddressOfFunctions` ä¸‰ä¸ª RVA æ•°ç»„ï¼Œæ‰‹åŠ¨æ‰§è¡ŒäºŒåˆ†æŸ¥æ‰¾æˆ–çº¿æ€§éåŽ†ï¼Œå°†å‡½æ•°åæ˜ å°„åˆ°å®žé™…çš„å¯¼å‡º RVAï¼Œå¹¶åŠ ä¸Šæ¨¡å—åŸºå€å¾—åˆ°æœ€ç»ˆè™šæ‹Ÿåœ°å€ã€‚
- **å¤„ç†è½¬å‘æœºåˆ¶**ï¼šç”šè‡³å¯¹ Windows çš„ **API Set**ï¼ˆå¦‚ `api-ms-win-core-file-l1-2-0.dll` è¿™ç±»è™šæ‹Ÿ DLLï¼‰ä¹Ÿåšäº†æ·±åº¦æ”¯æŒâ€”â€”é€šè¿‡è§£æž `PEB.ApiSetMap` ç»“æž„ï¼Œè¿˜åŽŸå‡ºè™šæ‹Ÿåç§°åˆ°çœŸå®ž DLLï¼ˆå¦‚ `kernelbase.dll`ï¼‰çš„æ˜ å°„å…³ç³»ï¼Œä»Žè€Œæ­£ç¡®è§£æžè½¬å‘æ¡ç›®ã€‚

ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšï¼Ÿ  
è¿™é€šå¸¸æ˜¯ä¸ºäº†**è§„é¿ EDR**ï¼ˆç»ˆç«¯æ£€æµ‹ä¸Žå“åº”ç³»ç»Ÿï¼‰ã€‚çŽ°ä»£å®‰å…¨è½¯ä»¶æ™®éä¼šå¯¹ `GetProcAddress`ã€`LoadLibrary` ç­‰å…³é”® API è¿›è¡Œ **User-land Hook** ç›‘æŽ§ï¼Œä¸€æ—¦å‘çŽ°ç¨‹åºè¯•å›¾èŽ·å–æ•æ„Ÿå‡½æ•°ï¼ˆå¦‚ `NtCreateThreadEx`ã€`VirtualAlloc`ï¼‰ï¼Œå°±ä¼šè§¦å‘å‘Šè­¦æˆ–é˜»æ–­ã€‚è€Œé€šè¿‡è¿™ç§â€œæ‰‹åŠ¨è§£æžå†…å­˜ä¸­ PE ç»“æž„â€çš„æ–¹å¼ï¼ˆå±žäºŽ **Reflective Loading / Manual Mapping** æŠ€æœ¯çš„æ ¸å¿ƒçŽ¯èŠ‚ï¼‰ï¼Œç¨‹åºå¯ä»¥æ‚„æ— å£°æ¯åœ°èŽ·å–ä»»æ„å‡½æ•°åœ°å€ï¼Œå…¨ç¨‹ä¸è°ƒç”¨ä»»ä½•è¢«ç›‘æŽ§çš„ç³»ç»Ÿ APIï¼Œä»Žè€Œæœ‰æ•ˆç»•è¿‡ç”¨æˆ·æ€é’©å­ï¼Œå®žçŽ°éšè”½æ‰§è¡Œâ€”â€”è¿™æ­£æ˜¯çº¢é˜Ÿå·¥å…·å’Œé«˜çº§åŠ è½½å™¨ï¼ˆå¦‚ä½ çš„ `dinvk` é¡¹ç›®ï¼‰è¿½æ±‚çš„æ ¸å¿ƒèƒ½åŠ›ã€‚

```rust
// src/types.rs
#[repr(C)]
pub struct PEB_LDR_DATA {
    pub Length: u32,
    pub Initialized: u8,
    pub SsHandle: HANDLE,
    pub InLoadOrderModuleList: LIST_ENTRY,
    pub InMemoryOrderModuleList: LIST_ENTRY,
    pub InInitializationOrderModuleList: LIST_ENTRY,
    pub EntryInProgress: *mut c_void,
    pub ShutdownInProgress: u8,
    pub ShutdownThreadId: HANDLE,
}

#[repr(C)]
//ä¸Žvergä¸­_LDR_DATA_TABLE_ENTRYç›¸å¯¹åº”
pub struct LDR_DATA_TABLE_ENTRY {
    pub Reserved1: [*mut c_void; 2],//è¯¥å­—æ®µå¤§å°16å­—èŠ‚,å› ä¸ºåœ¨repr(c)æ¨¡å¼ä¸‹64 bit osä¸€ä¸ªæŒ‡é’ˆå ç”¨8å­—èŠ‚
    pub InMemoryOrderLinks: LIST_ENTRY,
    pub Reserved2: [*mut c_void; 2],
    pub DllBase: *mut c_void,//ç›®æ ‡æ¨¡å—ï¼ˆé€šå¸¸æ˜¯ntdll.dll æˆ– kernel32.dllï¼‰åœ¨å†…å­˜ä¸­çš„èµ·å§‹åœ°å€ï¼ˆDllBaseï¼‰
    pub Reserved3: [*mut c_void; 2],
    pub FullDllName: UNICODE_STRING,
    pub Reserved4: [u8; 8],//æ­¤å¤„ä½ç½®0x58,è¿™é‡Œæ˜¯å ä½å†™æ³•,å®žé™…ä¸Šè¿™é‡Œå¯¹åº”çš„æ˜¯ struct _UNICODE_STRING BaseDllName;
    pub Reserved5: [*mut c_void; 3],
    pub Anonymous: LDR_DATA_TABLE_ENTRY_0,
    pub TimeDateStamp: u32,
}
```

1. **è®¿é—® `PEB.Ldr`**  
   èŽ·å–å½“å‰è¿›ç¨‹çš„ `PEB_LDR_DATA` ç»“æž„ã€‚
2. **éåŽ† `InMemoryOrderModuleList`**  
   è¯¥åŒå‘é“¾è¡¨æŒ‰æ¨¡å—åœ¨å†…å­˜ä¸­çš„å¸ƒå±€é¡ºåºç»„ç»‡ã€‚
3. **æ¯ä¸ªèŠ‚ç‚¹æ˜¯ä¸€ä¸ª `LDR_DATA_TABLE_ENTRY`**  
   æè¿°ä¸€ä¸ªå·²åŠ è½½çš„ PE æ¨¡å—ï¼ˆEXE æˆ– DLLï¼‰ã€‚
4. **è¯»å– `DllBase` å­—æ®µ**  
   å¾—åˆ°è¯¥æ¨¡å—åœ¨è¿›ç¨‹åœ°å€ç©ºé—´ä¸­çš„åŸºåœ°å€ã€‚
5. **`DllBase` å³ä¸º `IMAGE_DOS_HEADER` çš„åœ°å€**  
   å¯ä»Žæ­¤å¤„å¼€å§‹è§£æžå®Œæ•´çš„ PE ç»“æž„ã€‚
6. **è§£æžå¯¼å‡ºè¡¨ä»¥èŽ·å–å‡½æ•°åœ°å€**  
   ä¾‹å¦‚ï¼Œå¯æ‰‹åŠ¨å®šä½ `kernel32!LoadLibraryA` çš„è¿è¡Œæ—¶åœ°å€ã€‚

### è”ç³»ä¸‰: æ•°æ®ç›®å½•çš„è¿è¡Œæ—¶è®¿é—®ï¼ˆData Directoriesï¼‰

PE æ–‡ä»¶ä¸­çš„ **æ•°æ®ç›®å½•**ï¼ˆå¦‚å¯¼å‡ºè¡¨ã€å¯¼å…¥è¡¨ã€èµ„æºè¡¨ç­‰ï¼‰ä½¿ç”¨çš„æ˜¯ **RVA**ï¼ˆRelative Virtual Addressï¼Œç›¸å¯¹è™šæ‹Ÿåœ°å€ï¼‰ã€‚

> âš ï¸ RVA ä»…æ˜¯ä¸€ä¸ªåç§»é‡ï¼Œä¸èƒ½ç›´æŽ¥ç”¨äºŽå†…å­˜è®¿é—®ã€‚å¿…é¡»ç»“åˆæ¨¡å—åŸºå€è½¬æ¢ä¸º **VA**ï¼ˆVirtual Addressï¼‰ã€‚

åœ°å€è½¬æ¢å…¬å¼ï¼š  
> **VA = æ¨¡å—åŸºå€ï¼ˆæ¥è‡ª PEB/Ldrï¼‰ + RVAï¼ˆæ¥è‡ª PE å¤´ï¼‰**

ç¤ºä¾‹åœºæ™¯ï¼šæ‰‹åŠ¨æŸ¥æ‰¾å¯¼å‡ºå‡½æ•°åœ°å€

1. **é€šè¿‡ PEB å®šä½æ¨¡å—**  
   éåŽ† `PEB.Ldr` æ‰¾åˆ° `kernel32.dll` çš„åŸºå€ `base_addr`ã€‚
2. **å®šä½ NT å¤´**  
   ä»Ž `base_addr` è¯»å– `IMAGE_DOS_HEADER`ï¼Œé€šè¿‡ `e_lfanew` å­—æ®µè·³è½¬åˆ° `IMAGE_NT_HEADERS`ã€‚
3. **èŽ·å–å¯¼å‡ºè¡¨ RVA**  
   è¯»å– `OptionalHeader.DataDirectory[0]`ï¼ˆç´¢å¼• 0 å¯¹åº”å¯¼å‡ºè¡¨ï¼‰ï¼Œå¾—åˆ° `export_rva`ã€‚
4. **è®¡ç®—å¯¼å‡ºè¡¨çœŸå®žåœ°å€**  
   `export_table_va = base_addr + export_rva`
5. **è§£æžå¯¼å‡ºè¡¨**  
   éåŽ†å‡½æ•°åæ•°ç»„ï¼ŒåŒ¹é…ç›®æ ‡å‡½æ•°ï¼ˆå¦‚ `"LoadLibraryA"`ï¼‰ï¼ŒèŽ·å–å…¶ `function_rva`ã€‚
6. **è®¡ç®—å‡½æ•°æœ€ç»ˆåœ°å€**  
   `function_address = base_addr + function_rva`

> âœ… **ç»“è®º**ï¼š  
> **PEB æ˜¯åŠ¨æ€çš„åœ°å›¾**ï¼ŒæŒ‡å¼•ä½ åœ¨è¿›ç¨‹å†…å­˜ä¸­å®šä½æ¯ä¸€ä¸ªé™æ€çš„ PE æ–‡ä»¶å—ã€‚  
> æ²¡æœ‰ PEBï¼Œå†…å­˜ä¸­çš„ PE æ¨¡å—å°±å¦‚åŒæ²¡æœ‰ç´¢å¼•çš„å›¾ä¹¦é¦†ä¹¦ç±â€”â€”å­˜åœ¨å´æ— æ³•é«˜æ•ˆä½¿ç”¨ã€‚

## PE

PE (Portable Executable) å’Œ PEB (Process Environment Block) æ˜¯ Windowsæ“ä½œç³»ç»Ÿä¸­ä¸¤ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼Œå®ƒä»¬åˆ†åˆ«ä»£è¡¨äº†ç¨‹åºçš„é™æ€å­˜å‚¨å½¢æ€å’ŒåŠ¨æ€è¿è¡Œå½¢æ€ã€‚  
PEB è®°å½•äº† PE æ–‡ä»¶è¢«åŠ è½½åˆ°å†…å­˜åŽçš„å…³é”®ä¿¡æ¯ï¼Œæ˜¯è®¿é—®å’Œè§£æžå†…å­˜ä¸­PE ç»“æž„çš„å…¥å£ã€‚

PE æ–‡ä»¶æœ¬è´¨ä¸Šæ˜¯ **â€œçº¿æ€§å­˜å‚¨çš„æ•°æ®ç»“æž„é›†åˆâ€**ã€‚åœ¨ç£ç›˜ä¸Šå’Œåœ¨å†…å­˜ä¸­ï¼Œå®ƒä»¬çš„é€»è¾‘é¡ºåºä¸€è‡´ï¼Œä½†ç‰©ç†é—´è·ï¼ˆå¯¹é½ï¼‰ä¸åŒã€‚  
PE æ˜¯ Windows å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆ.exe, .dll,.sysï¼‰çš„æ ‡å‡†æ ¼å¼ã€‚å®ƒæè¿°äº†ä»£ç ã€æ•°æ®ã€èµ„æºåœ¨æ–‡ä»¶ä¸­å¦‚ä½•ç»„ç»‡ï¼Œä»¥åŠåŠ è½½åˆ°å†…å­˜æ—¶åº”è¯¥å¦‚ä½•æ˜ å°„ã€‚

åœ¨æœ¬é¡¹ç›®ä¸­ï¼Œè°ƒç”¨ç³»ç»Ÿè°ƒç”¨ï¼ˆsyscallï¼‰æˆ–å…³é”® API çš„è¿‡ç¨‹æ˜¯çº¯æ‰‹åŠ¨çš„ï¼Œä¸ä¾èµ–æ“ä½œç³»ç»Ÿæä¾›çš„æ ‡å‡†åŠ è½½å™¨ï¼ˆLoaderï¼‰åŠŸèƒ½ã€‚  

1. å®šä¹‰æ•°æ®ç»“æž„ï¼ˆMappingï¼‰ï¼š
      Rust ä»£ç åœ¨ src/types.rs ä¸­ä½¿ç”¨ #[repr(C)] ç²¾ç¡®å¤åˆ»äº† Windows PE
  æ–‡ä»¶çš„å†…å­˜å¸ƒå±€ã€‚è¿™æ„å‘³ç€ Rust ç»“æž„ä½“çš„å†…å­˜åˆ†å¸ƒä¸Ž Windows
  å†…æ ¸å’Œç¡¬ä»¶çœ‹åˆ°çš„äºŒè¿›åˆ¶æ•°æ®å®Œå…¨ä¸€è‡´ã€‚

   1. èŽ·å–åŸºå€ï¼ˆBase Addressï¼‰ï¼š
      ä»£ç é¦–å…ˆé€šè¿‡è¯»å– TEB (Thread Environment Block) -> PEB (Process Environment Block) -> Ldr (Loader Data) é“¾è¡¨ï¼Œæ‰¾åˆ°ç›®æ ‡æ¨¡å—ï¼ˆé€šå¸¸æ˜¯ntdll.dll æˆ– kernel32.dllï¼‰åœ¨å†…å­˜ä¸­çš„èµ·å§‹åœ°å€ï¼ˆDllBaseï¼‰ã€‚

   2. è§£æž PE ç»“æž„ï¼ˆParsingï¼‰ï¼š
      åˆ©ç”¨ç¬¬ 1 æ­¥å®šä¹‰çš„ç»“æž„ä½“ï¼Œä»£ç å°†è¿™ä¸ªåŸºå€å¼ºè½¬ä¸º *const
  IMAGE_DOS_HEADER æŒ‡é’ˆï¼Œé€šè¿‡ e_lfanew æ‰¾åˆ° IMAGE_NT_HEADERSï¼Œå†è®¿é—®
  OptionalHeader.DataDirectory æ‰¾åˆ° å¯¼å‡ºè¡¨ (Export Directory)ã€‚

   3. æŸ¥æ‰¾å‡½æ•°ï¼ˆResolutionï¼‰ï¼š
      éåŽ†å¯¼å‡ºè¡¨ä¸­çš„å‡½æ•°åç§°æ•°ç»„ï¼ˆAddressOfNamesï¼‰ï¼Œæ‰¾åˆ°ç›®æ ‡å‡½æ•°ï¼ˆä¾‹å¦‚NtAllocateVirtualMemory æˆ– LoadLibraryAï¼‰ã€‚

   4. èŽ·å–åœ°å€æˆ– SSNï¼ˆExtractionï¼‰ï¼š
       - å¯¹äºŽ API
         è°ƒç”¨ï¼šä»Žå¯¼å‡ºè¡¨ä¸­èŽ·å–è¯¥å‡½æ•°çš„å†…å­˜åœ°å€ï¼Œå°†å…¶å¼ºè½¬ä¸ºå‡½æ•°æŒ‡é’ˆï¼ˆå¦‚
         LoadLibraryAFnï¼‰å¹¶ç›´æŽ¥è°ƒç”¨ã€‚
       - å¯¹äºŽ Syscallï¼šè§£æž ntdll.dll ä¸­å¯¹åº”å‡½æ•°çš„æ±‡ç¼–ä»£ç ï¼ˆé€šå¸¸æ˜¯ mov eax, SSN; syscallï¼‰ï¼Œæå–å‡º SSN (System Service Number)ã€‚

   5. æ‰§è¡Œè°ƒç”¨ï¼ˆExecutionï¼‰ï¼š
      ä½¿ç”¨å†…è”æ±‡ç¼–ï¼ˆasm!ï¼‰ç›´æŽ¥æ‰§è¡Œ syscall æŒ‡ä»¤ï¼ˆä¼ å…¥æå–å‡ºçš„
  SSNï¼‰ï¼Œæˆ–è€…è·³è½¬åˆ°èŽ·å–åˆ°çš„ API å‡½æ•°åœ°å€æ‰§è¡Œã€‚

  æ ¸å¿ƒæ„ä¹‰ï¼š
  è¿™ä¸ªè¿‡ç¨‹å®Œå…¨ç»•è¿‡äº† Windows çš„ GetProcAddress å’Œ GetModuleHandle ç­‰æ ‡å‡†APIã€‚è¿™æ ·åšä½¿å¾—å®‰å…¨è½¯ä»¶ï¼ˆEDR/AVï¼‰éš¾ä»¥é€šè¿‡é€šè¿‡æŒ‚é’©ï¼ˆHookï¼‰æ ‡å‡† APIæ¥ç›‘æŽ§ä½ çš„è¡Œä¸ºï¼Œä»Žè€Œå®žçŽ°éšè”½è°ƒç”¨ã€‚  
  æœ¬é¡¹ç›®ä¸­ä½¿ç”¨rustè¡¨ç¤ºäº†peæ–‡ä»¶å„ä¸ªå­—æ®µçš„ç»“æž„,éœ€è¦è°ƒç”¨syscallæ—¶,ä¼šé€šè¿‡è¿™äº›å®šä¹‰çš„æ•°æ®ç»“æž„,æ¥èŽ·å–ç›¸å…³ä¿¡æ¯  

### æœ¬é¡¹ç›®æ²¡æœ‰å®šä¹‰ä¸€ä¸ªæŠŠæ‰€æœ‰å­—æ®µæ‰“åŒ…åœ¨ä¸€èµ·çš„å•ä¸€ `PE`ç»“æž„ä½“ï¼Ÿ

ä¸»è¦åŽŸå› åœ¨äºŽï¼šPE æ–‡ä»¶åœ¨ç£ç›˜ä¸Šçš„å½¢æ€ï¼ˆFile Alignmentï¼‰ä¸Žåœ¨å†…å­˜ä¸­çš„å½¢æ€ï¼ˆSection Alignmentï¼‰æ˜¯ä¸ä¸€è‡´çš„ã€‚  
å› ä¸ºæ•°æ®åœ¨åŠ è½½åŽä½ç½®å˜äº†ï¼Œä½ æ— æ³•ç”¨ä¸€ä¸ªè¿žç»­çš„ Rust/Cç»“æž„ä½“æ¥â€œå¥—â€ä½æ•´ä¸ªå†…å­˜æˆ–ç£ç›˜ä¸Šçš„ PE æ–‡ä»¶

#### dinvk çš„åšæ³•ï¼šé€šè¿‡æŒ‡é’ˆå’Œåç§»é‡è®¿é—®

æ­£å› ä¸ºä¸èƒ½ç”¨ä¸€ä¸ªå¤§ç»“æž„ä½“è¡¨ç¤ºï¼Œdinvké‡‡ç”¨çš„æ˜¯åŸºäºŽæŒ‡é’ˆçš„è§£æžæ–¹å¼ã€‚è¿™ä¹Ÿæ˜¯æ“ä½œç³»ç»Ÿå’Œè°ƒè¯•å™¨çš„æ ‡å‡†åšæ³•ã€‚

æ²¡æœ‰ struct PE æ˜¯å› ä¸º PEä¸æ˜¯ä¸€ä¸ªé™æ€çš„è¿žç»­æ•°æ®å—ï¼Œè€Œæ˜¯ä¸€ä¸ªè“å›¾ã€‚æ ¹æ®è¿™ä¸ªè“å›¾ï¼Œæ–‡ä»¶è¢«â€œæ‹†æ•£â€å¹¶â€œé‡ç»„â€åˆ°äº†å†…å­˜ä¸­ã€‚å› æ­¤ï¼Œä½¿ç”¨å¤šä¸ªå°çš„ Header ç»“æž„ä½“ + æŒ‡é’ˆç®—æœ¯æ˜¯å¤„ç† PE æ–‡ä»¶çš„å”¯ä¸€æ­£ç¡®æ–¹å¼ã€‚

### PE (Memory Layout)

å‡è®¾å†…å­˜åœ°å€ä»Žä½Žåˆ°é«˜å‘ä¸‹å¢žé•¿ï¼š

```text
åŸºåœ°å€ (ImageBase) ----> +-----------------------------+
                        |      MS-DOS Header          |  <- "MZ" å¤´
                        +-----------------------------+
                        |       MS-DOS Stub           |  <- åŽ†å²é—ç•™åºŸè¯
                        +-----------------------------+
ntHeaders æŒ‡é’ˆ -------->|      PE Signature           |  <- "PE\0\0"
(DOS.e_lfanew)          +-----------------------------+
                        |    IMAGE_FILE_HEADER        |  <- ç‰©ç†æ¦‚å†µ (CPUæž¶æž„, èŠ‚æ•°é‡)
                        +-----------------------------+
                        | IMAGE_OPTIONAL_HEADER (64)  |  <- é€»è¾‘æ ¸å¿ƒ (OEP, ImageBase)
                        |                             |
                        |   [ Data Directories ]      |  <- *å…³é”®æ•°ç»„* (å¯¼å‡ºè¡¨/å¯¼å…¥è¡¨ç´¢å¼•)
                        +-----------------------------+
SectionHeaders æŒ‡é’ˆ --->|   IMAGE_SECTION_HEADER [0]  |  <- .text çš„æè¿°ä¿¡æ¯
                        |   IMAGE_SECTION_HEADER [1]  |  <- .rdata çš„æè¿°ä¿¡æ¯
                        |   ...                       |
                        +-----------------------------+
                        |         (å¡«å……/Padding)      |  <- å¯¹é½é—´éš™
                        +=============================+
                        |        Section .text        |  <- çœŸæ­£çš„ä»£ç 
                        +-----------------------------+
                        |        Section .rdata       |  <- å¸¸é‡/å¯¼å…¥è¡¨æ•°æ®
                        +-----------------------------+
                        |        Section .data        |  <- å…¨å±€å˜é‡
                        +-----------------------------+
                        |        Section .reloc       |  <- é‡å®šä½æ•°æ®
                        +-----------------------------+
```

### PEæ–‡ä»¶ç»“æž„

ä¸ºäº†é¿å…ä¾èµ–åºžå¤§çš„ windows-sys æˆ– winapi crateï¼Œé€‰æ‹©æ‰‹åŠ¨å®šä¹‰äº†è¿™äº›åº•å±‚ç»“æž„ã€‚è¿™ç§åšæ³•åœ¨æ¶æ„è½¯ä»¶å¼€å‘æˆ–çº¢é˜Ÿå·¥å…·ï¼ˆå¦‚ä½ æ­£åœ¨å¼€å‘çš„RustRedOpsï¼‰ä¸­éžå¸¸å¸¸è§ï¼Œç›®çš„æ˜¯ä¸ºäº†å‡å°‘ç‰¹å¾æŒ‡çº¹?ä¸ºä»€ä¹ˆã€å‡å°äºŒè¿›åˆ¶ä½“ç§¯?ä¸ºä»€ä¹ˆä»¥åŠæ‹¥æœ‰æ›´ç²¾ç»†çš„æŽ§åˆ¶æƒã€‚

#### PE æ–‡ä»¶ç»“æž„è¯¦è§£ï¼šåŸºäºŽ `dinvk` é¡¹ç›®ä¸­çš„æ•°æ®ç»“æž„

PEï¼ˆPortable Executableï¼‰æ˜¯ Windows ç³»ç»Ÿä¸‹å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆEXEï¼‰ã€åŠ¨æ€é“¾æŽ¥åº“ï¼ˆDLLï¼‰ã€é©±åŠ¨ï¼ˆSYSï¼‰ç­‰çš„æ ‡å‡†æ ¼å¼ã€‚æœ¬æ–‡ä»¥å¼€æºé¡¹ç›® **`dinvk`** ä¸­ `src/types.rs` å®šä¹‰çš„ Rust ç»“æž„ä½“ä¸ºè“æœ¬ï¼Œ**ä»Žç£ç›˜æ–‡ä»¶åç§» 0 å¼€å§‹**ï¼Œé€å­—æ®µã€é€ç»“æž„åœ°è¯¦ç»†è§£é‡Š PE æ–‡ä»¶ä¸­æ¯ä¸€ä¸ªå­—æ®µçš„å«ä¹‰ä¸Žä½œç”¨ã€‚

---

#### ç¬¬ä¸€éƒ¨åˆ†ï¼šDOS Headerï¼ˆå…¼å®¹æ€§å¤´éƒ¨ï¼‰

ä½äºŽæ–‡ä»¶èµ·å§‹ä½ç½®ï¼ˆ**Offset 0**ï¼‰ï¼Œå…± 64 å­—èŠ‚ï¼ˆ0x40ï¼‰ã€‚å…¶å­˜åœ¨æ˜¯ä¸ºäº†å‘åŽå…¼å®¹ MS-DOS ç³»ç»Ÿã€‚

```rust
#[repr(C, packed(2))]
pub struct IMAGE_DOS_HEADER {
    pub e_magic: u16,    // [0x00] é­”æ•° "MZ" (0x5A4D)
                         // æ ‡è¯†è¿™æ˜¯ä¸€ä¸ª DOS å¯æ‰§è¡Œæ–‡ä»¶ã€‚
                         // Windows åŠ è½½å™¨é¦–å…ˆæ£€æŸ¥æ­¤å€¼ï¼Œéž MZ åˆ™æ‹’ç»åŠ è½½ã€‚

    pub e_cblp: u16,     // [0x02] æ–‡ä»¶æœ€åŽä¸€é¡µä¸­çš„å­—èŠ‚æ•°ï¼ˆ< 512ï¼‰
                         // DOS æ—¶ä»£ç”¨äºŽè®¡ç®—å®žé™…æ–‡ä»¶å¤§å°ï¼ŒçŽ°ä»£å¿½ç•¥ã€‚

    pub e_cp: u16,       // [0x04] æ–‡ä»¶æ€»é¡µæ•°ï¼ˆæ¯é¡µ 512 å­—èŠ‚ï¼‰
                         // å®žé™…å¤§å° â‰ˆ (e_cp - 1) * 512 + e_cblp

    pub e_crlc: u16,     // [0x06] é‡å®šä½é¡¹æ•°é‡
                         // DOS ç¨‹åºåŠ è½½æ—¶éœ€æ ¹æ®æ­¤ä¿®æ­£åœ°å€ï¼ŒPE æ–‡ä»¶ä¸­é€šå¸¸ä¸º 0ã€‚

    pub e_cparhdr: u16,  // [0x08] å¤´éƒ¨å¤§å°ï¼ˆä»¥ 16 å­—èŠ‚â€œæ®µâ€ä¸ºå•ä½ï¼‰
                         // å³ DOS å¤´ + DOS Stub çš„æ€»æ®µæ•°ã€‚ä¾‹å¦‚å€¼ä¸º 4 è¡¨ç¤º 64 å­—èŠ‚ã€‚

    pub e_minalloc: u16, // [0x0A] ç¨‹åºè¿è¡Œæ‰€éœ€çš„æœ€å°é¢å¤–å†…å­˜ï¼ˆæ®µï¼‰
    pub e_maxalloc: u16, // [0x0C] ç¨‹åºå¯ç”³è¯·çš„æœ€å¤§é¢å¤–å†…å­˜ï¼ˆæ®µï¼‰

    pub e_ss: u16,       // [0x0E] åˆå§‹ SSï¼ˆå †æ ˆæ®µå¯„å­˜å™¨å€¼ï¼‰
    pub e_sp: u16,       // [0x10] åˆå§‹ SPï¼ˆå †æ ˆæŒ‡é’ˆï¼‰
                         // DOS å¯åŠ¨æ—¶è®¾ç½®å †æ ˆä½ç½®ã€‚

    pub e_csum: u16,     // [0x12] æ ¡éªŒå’Œï¼ˆé€šå¸¸ä¸º 0ï¼Œæœªä½¿ç”¨ï¼‰

    pub e_ip: u16,       // [0x14] åˆå§‹ IPï¼ˆæŒ‡ä»¤æŒ‡é’ˆï¼‰
    pub e_cs: u16,       // [0x16] åˆå§‹ CSï¼ˆä»£ç æ®µå¯„å­˜å™¨å€¼ï¼‰
                         // DOS å…¥å£ç‚¹ = CS:IP

    pub e_lfarlc: u16,   // [0x18] é‡å®šä½è¡¨åœ¨æ–‡ä»¶ä¸­çš„åç§»ï¼ˆDOS ç”¨ï¼‰

    pub e_ovno: u16,     // [0x1A] è¦†ç›–å·ï¼ˆOverlay Numberï¼‰
                         // ç”¨äºŽ DOS çš„è¦†ç›–ç®¡ç†æœºåˆ¶ï¼ˆç±»ä¼¼åˆ†æ®µåŠ è½½ï¼‰

    pub e_res: [u16; 4], // [0x1C] ä¿ç•™å­—æ®µï¼ˆå…± 8 å­—èŠ‚ï¼‰ï¼Œå¿…é¡»ä¸º 0

    pub e_oemid: u16,    // [0x24] OEM æ ‡è¯†ç¬¦ï¼ˆç‰¹å®šåŽ‚å•†æ‰©å±•ï¼‰
    pub e_oeminfo: u16,  // [0x26] OEM ä¿¡æ¯ï¼ˆé…åˆ e_oemid ä½¿ç”¨ï¼‰

    pub e_res2: [u16; 10], // [0x28] ä¿ç•™å­—æ®µï¼ˆå…± 20 å­—èŠ‚ï¼‰ï¼Œå¿…é¡»ä¸º 0

    pub e_lfanew: i32,   // [0x3C] â˜…å…³é”®å­—æ®µâ˜…
                         // æŒ‡å‘ NT Headers çš„**æ–‡ä»¶åç§»é‡**ï¼ˆFile Offsetï¼‰ã€‚
                         // Windows åŠ è½½å™¨è¯»å–æ­¤å€¼è·³è½¬åˆ°çœŸæ­£çš„ PE å¤´éƒ¨ã€‚
}
```

> ðŸ’¡ **DOS Stub**  
> åœ¨ `IMAGE_DOS_HEADER` å’Œ `NT Headers` ä¹‹é—´é€šå¸¸åµŒå…¥ä¸€æ®µå° DOS ç¨‹åºï¼ˆå¦‚æ‰“å° â€œThis program cannot be run in DOS modeâ€ï¼‰ã€‚  
> æ­¤éƒ¨åˆ†å¯¹çŽ°ä»£ PE è§£æžæ— å®žè´¨æ„ä¹‰ï¼Œ`dinvk` æœªå®šä¹‰å…¶ç»“æž„ã€‚

---

#### ç¬¬äºŒéƒ¨åˆ†ï¼šNT Headersï¼ˆPE æ ¸å¿ƒå¤´ï¼‰

é€šè¿‡ `e_lfanew` è·³è½¬åˆ°è¾¾ã€‚åŒ…å«ç­¾åã€æ–‡ä»¶å¤´å’Œå¯é€‰å¤´ä¸‰éƒ¨åˆ†ï¼Œæ˜¯è§£æž PE çš„æ ¸å¿ƒã€‚

```rust
#[repr(C)]
pub struct IMAGE_NT_HEADERS {
    pub Signature: u32,  // [0x00] å›ºå®šä¸º "PE\0\0" (0x00004550)
                         // ç¬¬äºŒé“åˆæ³•æ€§æ ¡éªŒã€‚è‹¥éžæ­¤å€¼ï¼Œåˆ™ä¸æ˜¯æœ‰æ•ˆ PE æ–‡ä»¶ã€‚

    pub FileHeader: IMAGE_FILE_HEADER,         // æè¿°ç‰©ç†å±žæ€§
    pub OptionalHeader: IMAGE_OPTIONAL_HEADER64, // æè¿°åŠ è½½ä¸Žè¿è¡Œæ—¶è¡Œä¸º
}
```

##### 2.1 File Headerï¼ˆæ–‡ä»¶ç‰©ç†æ¦‚å†µï¼‰

æè¿°ç›®æ ‡å¹³å°ã€èŠ‚åŒºæ•°é‡ç­‰åŸºæœ¬ä¿¡æ¯ï¼Œå…± 20 å­—èŠ‚ã€‚

```rust
#[repr(C)]
pub struct IMAGE_FILE_HEADER {
    pub Machine: IMAGE_FILE_MACHINE, // [0x04] ç›®æ ‡ CPU æž¶æž„
                                     // å¸¸è§å€¼ï¼š
                                     // - 0x014C = i386 (x86)
                                     // - 0x8664 = AMD64 (x86_64)
                                     // - 0xAA64 = ARM64
                                     // - 0x0200 = IA64

    pub NumberOfSections: u16,       // [0x06] èŠ‚ï¼ˆSectionï¼‰æ•°é‡
                                     // å†³å®šåŽç»­ Section Headers æ•°ç»„é•¿åº¦ã€‚
                                     // é€šå¸¸ 2~10 ä¸ªï¼ˆå¦‚ .text, .data, .rdata, .pdataï¼‰

    pub TimeDateStamp: u32,          // [0x08] ç¼–è¯‘æ—¶é—´æˆ³ï¼ˆUnix æ—¶é—´ï¼Œç§’ï¼‰
                                     // è‡ª 1970-01-01 00:00:00 UTC èµ·çš„ç§’æ•°ã€‚
                                     // å¯é‡çŽ°æž„å»ºï¼ˆReproducible Buildï¼‰å¸¸è®¾ä¸º 0ã€‚

    pub PointerToSymbolTable: u32,   // [0x0C] COFF ç¬¦å·è¡¨æ–‡ä»¶åç§»
                                     // è°ƒè¯•ä¿¡æ¯ï¼Œå‘å¸ƒç‰ˆé€šå¸¸ä¸º 0ã€‚

    pub NumberOfSymbols: u32,        // [0x10] ç¬¦å·æ•°é‡ï¼ˆé…åˆä¸Šä¸€å­—æ®µï¼‰

    pub SizeOfOptionalHeader: u16,   // [0x14] OptionalHeader çš„å¤§å°ï¼ˆå­—èŠ‚ï¼‰
                                     // - x86 PE32: 0xE0 (224)
                                     // - x64 PE32+: 0xF0 (240)

    pub Characteristics: IMAGE_FILE_CHARACTERISTICS, // [0x16] æ–‡ä»¶å±žæ€§æ ‡å¿—ï¼ˆä½æŽ©ç ï¼‰
                                                     // å¸¸è§æ ‡å¿—ï¼š
                                                     // - 0x0001 = é‡å®šä½ä¿¡æ¯å·²ç§»é™¤
                                                     // - 0x0002 = å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆEXEï¼‰
                                                     // - 0x2000 = DLL
                                                     // - 0x0100 = 32 ä½æœºå™¨
                                                     // - 0x0020 = è¡Œå·ä¿¡æ¯å·²ç§»é™¤
}
```

##### 2.2 Optional Headerï¼ˆé€»è¾‘åŠ è½½ä¿¡æ¯ï¼‰

è™½åä¸º â€œOptionalâ€ï¼Œä½†å¯¹ EXE/DLL æ˜¯**å¿…é¡»å­˜åœ¨**çš„ã€‚æ­¤å¤„ä»¥ 64 ä½ç‰ˆæœ¬ï¼ˆ`IMAGE_OPTIONAL_HEADER64`ï¼‰ä¸ºä¾‹ã€‚

```rust
#[repr(C, packed(4))]
pub struct IMAGE_OPTIONAL_HEADER64 {
    // --- æ ‡å‡†å­—æ®µ (Standard Fields) ---
    pub Magic: IMAGE_OPTIONAL_HEADER_MAGIC, // [0x18]
                                            // - 0x10B = PE32 (32-bit)
                                            // - 0x20B = PE32+ (64-bit)

    pub MajorLinkerVersion: u8,  // [0x1A] é“¾æŽ¥å™¨ä¸»ç‰ˆæœ¬å·
    pub MinorLinkerVersion: u8,  // [0x1B] é“¾æŽ¥å™¨æ¬¡ç‰ˆæœ¬å·
                                 // ä»…ä½œå‚è€ƒï¼Œä¸å½±å“åŠ è½½

    pub SizeOfCode: u32,         // [0x1C] æ‰€æœ‰å«ä»£ç èŠ‚çš„æ€»å¤§å°ï¼ˆå¦‚ .textï¼‰
                                 // æŒ‰ SectionAlignment å¯¹é½åŽçš„æ€»å’Œ

    pub SizeOfInitializedData: u32,   // [0x20] å·²åˆå§‹åŒ–æ•°æ®èŠ‚æ€»å¤§å°ï¼ˆå¦‚ .data, .rdataï¼‰

    pub SizeOfUninitializedData: u32, // [0x24] æœªåˆå§‹åŒ–æ•°æ®å¤§å°ï¼ˆ.bssï¼‰
                                      // è¯¥èŠ‚åœ¨ç£ç›˜ä¸Šæ— æ•°æ®ï¼Œä»…å å†…å­˜ç©ºé—´

    pub AddressOfEntryPoint: u32, // [0x28] â˜…ç¨‹åºå…¥å£ç‚¹ RVAâ˜…
                                  // è¿›ç¨‹å¯åŠ¨åŽï¼ŒRIP = ImageBase + æ­¤å€¼
                                  // DLL çš„ DllMain åœ°å€ä¹Ÿåœ¨æ­¤æŒ‡å®š

    pub BaseOfCode: u32,         // [0x2C] ä»£ç èŠ‚èµ·å§‹ RVAï¼ˆä»…å‚è€ƒï¼‰

    // æ³¨æ„ï¼š64 ä½ç»“æž„ä¸­æ—  BaseOfData å­—æ®µï¼ˆ32 ä½æœ‰ï¼‰

    // --- NT ç‰¹å®šå­—æ®µ (NT Specific Fields) ---
    pub ImageBase: u64,          // [0x30] å»ºè®®åŠ è½½åŸºå€ï¼ˆPreferred Load Addressï¼‰
                                 // - EXE é»˜è®¤ï¼š0x140000000 (x64)
                                 // - DLL é»˜è®¤ï¼š0x180000000 æˆ–é«˜ä½åœ°å€
                                 // è‹¥è¢«å ç”¨ï¼Œåˆ™è§¦å‘é‡å®šä½ï¼ˆASLRï¼‰

    pub SectionAlignment: u32,   // [0x38] å†…å­˜ä¸­èŠ‚å¯¹é½ç²’åº¦ï¼ˆé€šå¸¸ 0x1000 = 4KBï¼‰
                                 // å¿…é¡» â‰¥ FileAlignment

    pub FileAlignment: u32,      // [0x3C] æ–‡ä»¶ä¸­èŠ‚å¯¹é½ç²’åº¦ï¼ˆé€šå¸¸ 0x200 = 512Bï¼‰
                                 // å¿…é¡»æ˜¯ 2 çš„å¹‚ï¼Œä¸” â‰¥ 512

    pub MajorOperatingSystemVersion: u16, // [0x40] æ‰€éœ€æœ€ä½Ž OS ä¸»ç‰ˆæœ¬
    pub MinorOperatingSystemVersion: u16, // [0x42] æ¬¡ç‰ˆæœ¬
                                          // å¦‚ Win10 = 10.0

    pub MajorImageVersion: u16,  // [0x44] ç¨‹åºè‡ªå®šä¹‰ä¸»ç‰ˆæœ¬ï¼ˆç”±å¼€å‘è€…è®¾ç½®ï¼‰
    pub MinorImageVersion: u16,  // [0x46] è‡ªå®šä¹‰æ¬¡ç‰ˆæœ¬

    pub MajorSubsystemVersion: u16, // [0x48] å­ç³»ç»Ÿä¸»ç‰ˆæœ¬ï¼ˆå¦‚ Console, GUIï¼‰
    pub MinorSubsystemVersion: u16, // [0x4A] å­ç³»ç»Ÿæ¬¡ç‰ˆæœ¬

    pub Win32VersionValue: u32,  // [0x4C] ä¿ç•™å­—æ®µï¼Œå¿…é¡»ä¸º 0

    pub SizeOfImage: u32,        // [0x50] å†…å­˜æ˜ åƒæ€»å¤§å°
                                 // ä»Ž ImageBase åˆ°æœ€åŽä¸€ä¸ªèŠ‚ç»“æŸï¼Œ
                                 // æŒ‰ SectionAlignment å‘ä¸Šå¯¹é½

    pub SizeOfHeaders: u32,      // [0x54] æ‰€æœ‰å¤´éƒ¨æ€»å¤§å°ï¼ˆDOS+NT+SectionHeadersï¼‰
                                 // æŒ‰ FileAlignment å‘ä¸Šå¯¹é½

    pub CheckSum: u32,           // [0x58] æ ¡éªŒå’Œ
                                 // é©±åŠ¨ï¼ˆ.sysï¼‰å¿…é¡»æœ‰æ•ˆï¼Œæ™®é€š EXE å¯ä¸º 0

    pub Subsystem: IMAGE_SUBSYSTEM, // [0x5C] å­ç³»ç»Ÿç±»åž‹
                                    // - 2 = GUI (å›¾å½¢ç•Œé¢)
                                    // - 3 = CUI (æŽ§åˆ¶å°/å‘½ä»¤è¡Œ)
                                    // - 10 = EFI Application

    pub DllCharacteristics: IMAGE_DLL_CHARACTERISTICS, // [0x5E] å®‰å…¨ç‰¹æ€§æ ‡å¿—ï¼ˆä½æŽ©ç ï¼‰
                                                       // - 0x0040 = ASLR æ”¯æŒï¼ˆåŠ¨æ€åŸºå€ï¼‰
                                                       // - 0x0100 = DEP/NXï¼ˆæ•°æ®ä¸å¯æ‰§è¡Œï¼‰
                                                       // - 0x0400 = å¼ºåˆ¶å®Œæ•´æ€§æ£€æŸ¥
                                                       // - 0x4000 = æ—  SEHï¼ˆ/SAFESEH:NOï¼‰

    pub SizeOfStackReserve: u64, // [0x60] æ ˆä¿ç•™è™šæ‹Ÿå†…å­˜å¤§å°ï¼ˆé»˜è®¤ 1MBï¼‰
    pub SizeOfStackCommit: u64,  // [0x68] æ ˆåˆå§‹æäº¤ç‰©ç†å†…å­˜ï¼ˆé»˜è®¤ 4KBï¼‰

    pub SizeOfHeapReserve: u64,  // [0x70] å †ä¿ç•™å¤§å°ï¼ˆé»˜è®¤ 1MBï¼‰
    pub SizeOfHeapCommit: u64,   // [0x78] å †åˆå§‹æäº¤å¤§å°ï¼ˆé»˜è®¤ 4KBï¼‰

    pub LoaderFlags: u32,        // [0x80] å·²åºŸå¼ƒï¼Œåº”ä¸º 0

    pub NumberOfRvaAndSizes: u32,// [0x84] DataDirectory æ•°ç»„å…ƒç´ ä¸ªæ•°
                                 // é€šå¸¸ä¸º 16ï¼Œè¡¨ç¤ºæ”¯æŒ 16 ç§æ•°æ®ç›®å½•

    // --- æ•°æ®ç›®å½•ï¼ˆåŠŸèƒ½ç´¢å¼•è¡¨ï¼‰---
    pub DataDirectory: [IMAGE_DATA_DIRECTORY; 16], // [0x88]
}
```

#### 2.3 Data Directoryï¼ˆåŠŸèƒ½ç´¢å¼•è¡¨ï¼‰

æ¯ä¸ªæ¡ç›®æ˜¯ä¸€ä¸ªæŒ‡å‘å…³é”®åŠŸèƒ½è¡¨çš„ RVA å’Œå¤§å°ã€‚

```rust
#[repr(C)]
#[derive(Clone, Copy)]
pub struct IMAGE_EXPORT_DIRECTORY {
    pub Characteristics: u32,
    pub TimeDateStamp: u32,
    pub MajorVersion: u16,
    pub MinorVersion: u16,
    pub Name: u32,
    pub Base: u32,
    pub NumberOfFunctions: u32,
    pub NumberOfNames: u32,
    pub AddressOfFunctions: u32,
    pub AddressOfNames: u32,
    pub AddressOfNameOrdinals: u32,
}
```

#### `IMAGE_EXPORT_DIRECTORY->AddressOfNames` çš„å†…å­˜å½’å±žè§£æž

ä½ çš„ç†è§£**å®Œå…¨æ­£ç¡®**ï¼š  
`IMAGE_EXPORT_DIRECTORY` ç»“æž„ä½“ä¸­çš„ `AddressOfNames` å­—æ®µæ‰€æŒ‡å‘çš„å‡½æ•°åæ•°ç»„ï¼Œ**å¹¶ä¸åœ¨ä½ å½“å‰ç¨‹åºï¼ˆ.exeï¼‰çš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ï¼Œè€Œæ˜¯ä½äºŽç›®æ ‡ DLLï¼ˆå¦‚ `ntdll.dll`ï¼‰è¢«åŠ è½½åˆ°å†…å­˜åŽçš„æ˜ å°„åŒºåŸŸä¸­**ã€‚

ä¸ºäº†æ›´ä¸¥è°¨åœ°å·©å›ºè¿™ä¸€å…³é”®æ¦‚å¿µï¼Œæˆ‘ä»¬å¯ä»¥ä»Žä»¥ä¸‹ä¸‰ä¸ªç»´åº¦æ·±å…¥æ‹†è§£ï¼š

---

##### 1. **ç‰©ç†å½’å±žï¼šå®ƒæ˜¯ç›®æ ‡ DLL çš„ä¸€éƒ¨åˆ†**

- è¯¥å‡½æ•°åæ•°ç»„æ˜¯ç›®æ ‡ DLLï¼ˆä¾‹å¦‚ `kernel32.dll` æˆ– `ntdll.dll`ï¼‰åœ¨**ç¼–è¯‘å’Œé“¾æŽ¥é˜¶æ®µ**å°±ç”Ÿæˆçš„å¯¼å‡ºè¡¨ï¼ˆExport Tableï¼‰æ•°æ®ã€‚
- å½“ Windows åŠ è½½å™¨å°†è¯¥ DLL æ˜ å°„è¿›ä½ çš„è¿›ç¨‹åœ°å€ç©ºé—´æ—¶ï¼Œæ•´ä¸ª PE ç»“æž„ï¼ˆåŒ…æ‹¬ DOS å¤´ã€NT å¤´ã€èŠ‚è¡¨ã€å¯¼å‡ºè¡¨ç­‰ï¼‰éƒ½ä¼šè¢«è½½å…¥å†…å­˜ã€‚
- ä½ çš„ç¨‹åºï¼ˆ`.exe`ï¼‰**æœ¬èº«ä¸åŒ…å«è¿™äº›å­—ç¬¦ä¸²**ï¼Œå®ƒåªæ˜¯é€šè¿‡ `src/module.rs` ä¸­çš„è§£æžé€»è¾‘ï¼ˆå¦‚ `get_proc_address`ï¼‰åŽ»â€œè¯»å–â€å¦ä¸€ä¸ªæ¨¡å—çš„å†…éƒ¨ç»“æž„ã€‚
  > âœ… ç®€è¨€ä¹‹ï¼šä½ çš„ä»£ç æ˜¯â€œè¯»è€…â€ï¼ŒDLL æ˜¯â€œä¹¦â€ã€‚ä¹¦çš„å†…å®¹ä¸åœ¨è¯»è€…èº«ä½“é‡Œï¼Œä½†è¯»è€…å¯ä»¥ç¿»å¼€å®ƒã€‚

---

##### 2. **å†…å­˜ä½ç½®ï¼šä½äºŽå½“å‰è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´å†…**

- è™½ç„¶è¯¥æ•°ç»„ä¸å±žäºŽä½ çš„ `.exe` æ¨¡å—ï¼Œä½†ç”±äºŽç›®æ ‡ DLL å·²è¢«åŠ è½½åˆ°**åŒä¸€ä¸ªè¿›ç¨‹**ä¸­ï¼Œå…¶å†…å­˜æ˜ åƒå°±å­˜åœ¨äºŽ**å½“å‰è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´**é‡Œã€‚
- å› æ­¤ï¼Œä½ å¯ä»¥å®‰å…¨åœ°æ‰§è¡Œå¦‚ä¸‹æ“ä½œï¼š

  ```rust
  let names_array_rva = export_dir.AddressOfNames;
  let names_array_va = h_module as usize + names_array_rva as usize;
  let names_ptr = names_array_va as *const u32; // å®žé™…æ˜¯æŒ‡å‘ RVA æ•°ç»„
  ```

- è¿™ç§â€œåŸºå€ + RVAâ€çš„åŠ æ³•ä¹‹æ‰€ä»¥æœ‰æ•ˆï¼Œæ­£æ˜¯å› ä¸º `h_module`ï¼ˆå³ DLL çš„åŠ è½½åŸºå€ï¼‰å’Œå¯¼å‡ºè¡¨æ•°æ®**åŒå±žä¸€ä¸ªåœ°å€ç©ºé—´**ã€‚
  > âš ï¸ åä¾‹ï¼šè‹¥å°è¯•ç”¨åŒæ ·æ–¹å¼è¯»å–**å…¶ä»–è¿›ç¨‹**çš„ DLL å†…å­˜ï¼Œåˆ™ä¼šå› åœ°å€ç©ºé—´éš”ç¦»è€Œå¤±è´¥ï¼ˆéœ€ä½¿ç”¨ `ReadProcessMemory` ç­‰ APIï¼‰ã€‚

---

##### 3. **æŠ€æœ¯ç»†èŠ‚ä¿®æ­£ï¼šå®ƒæ˜¯ä¸€ä¸ªâ€œRVA æ•°ç»„â€ï¼Œè€Œéžâ€œå­—ç¬¦ä¸²æ•°ç»„â€**

è¿™é‡Œæœ‰ä¸€ä¸ª**å…³é”®ä½†æ˜“é”™çš„ç»†èŠ‚**éœ€è¦æ¾„æ¸…ï¼š

- âŒ **é”™è¯¯ç†è§£**ï¼š  
  `AddressOfNames` â†’ `["NtAllocateVirtualMemory", "NtCreateThreadEx", ...]`

- âœ… **æ­£ç¡®ç»“æž„**ï¼š  
  `AddressOfNames` â†’ `[RVAâ‚, RVAâ‚‚, RVAâ‚ƒ, ...]`  
  å…¶ä¸­æ¯ä¸ª `RVAáµ¢` æ˜¯ä¸€ä¸ª **ç›¸å¯¹è™šæ‹Ÿåœ°å€ï¼ˆRelative Virtual Addressï¼‰**ï¼ŒæŒ‡å‘çœŸæ­£çš„å‡½æ•°åå­—ç¬¦ä¸²ã€‚

  ä¹Ÿå°±æ˜¯è¯´ï¼Œå®Œæ•´çš„è§£æžè·¯å¾„æ˜¯ï¼š

  ```
  h_module
    â””â”€> IMAGE_EXPORT_DIRECTORY
          â””â”€> AddressOfNames (RVA) 
                â””â”€> [RVA_to_Name1, RVA_to_Name2, ...]  â† è¿™æ˜¯ä¸€ä¸ª u32 æ•°ç»„
                      â””â”€> h_module + RVA_to_Name1 â†’ "NtAllocateVirtualMemory"
                      â””â”€> h_module + RVA_to_Name2 â†’ "NtCreateThreadEx"
  ```

- å› æ­¤ï¼Œåœ¨ä»£ç ä¸­ä½ é€šå¸¸ä¼šçœ‹åˆ°ä¸¤å±‚é—´æŽ¥å¯»å€ï¼š

  ```rust
  // ç¬¬ä¸€å±‚ï¼šèŽ·å–ç¬¬ i ä¸ªå‡½æ•°åçš„ RVA
  let name_rva = unsafe { *(names_ptr.add(i)) };
  // ç¬¬äºŒå±‚ï¼šè®¡ç®—çœŸå®žå­—ç¬¦ä¸²åœ°å€
  let name_str_ptr = (h_module as usize + name_rva as usize) as *const u8;
  ```

---

##### æ€»ç»“

ä½ çš„ç›´è§‰éžå¸¸å‡†ç¡®ï¼š**ä½ çš„ç¨‹åºåªæ˜¯ä¸€ä¸ªâ€œè§‚å¯Ÿè€…â€æˆ–â€œè§£æžå™¨â€**ï¼Œå®ƒé€šè¿‡æŒ‡é’ˆè·¨è¶Šäº†æ¨¡å—è¾¹ç•Œï¼ŒåŽ»çª¥æŽ¢ç›®æ ‡ DLL åœ¨å†…å­˜ä¸­çš„å†…éƒ¨æ•°æ®ç»“æž„ã€‚

åœ¨ `dinvk` è¿™ç±»çº¢é˜Ÿé¡¹ç›®ä¸­ï¼š

- `h_module`ï¼ˆå³ DLL çš„åŠ è½½åŸºå€ï¼‰å°±æ˜¯ä½ è¿›è¡Œâ€œçª¥æŽ¢â€çš„**åŸºå‡†èµ·å§‹ç‚¹**ã€‚
- æ‰€æœ‰å¯¹å¯¼å‡ºè¡¨ï¼ˆEATï¼‰ã€å¯¼å…¥è¡¨ï¼ˆIATï¼‰ã€é‡å®šä½è¡¨çš„æ“ä½œï¼Œæœ¬è´¨ä¸Šéƒ½æ˜¯åŸºäºŽè¿™ä¸ªåŸºå€ + RVA çš„åç§»è®¡ç®—ã€‚
- æ­£æ˜¯è¿™ç§å¯¹ PE ç»“æž„çš„æ·±åº¦æ‰‹åŠ¨è§£æžèƒ½åŠ›ï¼Œä½¿å¾—åŠ è½½å™¨èƒ½å¤Ÿç»•è¿‡ `GetProcAddress` ç­‰è¢«ç›‘æŽ§çš„ APIï¼Œå®žçŽ°éšè”½çš„å‡½æ•°åœ°å€èŽ·å–ã€‚

> æŽŒæ¡è¿™ä¸€ç‚¹ï¼Œä½ å°±çœŸæ­£ç†è§£äº†â€œåå°„å¼åŠ è½½â€å’Œâ€œæ— ç—• API è§£æžâ€çš„åº•å±‚åŸºçŸ³ã€‚

**16 ä¸ªç´¢å¼•çš„å«ä¹‰**ï¼š

| ç´¢å¼• | åç§° | ç”¨é€” |
|------|------|------|
| `[0]` | Export Table | DLL å¯¼å‡ºçš„å‡½æ•°åˆ—è¡¨ï¼ˆå¦‚ `GetProcAddress` æŸ¥è¯¢ç›®æ ‡ï¼‰|
| `[1]` | Import Table | ä¾èµ–çš„ DLL åŠå¯¼å…¥å‡½æ•°ï¼ˆIATï¼‰|
| `[2]` | Resource Table | å›¾æ ‡ã€å¯¹è¯æ¡†ã€å­—ç¬¦ä¸²ã€ç‰ˆæœ¬ä¿¡æ¯ç­‰èµ„æº |
| `[3]` | Exception Table | å¼‚å¸¸å¤„ç†ä¿¡æ¯ï¼ˆå¦‚ x64 çš„ `.pdata`ï¼‰|
| `[4]` | Certificate Table | æ•°å­—ç­¾åï¼ˆæ–‡ä»¶åç§» + å¤§å°ï¼Œéž RVAï¼‰|
| `[5]` | Base Relocation Table | é‡å®šä½ä¿¡æ¯ï¼ˆç”¨äºŽ ASLRï¼‰|
| `[6]` | Debug | è°ƒè¯•ä¿¡æ¯ï¼ˆPDB è·¯å¾„ç­‰ï¼‰|
| `[7]` | Architecture | ä¿ç•™ï¼ˆåº”ä¸º 0ï¼‰|
| `[8]` | Global Ptr | ä¿ç•™ï¼ˆåº”ä¸º 0ï¼‰|
| `[9]` | TLS Table | çº¿ç¨‹å±€éƒ¨å­˜å‚¨ï¼ˆThread Local Storageï¼‰å›žè°ƒ |
| `[10]`| Load Config Table | åŠ è½½é…ç½®ï¼ˆå¦‚ CFG æŽ§åˆ¶æµé˜²æŠ¤ï¼‰|
| `[11]`| Bound Import | ç»‘å®šå¯¼å…¥ï¼ˆé¢„è§£æžåœ°å€ï¼ŒåŠ é€ŸåŠ è½½ï¼‰|
| `[12]`| IAT | å¯¼å…¥åœ°å€è¡¨ï¼ˆImport Address Tableï¼‰|
| `[13]`| Delay Import | å»¶è¿ŸåŠ è½½å¯¼å…¥è¡¨ |
| `[14]`| CLR Runtime Header | .NET ç¨‹åºçš„å…ƒæ•°æ®ï¼ˆCLI å¤´ï¼‰|
| `[15]`| Reserved | ä¿ç•™ |

> âš ï¸ æ³¨æ„ï¼š`[4] Certificate Table` çš„ `VirtualAddress` å®žé™…æ˜¯**æ–‡ä»¶åç§»**ï¼Œä¸æ˜¯ RVAï¼

---

#### ç¬¬ä¸‰éƒ¨åˆ†ï¼šSection Headersï¼ˆèŠ‚è¡¨ï¼‰

ç´§è·Ÿåœ¨ Optional Header ä¹‹åŽï¼Œæ˜¯ä¸€ä¸ªé•¿åº¦ä¸º `NumberOfSections` çš„æ•°ç»„ã€‚æ¯ä¸ªèŠ‚æè¿°ä¸€æ®µä»£ç æˆ–æ•°æ®å¦‚ä½•ä»Žç£ç›˜æ˜ å°„åˆ°å†…å­˜ã€‚

```rust
#[repr(C)]
#[derive(Clone, Copy)]
pub struct IMAGE_SECTION_HEADER {
    pub Name: [u8; 8],     // [0x00] èŠ‚åï¼ˆASCIIï¼Œå¦‚ ".text", ".rdata", ".pdata"ï¼‰
                           // ä»…ä¸ºæ ‡è¯†ï¼ŒåŠ è½½å™¨ä¸å¼ºåˆ¶ä¾èµ–ã€‚è‹¥è¶…é•¿ï¼Œå¯èƒ½ä»¥ `/æ•°å­—` å½¢å¼å¼•ç”¨å­—ç¬¦ä¸²è¡¨ã€‚

    pub Misc: IMAGE_SECTION_HEADER_0, // [0x08] Unionï¼š
                                      // - åœ¨ OBJ æ–‡ä»¶ä¸­ = PhysicalAddress
                                      // - åœ¨ EXE/DLL ä¸­ = VirtualSizeï¼ˆå†…å­˜ä¸­å®žé™…å¤§å°ï¼‰

    pub VirtualAddress: u32,   // [0x0C] èŠ‚åœ¨å†…å­˜ä¸­çš„ RVA
                               // å®žé™…åœ°å€ = ImageBase + VirtualAddress

    pub SizeOfRawData: u32,    // [0x10] èŠ‚åœ¨ç£ç›˜æ–‡ä»¶ä¸­çš„å¤§å°ï¼ˆæŒ‰ FileAlignment å¯¹é½ï¼‰
                               // å¯èƒ½å°äºŽ VirtualSizeï¼ˆå¦‚ .bssï¼‰

    pub PointerToRawData: u32, // [0x14] èŠ‚åœ¨æ–‡ä»¶ä¸­çš„åç§»ï¼ˆä»Žæ–‡ä»¶å¤´å¼€å§‹ï¼‰
                               // è‹¥ä¸º 0ï¼Œè¡¨ç¤ºè¯¥èŠ‚æ— åŽŸå§‹æ•°æ®ï¼ˆå¦‚ .bssï¼‰

    pub PointerToRelocations: u32, // [0x18] é‡å®šä½è¡¨åç§»ï¼ˆOBJ æ–‡ä»¶ç”¨ï¼ŒEXE=0ï¼‰
    pub PointerToLinenumbers: u32, // [0x1C] è¡Œå·è¡¨åç§»ï¼ˆè°ƒè¯•ç”¨ï¼Œé€šå¸¸=0ï¼‰
    pub NumberOfRelocations: u16,  // [0x20] é‡å®šä½é¡¹æ•°ï¼ˆOBJ ç”¨ï¼‰
    pub NumberOfLinenumbers: u16,  // [0x22] è¡Œå·é¡¹æ•°

    pub Characteristics: u32,      // [0x24] èŠ‚å±žæ€§ï¼ˆä½æŽ©ç ï¼‰
                                   // æƒé™æ ‡å¿—ï¼ˆå½±å“å†…å­˜é¡µä¿æŠ¤ï¼‰ï¼š
                                   // - 0x80000000 = å¯å†™ï¼ˆWriteï¼‰
                                   // - 0x40000000 = å¯è¯»ï¼ˆReadï¼‰
                                   // - 0x20000000 = å¯æ‰§è¡Œï¼ˆExecuteï¼‰
                                   // å†…å®¹ç±»åž‹æ ‡å¿—ï¼š
                                   // - 0x00000020 = åŒ…å«ä»£ç 
                                   // - 0x00000040 = åŒ…å«å·²åˆå§‹åŒ–æ•°æ®
                                   // - 0x00000080 = åŒ…å«æœªåˆå§‹åŒ–æ•°æ®
                                   // - 0x04000000 = åŒ…å«å¯¼å‡ºä¿¡æ¯
                                   // - 0x02000000 = åŒ…å«å…±äº«æ•°æ®
}
```

> ðŸ“Œ **å…³é”®æ¦‚å¿µ**ï¼š  
>
> - **RVAï¼ˆRelative Virtual Addressï¼‰**ï¼šç›¸å¯¹äºŽ `ImageBase` çš„åç§»ã€‚  
> - **File Offset vs RVA**ï¼šç£ç›˜å¸ƒå±€ï¼ˆFile Alignmentï¼‰â‰  å†…å­˜å¸ƒå±€ï¼ˆSection Alignmentï¼‰ã€‚  
> - **VirtualSize vs SizeOfRawData**ï¼šå†…å­˜ä¸­å¯èƒ½æ¯”ç£ç›˜å¤§ï¼ˆé›¶å¡«å……ï¼‰ã€‚

---

#### æ€»ç»“ï¼šWindows PE åŠ è½½æµç¨‹

å½“ Windows åŠ è½½ä¸€ä¸ª PE æ–‡ä»¶æ—¶ï¼ŒæŒ‰ä»¥ä¸‹æ­¥éª¤æ‰§è¡Œï¼š

1. **éªŒè¯ DOS Header**  
   æ£€æŸ¥ `e_magic == "MZ"`ã€‚

2. **å®šä½å¹¶éªŒè¯ NT Headers**  
   é€šè¿‡ `e_lfanew` è·³è½¬ï¼Œæ£€æŸ¥ `Signature == "PE\0\0"`ã€‚

3. **åˆ†é…è™šæ‹Ÿå†…å­˜**  
   å°è¯•åœ¨ `OptionalHeader.ImageBase` å¤„ä¿ç•™ `SizeOfImage` å¤§å°çš„å†…å­˜åŒºåŸŸã€‚

4. **æ˜ å°„èŠ‚åŒºï¼ˆSectionsï¼‰**  
   éåŽ†æ¯ä¸ª `IMAGE_SECTION_HEADER`ï¼š
   - ä»Žæ–‡ä»¶åç§» `PointerToRawData` è¯»å– `SizeOfRawData` å­—èŠ‚ã€‚
   - å†™å…¥å†…å­˜åœ°å€ `ImageBase + VirtualAddress`ã€‚
   - è‹¥ `VirtualSize > SizeOfRawData`ï¼Œå‰©ä½™éƒ¨åˆ†æ¸…é›¶ã€‚
   - æ ¹æ® `Characteristics` è®¾ç½®é¡µæƒé™ï¼ˆR/W/Xï¼‰ã€‚

5. **å¤„ç†å¯¼å…¥è¡¨ï¼ˆImport Tableï¼‰**  
   åŠ è½½æ‰€æœ‰ä¾èµ–çš„ DLLï¼Œå¹¶è§£æžå¯¼å…¥å‡½æ•°åœ°å€ï¼ˆå¡«å…¥ IATï¼‰ã€‚

6. **åº”ç”¨é‡å®šä½ï¼ˆRelocationsï¼‰**  
   è‹¥å®žé™…åŠ è½½åœ°å€ â‰  `ImageBase`ï¼Œåˆ™éåŽ†é‡å®šä½è¡¨ä¿®æ­£ç¡¬ç¼–ç åœ°å€ã€‚

7. **æ‰§è¡Œ TLS åˆå§‹åŒ–ï¼ˆå¦‚æœ‰ï¼‰**  
   è°ƒç”¨ TLS å›žè°ƒå‡½æ•°ï¼ˆå¦‚ C++ å…¨å±€æž„é€ å‡½æ•°ï¼‰ã€‚

8. **è·³è½¬åˆ°å…¥å£ç‚¹**  
   è®¾ç½®ä¸»çº¿ç¨‹çš„ RIP ä¸º `ImageBase + AddressOfEntryPoint`ï¼Œå¼€å§‹æ‰§è¡Œç¨‹åºã€‚

> âœ… **æ ¸å¿ƒæ€æƒ³**ï¼š  
> PE æ ¼å¼é€šè¿‡ **RVA + åŸºå€** å®žçŽ°åœ°å€æ— å…³æ€§ï¼Œé€šè¿‡ **èŠ‚è¡¨** è§£è€¦ç£ç›˜ä¸Žå†…å­˜å¸ƒå±€ï¼Œé€šè¿‡ **æ•°æ®ç›®å½•** æä¾›æ¨¡å—åŒ–åŠŸèƒ½ç´¢å¼•ã€‚  
> `dinvk` ç­‰åº•å±‚å·¥å…·æ­£æ˜¯åŸºäºŽè¿™äº›ç»“æž„ï¼Œå®žçŽ°æ—  API ä¾èµ–çš„æ¨¡å—éåŽ†ã€å‡½æ•°è§£æžä¸Žä»£ç æ³¨å…¥ã€‚

## PEB

```rust
pub struct PEB {
    pub InheritedAddressSpace: u8,
    pub ReadImageFileExecOptions: u8,
    pub BeingDebugged: u8,
    pub Anonymous1: PEB_0,
    pub Mutant: HANDLE,
    pub ImageBaseAddress: *mut c_void,
    pub Ldr: *mut PEB_LDR_DATA,
    pub ProcessParameters: *mut RTL_USER_PROCESS_PARAMETERS,
    pub SubSystemData: *mut c_void,
    pub ProcessHeap: *mut c_void,
    pub FastPebLock: *mut RTL_CRITICAL_SECTION,
    pub AtlThunkSListPtr: *mut SLIST_HEADER,
    pub IFEOKey: *mut c_void,
    pub Anonymous2: PEB_1,
    pub Anonymous3: PEB_2,
    pub SystemReserved: u32,
    pub AtlThunkSListPtr32: u32,
    pub ApiSetMap: *mut API_SET_NAMESPACE,
    pub TlsExpansionCounter: u32,
    pub TlsBitmap: *mut RTL_BITMAP,
    pub TlsBitmapBits: [u32; 2],
    pub ReadOnlySharedMemoryBase: *mut c_void,
    pub SharedData: *mut SILO_USER_SHARED_DATA,
    pub ReadOnlyStaticServerData: *mut c_void,
    pub AnsiCodePageData: *mut c_void,
    pub OemCodePageData: *mut c_void,
    pub UnicodeCaseTableData: *mut c_void,
    pub NumberOfProcessors: u32,
    pub NtGlobalFlag: u32,
    pub CriticalSectionTimeout: LARGE_INTEGER,
    pub HeapSegmentReserve: usize,
    pub HeapSegmentCommit: usize,
    pub HeapDeCommitTotalFreeThreshold: usize,
    pub HeapDeCommitFreeBlockThreshold: usize,
    pub NumberOfHeaps: u32,
    pub MaximumNumberOfHeaps: u32,
    pub ProcessHeaps: *mut c_void,
    pub GdiSharedHandleTable: *mut c_void,
    pub ProcessStarterHelper: *mut c_void,
    pub GdiDCAttributeList: u32,
    pub LoaderLock: *mut RTL_CRITICAL_SECTION,
    pub OSMajorVersion: u32,
    pub OSMinorVersion: u32,
    pub OSBuildNumber: u16,
    pub OSCSDVersion: u16,
    pub OSPlatformId: u32,
    pub ImageSubsystem: u32,
    pub ImageSubsystemMajorVersion: u32,
    pub ImageSubsystemMinorVersion: u32,
    pub ActiveProcessAffinityMask: usize,
    pub GdiHandleBuffer: GDI_HANDLE_BUFFER,
    pub PostProcessInitRoutine: PPS_POST_PROCESS_INIT_ROUTINE,
    pub TlsExpansionBitmap: *mut RTL_BITMAP,
    pub TlsExpansionBitmapBits: [u32; 32],
    pub SessionId: u32,
    pub AppCompatFlags: ULARGE_INTEGER,
    pub AppCompatFlagsUser: ULARGE_INTEGER,
    pub pShimData: *mut c_void,
    pub AppCompatInfo: *mut c_void,
    pub CSDVersion: UNICODE_STRING,
    pub ActivationContextData: *mut ACTIVATION_CONTEXT_DATA,
    pub ProcessAssemblyStorageMap: *mut ASSEMBLY_STORAGE_MAP,
    pub SystemDefaultActivationContextData: *mut ACTIVATION_CONTEXT_DATA,
    pub SystemAssemblyStorageMap: *mut ASSEMBLY_STORAGE_MAP,
    pub MinimumStackCommit: usize,
    pub SparePointers: *mut c_void,
    pub PatchLoaderData: *mut c_void,
    pub ChpeV2ProcessInfo: *mut c_void,
    pub Anonymous4: PEB_3,
    pub SpareUlongs: [u32; 2],
    pub ActiveCodePage: u16,
    pub OemCodePage: u16,
    pub UseCaseMapping: u16,
    pub UnusedNlsField: u16,
    pub WerRegistrationData: *mut WER_PEB_HEADER_BLOCK,
    pub WerShipAssertPtr: *mut c_void,
    pub Anonymous5: PEB_4,
    pub pImageHeaderHash: *mut c_void,
    pub Anonymous6: PEB_5,
    pub CsrServerReadOnlySharedMemoryBase: u64,
    pub TppWorkerpListLock: *mut RTL_CRITICAL_SECTION,
    pub TppWorkerpList: LIST_ENTRY,
    pub WaitOnAddressHashTable: [*mut c_void; 128],
    pub TelemetryCoverageHeader: *mut TELEMETRY_COVERAGE_HEADER,
    pub CloudFileFlags: u32,
    pub CloudFileDiagFlags: u32,
    pub PlaceholderCompatibilityMode: i8,
    pub PlaceholderCompatibilityModeReserved: [i8; 7],
    pub LeapSecondData: *mut c_void, // PLEAP_SECOND_DATA
    pub Anonymous7: PEB_6,
    pub NtGlobalFlag2: u32,
    pub ExtendedFeatureDisableMask: u64,
}
```

- èŽ·å– PEB,x64: gs:[0x60],x86: fs:[0x30]

å…³äºŽPEBæœ‰ä»¥ä¸‹éœ€è¦æ³¨æ„:  

1. **ç»“æž„ä½“ä¸é€æ˜Žæ€§**ï¼š`EPROCESS`, `ETHREAD`, `KPROCESS` ç­‰å†…æ ¸ç»“æž„ä½“æ˜¯ **éžå…¬å¼€ (Opaque)** çš„ã€‚å¾®è½¯ä»Žæœªä¿è¯å…¶æˆå‘˜åç§»é‡ï¼ˆOffsetsï¼‰çš„ç¨³å®šæ€§ã€‚æ–‡ä¸­æ ‡è®°çš„åç§»é‡ä»…ä¸ºç¤ºä¾‹æˆ–ç‰¹å®šåŽ†å²ç‰ˆæœ¬ï¼Œå®žæˆ˜ä¸­**å¿…é¡»**é€šè¿‡ç¬¦å·æ–‡ä»¶ (`.pdb`) æˆ–è¿è¡Œæ—¶ç‰¹å¾ç æœç´¢åŠ¨æ€èŽ·å–ã€‚
2. **ASLR (åœ°å€ç©ºé—´å¸ƒå±€éšæœºåŒ–)**ï¼šçŽ°ä»£ Windows (Vista+) å¼ºåˆ¶å¼€å¯ ASLRã€‚æ–‡ä¸­å‡ºçŽ°çš„å†…å­˜åœ°å€ä»…ä¸º**é€»è¾‘ç¤ºæ„**ï¼Œå®žé™…è¿è¡Œæ—¶åŸºå€ã€å †æ ˆåœ°å€æ¯æ¬¡å¯åŠ¨å‡ä¸åŒã€‚
3. **æž¶æž„é™å®š**ï¼šæœ¬æ–‡æ ¸å¿ƒæè¿° **x64 (AMD64)** æž¶æž„ä¸‹çš„ Windows è¿è¡Œæœºåˆ¶ã€‚(Intel 64ã€AMD64 å’Œ x86_64æŒ‡çš„æ˜¯åŒä¸€ç§æŒ‡ä»¤é›†æž¶æž„,Windows æ“ä½œç³»ç»Ÿåœ¨åº•å±‚é€šå¸¸ç»Ÿä¸€ä½¿ç”¨ AMD64 æ¥æ ‡è¯† 64ä½æž¶æž„ï¼Œæ— è®ºä½ çš„ CPU æ˜¯ Intel è¿˜æ˜¯ AMD ç”Ÿäº§çš„ã€‚)
4. åœ¨ Windows ä¸­ï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½æœ‰ä¸€ä¸ª PEB (Process Environment Block).è¿›ç¨‹ï¼ˆProcessï¼‰åœ¨ Windowså†…æ ¸å¯¹è±¡ï¼ˆEPROCESSï¼‰çš„å®šä¹‰ä¸­ï¼Œå°±æ˜¯èµ„æºå’Œåœ°å€ç©ºé—´çš„å®¹å™¨ã€‚è€Œ PEBæ˜¯è¿™ä¸ªå®¹å™¨åœ¨ç”¨æˆ·æ¨¡å¼ï¼ˆUser Modeï¼‰ä¸‹çš„ç®¡ç†ç»“æž„ã€‚å½“å†…æ ¸åˆ›å»ºä¸€ä¸ªæ–°è¿›ç¨‹æ—¶ï¼ˆNtCreateUserProcessï¼‰ï¼Œå®ƒå¿…é¡»åœ¨åˆ†é…çš„è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­æ˜ å°„å¹¶åˆå§‹åŒ–ä¸€ä¸ª PEBã€‚æ²¡æœ‰ PEBï¼Œntdll.dll æ— æ³•åˆå§‹åŒ–ï¼Œç”¨æˆ·æ¨¡å¼çš„ä»£ç ï¼ˆåŒ…æ‹¬ mainå‡½æ•°ï¼‰æ ¹æœ¬æ— æ³•å¼€å§‹æ‰§è¡Œã€‚

### ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶äº§ç”Ÿå¤šä¸ªè¿›ç¨‹æ—¶PEBæ˜¯æ€Žä¹ˆæ ·çš„?

ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶äº§ç”Ÿå¤šä¸ªè¿›ç¨‹,ä½†è¿™ä¸æ”¹å˜â€œæ¯ä¸ªè¿›ç¨‹æœ‰ä¸€ä¸ª PEBâ€çš„äº‹å®žã€‚

ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶äº§ç”Ÿäº†å¤šä¸ªè¿›ç¨‹ï¼Œæƒ…å†µå¦‚ä¸‹ï¼š  

1. å¤šå¼€ï¼ˆMultiple Instancesï¼‰:å¤šæ¬¡æ‰“å¼€åŒä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶.ç³»ç»Ÿåˆ›å»ºäº†ä¸¤ä¸ªå®Œå…¨ç‹¬ç«‹çš„è¿›ç¨‹ï¼ˆPID 1001 å’Œ PID 1002ï¼‰.PEB: å®ƒä»¬å„è‡ªæ‹¥æœ‰è‡ªå·±ç‹¬ç«‹çš„ PEBã€‚è™½ç„¶å®ƒä»¬æ¥è‡ªåŒä¸€ä¸ª .exeæ–‡ä»¶ï¼Œä½†å®ƒä»¬åœ¨å†…å­˜ä¸­æ˜¯ä¸¤ä¸ªäº’ä¸ç›¸å¹²çš„ä¸–ç•Œã€‚
2. çˆ¶å­è¿›ç¨‹ï¼ˆSpawning Child Processesï¼‰:åœ¨ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ä¸­,è°ƒç”¨ CreateProcess("myapp.exe") è‡ªæˆ‘å¤åˆ¶.ç»“æžœ: ä¸€ä¸ªçˆ¶è¿›ç¨‹ï¼Œä¸€ä¸ªå­è¿›ç¨‹ã€‚ PEB: ä¾ç„¶æ˜¯ä¸¤ä¸ªç‹¬ç«‹çš„ PEBã€‚
3. å¤šçº¿ç¨‹ï¼ˆMulti-threadingï¼‰:è¿™æ˜¯æœ€å®¹æ˜“æ··æ·†çš„ã€‚ä¸€ä¸ªè¿›ç¨‹å¯ä»¥åŒ…å«å¤šä¸ªçº¿ç¨‹ã€‚ç»“æžœ: 1 ä¸ªè¿›ç¨‹ï¼ŒN ä¸ªçº¿ç¨‹ã€‚PEB: æ‰€æœ‰è¿™ N ä¸ªçº¿ç¨‹å…±äº«åŒä¸€ä¸ª PEBï¼ˆå› ä¸ºå®ƒä»¬å±žäºŽåŒä¸€ä¸ªè¿›ç¨‹ï¼‰ TEB: æ¯ä¸ªçº¿ç¨‹æ‹¥æœ‰è‡ªå·±ç‹¬ç«‹çš„ TEB (Thread Environment Block)ã€‚

æ— è®ºä¸€ä¸ª .exe å¯åŠ¨äº†å¤šå°‘æ¬¡ï¼Œæˆ–è€…å®ƒè‡ªå·±åˆæ´¾ç”Ÿäº†å¤šå°‘å­è¿›ç¨‹ï¼Œåªè¦é‚£æ˜¯ Windowsä¸Šçš„ä¸€ä¸ªæ ‡å‡† Win32 è¿›ç¨‹ï¼Œå®ƒå°±ä¸€å®šæ‹¥æœ‰ä¸€ä¸ªå±žäºŽå®ƒè‡ªå·±çš„ã€ç‹¬ä¸€æ— äºŒçš„ PEBã€‚

### LDR

Ldr æ˜¯ä¸€ä¸ªæŒ‡å‘ PEB_LDR_DATA ç»“æž„ä½“çš„æŒ‡é’ˆ (*mut PEB_LDR_DATA)ã€‚

å®ƒæŒ‡å‘äº†å…³äºŽè¿›ç¨‹å·²åŠ è½½æ¨¡å—ï¼ˆå¦‚ DLLsï¼‰çš„è¯¦ç»†ä¿¡æ¯ã€‚æ“ä½œç³»ç»ŸåŠ è½½å™¨ï¼ˆLoaderï¼‰ä½¿ç”¨è¿™ä¸ªç»“æž„æ¥ç»´æŠ¤æ‰€æœ‰åŠ è½½åˆ°è¯¥è¿›ç¨‹åœ°å€ç©ºé—´çš„æ¨¡å—é“¾è¡¨ã€‚

- Rust ç±»åž‹: åœ¨ dinvk ä¸­ï¼Œå®ƒè¢«å®šä¹‰ä¸ºè£¸æŒ‡é’ˆï¼Œæ„å‘³ç€è®¿é—®å®ƒéœ€è¦ä½¿ç”¨unsafe ä»£ç å—ã€‚

### PEB_LDR_DATA

```rust
#[repr(C)]
pub struct PEB_LDR_DATA {
    pub Length: u32,
    pub Initialized: u8,
    pub SsHandle: HANDLE,
    pub InLoadOrderModuleList: LIST_ENTRY,
    pub InMemoryOrderModuleList: LIST_ENTRY,
    pub InInitializationOrderModuleList: LIST_ENTRY,
    pub EntryInProgress: *mut c_void,
    pub ShutdownInProgress: u8,
    pub ShutdownThreadId: HANDLE,
}
```

æ˜¯ Windows æ“ä½œç³»ç»Ÿå†…éƒ¨ç”¨äºŽæè¿°æ¯ä¸€ä¸ªå·²åŠ è½½æ¨¡å—ï¼ˆDLL æˆ– EXEï¼‰çš„å…ƒæ•°æ®ç»“æž„  
é€šè¿‡PEBä¸­çš„ä¸€ä¸ª`pub Ldr: *mut PEB_LDR_DATA,`å­—æ®µæŒ‡å‘PEB_LDR_DATAè¿™ä¸ªç»“æž„

### InMemoryOrderModuleList

`InMemoryOrderModuleList` å¹¶éžå¦‚å…¶åç§°æš—ç¤ºçš„é‚£æ ·"æŒ‰å†…å­˜åœ°å€é«˜ä½ŽæŽ’åº"ï¼Œè¿™æ˜¯ä¸€ä¸ªåœ¨å®‰å…¨ç ”ç©¶å’Œé€†å‘å·¥ç¨‹ç¤¾åŒºä¸­å¹¿æ³›æµä¼ çš„è¯¯è§£ã€‚  
å®žé™…ä¸Šï¼Œè¿™ä¸ªé“¾è¡¨ä¸»è¦åæ˜ **æ¨¡å—åœ¨å†…å­˜ä¸­çš„å¸ƒå±€é¡ºåºå’Œåˆå§‹åŒ–å…³ç³»**ï¼Œè€Œéžç®€å•çš„åœ°å€é«˜ä½ŽæŽ’åºã€‚

InMemoryOrderModuleListçš„ç»“æž„ä½“ä¸­åªæœ‰ä¸¤ä¸ªæŒ‡é’ˆ Flink (å‰å‘) å’Œ Blink (åŽå‘)ï¼Œä¸åŒ…å« DLL ä¿¡æ¯  
åŒæ ·éœ€è¦æ³¨æ„InMemoryOrderModuleList.flinkæŒ‡å‘çš„æ˜¯LDR_DATA_TABLE_ENTRYè¿™ä¸ªç»“æž„ä½“çš„**ä¸­é—´ä½ç½®(ä¸æ˜¯ç¬¬ä¸€ä¸ªå­—æ®µ)**,å³æ˜¯ä¸€ç§æ‰‹æ‹‰æ‰‹çš„åŒå‘é“¾è¡¨,è€Œä¸æ˜¯æ‰‹æ‹‰å¤´çš„åŒå‘é“¾è¡¨:

Windows å°† `LIST_ENTRY` **åµŒå…¥**åˆ° `LDR_DATA_TABLE_ENTRY` ç»“æž„ä½“ä¸­ï¼ˆé€šå¸¸åœ¨åç§» `0x10` å¤„ä¸º `InMemoryOrderLinks`ï¼‰ã€‚  
å› æ­¤ï¼Œå½“ä½ æ‹¿åˆ° `Flink` æŒ‡é’ˆæ—¶ï¼Œå®ƒæŒ‡å‘çš„æ˜¯ç›®æ ‡ç»“æž„ä½“å†…éƒ¨çš„ `InMemoryOrderLinks` å­—æ®µï¼ˆåç§» `0x10`ï¼‰ï¼Œè€Œéžç»“æž„ä½“èµ·å§‹åœ°å€ã€‚

- Flink æŒ‡å‘çš„æ˜¯ä¸‹ä¸€ä¸ªæ¨¡å—ç»“æž„ä½“ä¸­å¯¹åº”çš„é‚£ä¸ª `InMemoryOrderLinks`å­—æ®µçš„åœ°å€ã€‚
- å®ƒä¸æŒ‡å‘ä¸‹ä¸€ä¸ªç»“æž„ä½“çš„å¤´éƒ¨ (Base)ã€‚

InMemoryOrderModuleList,åœ¨å®žé™…çš„è¿è¡Œä¸­,æ ¹æ®Windows åŠ è½½å™¨åˆå§‹åŒ–æ¨¡å—çš„é¡ºåºæ˜¯é›·æ‰“ä¸åŠ¨çš„ï¼š

- Headï¼šé“¾è¡¨å¤´ï¼ˆPEB_LDR_DATA å†…éƒ¨ï¼‰ã€‚
- Node 1ï¼šä¸»ç¨‹åº (.exe)ï¼ˆç¬¬ä¸€ä¸ªåŠ è½½ï¼‰ã€‚
- Node 2ï¼šntdll.dllï¼ˆç¬¬äºŒä¸ªåŠ è½½ï¼Œè´Ÿè´£ç”¨æˆ·å±‚ä¸Žå†…æ ¸å±‚çš„äº¤äº’ï¼‰ã€‚
- Node 3ï¼škernel32.dllï¼ˆé€šå¸¸æƒ…å†µï¼‰ã€‚
- ä»£ç é€»è¾‘ï¼šä»Ž Head å¼€å§‹ï¼Œæ‰§è¡Œä¸¤æ¬¡ Flink è·³è½¬ï¼Œç†åº”åˆ°è¾¾ntdll.dllã€‚ä¸ºäº†ä¿é™©ï¼Œä»£ç è¿˜è®¡ç®—äº†æ¨¡å—åçš„ Hash è¿›è¡Œæ ¡éªŒã€‚

### LDR_DATA_TABLE_ENTRY

```rust
#[repr(C)]
//ä¸Žvergä¸­_LDR_DATA_TABLE_ENTRYç›¸å¯¹åº”
pub struct LDR_DATA_TABLE_ENTRY {
    pub Reserved1: [*mut c_void; 2],//è¯¥å­—æ®µå¤§å°16å­—èŠ‚,å› ä¸ºåœ¨repr(c)æ¨¡å¼ä¸‹64 bit osä¸€ä¸ªæŒ‡é’ˆå ç”¨8å­—èŠ‚
    pub InMemoryOrderLinks: LIST_ENTRY,
    pub Reserved2: [*mut c_void; 2],
    pub DllBase: *mut c_void,
    pub Reserved3: [*mut c_void; 2],
    pub FullDllName: UNICODE_STRING,
    pub Reserved4: [u8; 8],
    pub Reserved5: [*mut c_void; 3],
    pub Anonymous: LDR_DATA_TABLE_ENTRY_0,
    pub TimeDateStamp: u32,
}
```

æ˜¯ Windowsæ“ä½œç³»ç»ŸåŠ è½½å™¨ï¼ˆLoaderï¼‰ç”¨æ¥ç®¡ç†æ¯ä¸€ä¸ªå·²åŠ è½½æ¨¡å—ï¼ˆDLL æˆ–
EXEï¼‰çš„æ ¸å¿ƒæ•°æ®ç»“æž„ã€‚  

- å®ƒä¸åœ¨ PEB ä¸­ç›´æŽ¥å®šä¹‰ï¼Œè€Œæ˜¯é€šè¿‡é“¾è¡¨ä»Ž PEB é—´æŽ¥å¯è¾¾ã€‚
- dinvk æ‰‹åŠ¨å®šä¹‰è¯¥ç»“æž„æ˜¯ä¸ºäº†**ç²¾ç¡®åŒ¹é…å†…å­˜å¸ƒå±€**ï¼Œå®žçŽ°æ—  API çš„æ¨¡å—éåŽ†ã€‚
- å¿…é¡»ä½¿ç”¨#[repr(c)],åŒ¹é…windowsçš„å†…å­˜å¸ƒå±€

ä½äºŽå †ä¸Š, å› ä¸º LDR_DATA_TABLE_ENTRY åªæ˜¯å †ä¸Šçš„æ™®é€šæ•°æ®ï¼Œçº¢é˜ŸæŠ€æœ¯ä¸­çš„ "æ–­é“¾éšè—"(Module Unlinking) å°±æ˜¯æ‰‹åŠ¨æ“ä½œ Flink å’Œ BlinkæŒ‡é’ˆï¼ŒæŠŠè‡ªå·±ä»Žé“¾è¡¨ä¸­ç§»é™¤ï¼Œä½†ä¸é‡Šæ”¾å†…å­˜ã€‚è¿™æ · FreeLibrary æ— æ³•å¸è½½å®ƒï¼Œä¸”éåŽ† PEBçš„å·¥å…·ï¼ˆå¦‚ä»»åŠ¡ç®¡ç†å™¨ï¼‰ä¹Ÿçœ‹ä¸åˆ°å®ƒã€‚

å¹¶å‘å®‰å…¨: Windows åŠ è½½å™¨åœ¨æ“ä½œè¿™äº›é“¾è¡¨æ—¶ä¼šæŒæœ‰ PEB->LoaderLock (ä¹Ÿå°±æ˜¯LdrLockLoaderLock)ã€‚å¦‚æžœåœ¨ä½ çš„ Rustä»£ç ä¸­æ‰‹åŠ¨éåŽ†è¿™äº›é“¾è¡¨ä¸”ä¸èŽ·å–é”ï¼Œç†è®ºä¸Šå­˜åœ¨ç«žäº‰æ¡ä»¶ï¼ˆè™½ç„¶åœ¨å•çº¿ç¨‹ Shellcodeä¸­é€šå¸¸å¿½ç•¥ä¸è®¡ï¼‰ã€‚

#### LDR_DATA_TABLE_ENTRYå¦‚ä½•äº§ç”Ÿå¹¶ç»´æŠ¤?

LDR_DATA_TABLE_ENTRY ç»“æž„ä½“å®Œå…¨ç”± Windows ç”¨æˆ·æ¨¡å¼åŠ è½½å™¨ (User Mode Loader) äº§ç”Ÿå’Œç»´æŠ¤ï¼Œå…·ä½“å®žçŽ°ä½äºŽ `ntdll.dll` ä¸­ã€‚

å®ƒä¸æ˜¯å†…æ ¸å¯¹è±¡ï¼Œè€Œæ˜¯å­˜åœ¨äºŽè¿›ç¨‹ç§æœ‰å †ï¼ˆProcess Heapï¼‰ä¸­çš„æ™®é€šæ•°æ®ç»“æž„ã€‚è¿™æ„å‘³ç€æ‹¥æœ‰è¯¥è¿›ç¨‹æƒé™çš„ä»£ç ï¼ˆåŒ…æ‹¬ä½ çš„ dinvké¡¹ç›®ï¼‰å¯ä»¥éšæ„è¯»å–ç”šè‡³ä¿®æ”¹å®ƒã€‚  
ä»¥ä¸‹æ˜¯å…¶ç”Ÿå‘½å‘¨æœŸçš„è¯¦ç»†è¿‡ç¨‹ï¼š

##### äº§ç”Ÿ (Creation)

å½“ä¸€ä¸ªæ¨¡å—ï¼ˆ.exe æˆ– .dllï¼‰è¢«æ˜ å°„åˆ°è¿›ç¨‹å†…å­˜æ—¶ï¼Œntdll.dllä¸­çš„åŠ è½½å™¨ä»£ç ä¼šåˆ›å»ºè¿™ä¸ªç»“æž„ã€‚

- é™æ€å¯¼å…¥ (è¿›ç¨‹å¯åŠ¨æ—¶):
å½“è¿›ç¨‹åˆšå¯åŠ¨ï¼Œå†…æ ¸å®ŒæˆåŸºæœ¬çš„å†…å­˜æ˜ å°„åŽï¼Œæ‰§è¡Œæƒäº¤ç»™
ntdll!LdrInitializeThunkã€‚å®ƒä¼šè°ƒç”¨ LdrpInitializeProcessï¼Œä¸ºä»¥ä¸‹æ¨¡å—åˆ†é…å¹¶åˆå§‹åŒ–LDR_DATA_TABLE_ENTRYï¼š

1. è‡ªèº« (ntdll.dll)
2. ä¸»æ‰§è¡Œæ–‡ä»¶ (.exe)
3. é™æ€å¯¼å…¥è¡¨ä¸­çš„æ‰€æœ‰ DLL (å¦‚ kernel32.dll)

- åŠ¨æ€åŠ è½½ (è¿è¡Œæ—¶):
å½“ä½ è°ƒç”¨ LoadLibrary (Win32 API) æ—¶ï¼Œè°ƒç”¨é“¾å¦‚ä¸‹ï¼š  
LoadLibraryW -> KernelBase!LoadLibraryExW -> ntdll!LdrLoadDll ->`ntdll!LdrpLoadDll`  

åœ¨ LdrpLoadDll å†…éƒ¨ï¼ˆå…·ä½“å‡½æ•°åéš Windows ç‰ˆæœ¬å¯èƒ½å˜åŒ–ï¼Œå¦‚LdrpAllocateDataTableEntryï¼‰ï¼ŒåŠ è½½å™¨ä¼šæ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š

1. è°ƒç”¨ RtlAllocateHeap ä»Žè¿›ç¨‹é»˜è®¤å †ä¸­åˆ†é…ä¸€å—å†…å­˜ï¼Œå¤§å°ä¸ºsizeof(LDR_DATA_TABLE_ENTRY)ã€‚
2. å¡«å……ç»“æž„ä½“å­—æ®µï¼š

- DllBase: å¡«å…¥æ¨¡å—æ˜ å°„çš„åŸºå€ã€‚
- FullDllName / BaseDllName: åˆ†é…å¹¶å¡«å…¥è·¯å¾„å­—ç¬¦ä¸²ã€‚
- LoadCount: åˆå§‹åŒ–å¼•ç”¨è®¡æ•°ã€‚

1. è°ƒç”¨ LdrpInsertDataTableEntry å°†è¿™ä¸ªæ–°èŠ‚ç‚¹æ’å…¥åˆ° PEB->Ldr çš„ä¸‰ä¸ªé“¾è¡¨ä¸­(InLoadOrder, InMemoryOrder, InInitializationOrder)ã€‚

##### ç»´æŠ¤ (Maintenance)

åœ¨æ¨¡å—çš„ç”Ÿå‘½å‘¨æœŸå†…ï¼Œntdll.dll è´Ÿè´£ç»´æŠ¤å…¶çŠ¶æ€ï¼š

- å¼•ç”¨è®¡æ•° (`LoadCount`):  
å¦‚æžœåŒä¸€ä¸ª DLL è¢« LoadLibrary åŠ è½½å¤šæ¬¡ï¼ŒåŠ è½½å™¨ä¸ä¼šé‡æ–°æ˜ å°„æ–‡ä»¶ï¼Œè€Œæ˜¯æ‰¾åˆ°çŽ°æœ‰çš„LDR_DATA_TABLE_ENTRYï¼Œå°†å…¶ LoadCount åŠ  1ã€‚
- é‡å®šä½ä¸Žä¿®å¤:  
åŠ è½½å™¨ä¼šæ›´æ–°ç»“æž„ä¸­çš„æ ‡è®°ï¼ˆFlagsï¼‰ï¼Œè¡¨æ˜Žè¯¥æ¨¡å—æ˜¯å¦å·²å®Œæˆé‡å®šä½ã€æ˜¯å¦å·²æ‰§è¡Œ TLSå›žè°ƒç­‰ã€‚

##### é”€æ¯ (Destruction)

å½“ä½ è°ƒç”¨ `FreeLibrary` æ—¶ï¼ŒWindows åŠ è½½å™¨ä¼šæ‰§è¡Œä»¥ä¸‹å¸è½½æµç¨‹ï¼š

1. **è°ƒç”¨ `ntdll!LdrUnloadDll`**  
   ç”¨æˆ·æ€çš„ `FreeLibrary` æœ€ç»ˆä¼šè¿›å…¥å†…æ ¸æ¨¡å¼åŠ è½½å™¨å‡½æ•° `LdrUnloadDll`ã€‚

2. **é€’å‡å¼•ç”¨è®¡æ•°**  
   åŠ è½½å™¨å°†ç›®æ ‡æ¨¡å—å¯¹åº”çš„ `LDR_DATA_TABLE_ENTRY` ä¸­çš„ `LoadCount` å­—æ®µå‡ 1ã€‚

3. **æ£€æŸ¥æ˜¯å¦çœŸæ­£å¸è½½**  
   å¦‚æžœ `LoadCount` é™ä¸º 0ï¼ˆä¸”è¯¥ DLL æœªè¢«æ ‡è®°ä¸ºâ€œæ°¸ä¹…åŠ è½½â€çš„ç³»ç»Ÿæ¨¡å—ï¼Œå¦‚ `ntdll.dll`ï¼‰ï¼Œåˆ™å¯åŠ¨å®Œæ•´çš„å¸è½½æµç¨‹ï¼š
   - **æ‰§è¡Œ `DllMain` å›žè°ƒ**  
     è°ƒç”¨è¯¥ DLL çš„å…¥å£ç‚¹å‡½æ•°ï¼Œå¹¶ä¼ å…¥ `DLL_PROCESS_DETACH` é€šçŸ¥å…¶å³å°†è¢«å¸è½½ã€‚
   - **ä»Žæ¨¡å—é“¾è¡¨ä¸­ç§»é™¤èŠ‚ç‚¹ï¼ˆUnlinkï¼‰**  
     å°†è¯¥ `LDR_DATA_TABLE_ENTRY` ä»Ž PEB ä¸­çš„ä¸‰æ¡é“¾è¡¨ä¸­æ‘˜é™¤ï¼š
     - `InLoadOrderModuleList`
     - `InMemoryOrderModuleList`
     - `InInitializationOrderModuleList`
   - **é‡Šæ”¾å­—ç¬¦ä¸²èµ„æº**  
     é‡Šæ”¾ `FullDllName` å’Œ `BaseDllName` ç­‰ `UNICODE_STRING` æ‰€æŒ‡å‘çš„åŠ¨æ€åˆ†é…å†…å­˜ã€‚
   - **é‡Šæ”¾å…ƒæ•°æ®ç»“æž„**  
     è°ƒç”¨ `RtlFreeHeap` é‡Šæ”¾ `LDR_DATA_TABLE_ENTRY` ç»“æž„ä½“æœ¬èº«æ‰€å ç”¨çš„å †å†…å­˜ã€‚
   - **è§£é™¤å†…å­˜æ˜ å°„**  
     è°ƒç”¨å†…å­˜ç®¡ç†å™¨è§£é™¤å¯¹è¯¥ DLL æ˜ åƒçš„å†…å­˜æ˜ å°„ï¼ˆå³ä»Žè¿›ç¨‹åœ°å€ç©ºé—´ä¸­ç§»é™¤å…¶ä»£ç å’Œæ•°æ®æ®µï¼‰ã€‚

> ðŸ’¡ æ³¨æ„ï¼šå¦‚æžœ `LoadCount > 0`ï¼Œä»…é€’å‡è®¡æ•°ï¼Œ**ä¸ä¼šæ‰§è¡Œå®žé™…å¸è½½**ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆå¤šæ¬¡è°ƒç”¨ `LoadLibrary` éœ€è¦å¯¹åº”å¤šæ¬¡ `FreeLibrary` æ‰èƒ½çœŸæ­£å¸è½½æ¨¡å—ã€‚

- ä¸ºä»€ä¹ˆåœ¨ PEB ä¸­â€œæ²¡æœ‰ç›´æŽ¥çœ‹åˆ°â€å®ƒï¼Ÿ(ä¸æ˜¯PEBçš„å­—æ®µä¹‹ä¸€)

ä½ å…¶å®žå·²ç»åœ¨ PEB ä¸­æ‰¾åˆ°äº†å®ƒçš„å…¥å£ï¼Œåªæ˜¯å®ƒä»¥**é“¾è¡¨èŠ‚ç‚¹**çš„å½¢å¼å­˜åœ¨ï¼Œè€Œä¸æ˜¯ç›´æŽ¥å†…åµŒåœ¨ PEB ä¸­ã€‚  
å†…å­˜ç»“æž„ç¤ºæ„ï¼š

```text
[ TEB ]
  |
  +-> [ PEB ]
        |
        +-> Ldr (æŒ‡å‘ PEB_LDR_DATA)
              |
              +-> InMemoryOrderModuleList (LIST_ENTRY é“¾è¡¨å¤´)
                    |
                    v
              [ LDR_DATA_TABLE_ENTRY A ] <-> [ LDR_DATA_TABLE_ENTRY B ] <-> ...
                    ^                          ^
                    |                          |
              LIST_ENTRY èŠ‚ç‚¹           LIST_ENTRY èŠ‚ç‚¹
```

æ ‡å‡† Windows SDKï¼ˆå¦‚ `windows-sys`ï¼‰é€šå¸¸**ä¸å…¬å¼€å®Œæ•´å­—æ®µ**ï¼ŒåŽŸå› åŒ…æ‹¬ï¼š

- å¾®è½¯å°†å…¶è§†ä¸ºâ€œå†…éƒ¨å®žçŽ°ç»†èŠ‚â€ï¼ˆUndocumentedï¼‰
- ä¸ºå…¼å®¹æ€§éšè—éƒ¨åˆ†å­—æ®µ
- ä¸åŒ Windows ç‰ˆæœ¬ç»“æž„å¯èƒ½å˜åŒ–

å› æ­¤ï¼Œdinvk åœ¨ `src/types.rs` ä¸­**æ‰‹åŠ¨å®šä¹‰**äº†ä¸€ä¸ªä¸ŽçœŸå®žå†…å­˜å¸ƒå±€ä¸€è‡´çš„ç‰ˆæœ¬

### ImageBaseAddress

ImageBaseAddress æ˜¯ PEB ç»“æž„ä½“ä¸­çš„ä¸€ä¸ªé‡è¦å­—æ®µï¼ˆé€šå¸¸åœ¨åç§» 0x10 å¤„ï¼‰

- å®ƒå­˜å‚¨äº†å½“å‰è¿›ç¨‹çš„ä¸»æ¨¡å—ï¼ˆä¹Ÿå°±æ˜¯å¯åŠ¨è¿™ä¸ªè¿›ç¨‹çš„ .exeæ–‡ä»¶ï¼‰è¢«åŠ è½½åˆ°å†…å­˜ä¸­çš„èµ·å§‹ä½ç½®ã€‚
- å¯¹äºŽå¤§å¤šæ•° 64 ä½ç¨‹åºï¼Œé»˜è®¤æƒ…å†µä¸‹è¿™ä¸ªåœ°å€å¯èƒ½æ˜¯0x140000000ï¼Œæˆ–è€…æ˜¯å› ASLRï¼ˆåœ°å€ç©ºé—´å¸ƒå±€éšæœºåŒ–ï¼‰è€Œéšæœºç”Ÿæˆçš„æŸä¸ªåœ°å€ã€‚

## let mut data_table_entry = (*ldr_data).InMemoryOrderModuleList.Flink as*const LDR_DATA_TABLE_ENTRY

è¿™é‡Œçš„asæœ‰ç‚¹å¤æ‚,asè½¬æ¢ç›´æŽ¥æŠŠè£¸åœ°å€å˜æˆäº†å¯æ“ä½œçš„ç»“æž„ä½“å¯¹è±¡ã€‚åªè¦åœ°å€æ•°å€¼æ­£ç¡®ï¼Œä¸”ç»“æž„ä½“å¸ƒå±€åŒ¹é…ï¼Œä½ å°±å¯ä»¥ç›´æŽ¥åƒæ“ä½œæ™®é€šå¯¹è±¡ä¸€æ ·è§£å¼•ç”¨å’Œè®¿é—®å­—æ®µã€‚

### ç‰©ç†äº‹å®ž (Memory Reality)

- Flink æŒ‡é’ˆé‡Œå­˜çš„æ•°å€¼æ˜¯ `0x1000`ï¼ˆå‡è®¾è¿™æ˜¯æŸä¸ªæ¨¡å— `InMemoryOrderLinks` çš„åœ°å€ï¼‰ã€‚
- ç”±äºŽ `InMemoryOrderLinks` åœ¨è¯¥æ¨¡å—çœŸæ­£çš„èµ·å§‹ä½ç½®ï¼ˆ`0x0F90`ï¼‰å¾€åŽ 16 å­—èŠ‚å¤„ï¼Œæ‰€ä»¥ç‰©ç†åœ°å€å°±æ˜¯ `0x1000`ã€‚

### ç¼–è¯‘å™¨çš„â€œé”™è§‰â€ (Compiler's View)

å½“ä½ æ‰§è¡Œ `as *const LDR_DATA_TABLE_ENTRY` æ—¶ï¼š

- **æŒ‡ä»¤å±‚é¢**ï¼šè¿™è¡Œä»£ç åœ¨ç”Ÿæˆçš„æ±‡ç¼–é‡Œé€šå¸¸ä¸äº§ç”Ÿä»»ä½•æŒ‡ä»¤ï¼Œå®ƒåªæ˜¯æ”¹å˜äº†ç¼–è¯‘å™¨è´¦æœ¬ä¸Šçš„ä¸€ä¸ªæ ‡è®°ã€‚
- **è®¤çŸ¥å±‚é¢**ï¼šä½ å‘Šè¯‰ç¼–è¯‘å™¨ï¼šâ€œä»ŽçŽ°åœ¨å¼€å§‹ï¼ŒæŠŠ `0x1000` è¿™ä¸ªåœ°å€çœ‹ä½œæ˜¯ `LDR_DATA_TABLE_ENTRY` ç»“æž„ä½“çš„ç¬¬ 0 ä¸ªå­—èŠ‚ã€‚â€

### ç»“æžœï¼šåç§»é‡çš„â€œå¹³ç§»â€

å› ä¸ºç¼–è¯‘å™¨è®¤ä¸º `0x1000` æ˜¯ `0x00`ï¼Œé‚£ä¹ˆå½“ä½ åœ¨ä»£ç é‡Œè®¿é—®æŸä¸ªå­—æ®µï¼ˆæ¯”å¦‚åç§»ä¸º `0x48` çš„å­—æ®µï¼‰æ—¶ï¼š

- **ç¼–è¯‘å™¨è®¡ç®—**ï¼šå½“å‰ä½ç½® (`0x1000`) + å­—æ®µåç§» (`0x48`) = `0x1048`ã€‚
- **ç‰©ç†å¯¹æ¯”**ï¼šåœ¨çœŸå®žçš„å†…å­˜å¸ƒå±€ä¸­ï¼Œ`0x1048` å¯¹åº”çš„æ˜¯çœŸå®žå¤´éƒ¨ (`0x0F90`) + `0x58`ã€‚
- **ç¥žå¥‡å‘çŽ°**ï¼š`0x58` å¤„æ­£å¥½å°±æ˜¯æˆ‘ä»¬è¦æ‰¾çš„é‚£ä¸ªæ•°æ®å­—æ®µï¼

### æ€»ç»“

- â€œæŒ‡å‘...åç§»ä½ç½® (`0x10`)â€ï¼šè¿™æ˜¯ç‰©ç†äº‹å®žï¼ŒæŒ‡é’ˆç¡®å®žæŒ‡åœ¨äººå®¶ç»“æž„ä½“çš„â€œè‚šå­â€ä¸Šã€‚
- â€œç¼–è¯‘å™¨çœ‹æ¥ä»ç„¶æ˜¯æŒ‡å‘...ç¬¬ 0 ä¸ªå­—èŠ‚å¤„â€ï¼šè¿™æ˜¯ç±»åž‹è½¬æ¢çš„ä½œç”¨ï¼Œä½ å¼ºè¿«ç¼–è¯‘å™¨ä»Žâ€œè‚šå­â€å¼€å§‹ç®—ä½œâ€œå¤´â€ã€‚

## æŒ‡ä»¤é›†æž¶æž„

é™¤äº† x86_64ï¼ˆAMD64ï¼‰ä¹‹å¤–ï¼Œè¿˜å­˜åœ¨å¤šç§ä¸»æµå’Œä¸“ç”¨çš„æŒ‡ä»¤é›†æž¶æž„ï¼ˆISAï¼‰ã€‚ä½œä¸ºä¸€å Rust å¼€å‘è€…ï¼Œäº†è§£ä»¥ä¸‹å‡ ç§æž¶æž„å°¤ä¸ºé‡è¦ï¼Œå› ä¸ºå®ƒä»¬æ˜¯ Rust äº¤å‰ç¼–è¯‘çš„å¸¸è§ç›®æ ‡ã€‚

---

### 1. ARM æž¶æž„ï¼ˆAArch64 / ARM64ï¼‰

- **ç‰¹ç‚¹**ï¼šåŸºäºŽ RISCï¼ˆç²¾ç®€æŒ‡ä»¤é›†è®¡ç®—ï¼‰ï¼ŒåŠŸè€—ä½Žï¼Œèƒ½æ•ˆæ¯”é«˜ã€‚
- **åº”ç”¨åœºæ™¯**ï¼š
  - **ç§»åŠ¨è®¾å¤‡**ï¼šå‡ ä¹Žæ‰€æœ‰çš„ Android æ‰‹æœºå’Œ iPhoneã€‚
  - **æ¡Œé¢ç«¯**ï¼šApple Siliconï¼ˆM1ã€M2ã€M3ã€M4ï¼‰ç³»åˆ—èŠ¯ç‰‡ã€‚
  - **æœåŠ¡å™¨**ï¼šAWS Graviton ç­‰é«˜æ€§èƒ½äº‘æœåŠ¡å™¨ã€‚
  - **åµŒå…¥å¼**ï¼šRaspberry Piï¼ˆæ ‘èŽ“æ´¾ï¼‰ã€‚
- **Rust ç›®æ ‡ä¸‰å…ƒç»„ç¤ºä¾‹**ï¼š
  - `aarch64-unknown-linux-gnu`
  - `aarch64-apple-darwin`

---

### 2. RISC-V

- **ç‰¹ç‚¹**ï¼šå®Œå…¨å¼€æºã€å…è´¹ã€æ¨¡å—åŒ–çš„ RISC æž¶æž„ã€‚å…è®¸ä»»ä½•äººè®¾è®¡ã€åˆ¶é€ å’Œé”€å”® RISC-V èŠ¯ç‰‡è€Œæ— éœ€æ”¯ä»˜ä¸“åˆ©è´¹ï¼Œè¢«èª‰ä¸ºâ€œèŠ¯ç‰‡ç•Œçš„ Linuxâ€ã€‚
- **åº”ç”¨åœºæ™¯**ï¼š
  - å½“å‰ä¸»è¦ç”¨äºŽç‰©è”ç½‘ï¼ˆIoTï¼‰ã€åµŒå…¥å¼æŽ§åˆ¶å™¨ã€‚
  - æ­£åœ¨å‘æœåŠ¡å™¨å’Œé«˜æ€§èƒ½è®¡ç®—ï¼ˆHPCï¼‰é¢†åŸŸå¿«é€Ÿæ‰©å±•ã€‚
- **Rust æ”¯æŒ**ï¼š
  - å®˜æ–¹æ”¯æŒè‰¯å¥½ï¼Œä¾‹å¦‚ï¼š`riscv64gc-unknown-linux-gnu`

---

### 3. WebAssemblyï¼ˆWasmï¼‰

- **è¯´æ˜Ž**ï¼šè™½ç„¶ä¸æ˜¯ç‰©ç† CPU æž¶æž„ï¼Œä½†æ˜¯ä¸€ç§æžå…¶é‡è¦çš„**è™šæ‹ŸæŒ‡ä»¤é›†æž¶æž„**ã€‚
- **ç‰¹ç‚¹**ï¼šåŸºäºŽå †æ ˆçš„äºŒè¿›åˆ¶æŒ‡ä»¤æ ¼å¼ï¼Œè®¾è®¡ä¸ºå¯ç§»æ¤çš„ç¼–è¯‘ç›®æ ‡ã€‚
- **åº”ç”¨åœºæ™¯**ï¼š
  - åœ¨æµè§ˆå™¨ä¸­ä»¥æŽ¥è¿‘åŽŸç”Ÿé€Ÿåº¦è¿è¡Œ Rust ä»£ç ã€‚
  - è¾¹ç¼˜è®¡ç®—ï¼ˆEdge Computingï¼‰ã€‚
  - æ’ä»¶ç³»ç»Ÿï¼ˆå¦‚ Envoy Proxyã€Fermyon Spinï¼‰ã€‚
- **Rust ç›®æ ‡ä¸‰å…ƒç»„**ï¼š
  - `wasm32-unknown-unknown`
  - `wasm32-wasi`

---

### 4. x86ï¼ˆ32-bitï¼‰/ i686

- **ç‰¹ç‚¹**ï¼šx86_64 çš„å‰èº«ï¼Œ32 ä½æž¶æž„ï¼Œå†…å­˜å¯»å€ä¸Šé™ä¸º 4GBã€‚
- **åº”ç”¨åœºæ™¯**ï¼š
  - è€æ—§ PCã€å·¥ä¸šæŽ§åˆ¶ç³»ç»Ÿã€é—ç•™åµŒå…¥å¼è®¾å¤‡ã€‚
  - è™½ç„¶çŽ°ä»£å¼€å‘å·²é€æ¸æ·˜æ±°ï¼Œä½†åœ¨å…¼å®¹æ€§ç»´æŠ¤ä¸­ä»éœ€å…³æ³¨ã€‚
- **Rust ç›®æ ‡ç¤ºä¾‹**ï¼š`i686-unknown-linux-gnu`

---

### 5. å…¶ä»–åµŒå…¥å¼ä¸Žä¸“ç”¨æž¶æž„

| æž¶æž„       | ç®€ä»‹                                                                 |
|------------|----------------------------------------------------------------------|
| **MIPS**   | æ›¾å¹¿æ³›ç”¨äºŽè·¯ç”±å™¨å’Œæœºé¡¶ç›’ï¼ŒçŽ°é€æ¸è¢« ARM å’Œ RISC-V å–ä»£ã€‚               |
| **PowerPC (PPC)** | æ›¾ç”¨äºŽè€æ¬¾ Mac å’Œæ¸¸æˆä¸»æœºï¼ˆå¦‚ PS3ã€Xbox 360ï¼‰ï¼ŒçŽ°ä¸»è¦ç”¨äºŽæ±½è½¦ç”µå­ã€èˆªå¤©ç­‰é«˜å¯é é¢†åŸŸã€‚ |
| **AVR**    | 8 ä½å¾®æŽ§åˆ¶å™¨æž¶æž„ï¼Œå…¸åž‹ä»£è¡¨æ˜¯ Arduino Unoï¼Œé€‚ç”¨äºŽæžä½ŽåŠŸè€—åµŒå…¥å¼åœºæ™¯ã€‚     |

---

### æ€»ç»“ï¼šCISC vs RISC

è®¡ç®—æœºä½“ç³»ç»“æž„ä¸»è¦åˆ†ä¸ºä¸¤å¤§æµæ´¾ï¼š

1. **CISCï¼ˆComplex Instruction Set Computingï¼Œå¤æ‚æŒ‡ä»¤é›†ï¼‰**
   - **ä»£è¡¨**ï¼šx86 / x86_64
   - **ç‰¹ç‚¹**ï¼š
     - å•æ¡æŒ‡ä»¤å¯å®Œæˆå¤æ‚æ“ä½œï¼ˆå¦‚ç›´æŽ¥å†…å­˜è¯»å†™ï¼‰ã€‚
     - ä»£ç å¯†åº¦é«˜ï¼ˆç¨‹åºä½“ç§¯å°ï¼‰ã€‚
     - ç¡¬ä»¶å®žçŽ°æžå…¶å¤æ‚ï¼Œä¾èµ–å¾®ç ï¼ˆmicrocodeï¼‰ã€‚

2. **RISCï¼ˆReduced Instruction Set Computingï¼Œç²¾ç®€æŒ‡ä»¤é›†ï¼‰**
   - **ä»£è¡¨**ï¼šARMã€RISC-V
   - **ç‰¹ç‚¹**ï¼š
     - æŒ‡ä»¤åŠŸèƒ½ç®€å•ã€å›ºå®šé•¿åº¦ã€æ‰§è¡Œé€Ÿåº¦å¿«ã€‚
     - ä¾èµ–ç¼–è¯‘å™¨ä¼˜åŒ–æ¥ç»„åˆå¤šæ¡ç®€å•æŒ‡ä»¤ã€‚
     - ç¡¬ä»¶è®¾è®¡ç®€æ´ï¼ŒåŠŸè€—ä½Žï¼Œé€‚åˆå¹¶è¡Œå’Œèƒ½æ•ˆæ•æ„Ÿåœºæ™¯ã€‚

---

> ðŸ’¡ **å¯¹ RustRedOps å¼€å‘è€…çš„æç¤º**ï¼š  
> å¦‚æžœä½ æ­£åœ¨å¼€å‘åº•å±‚çº¢é˜Ÿ/è“é˜Ÿå·¥å…·ï¼ˆå¦‚ shellcodeã€PE è§£æžå™¨ã€ç³»ç»Ÿè°ƒç”¨å°è£…ç­‰ï¼‰ï¼Œæœªæ¥å¾ˆå¯èƒ½éœ€è¦å¤„ç† **x86_64 ä¸Ž AArch64** åœ¨ä»¥ä¸‹æ–¹é¢çš„å·®å¼‚ï¼š
>
> - ç³»ç»Ÿè°ƒç”¨ç¼–å·ä¸Žçº¦å®šï¼ˆsyscall ABIï¼‰
> - å¯„å­˜å™¨å‘½åä¸Žç”¨é€”ï¼ˆå¦‚ `rax` vs `x0`ï¼‰
> - å†…å­˜é¡ºåºæ¨¡åž‹ï¼ˆMemory Orderingï¼‰
> - æŒ‡ä»¤ç¼–ç ä¸Ž Shellcode ç¼–å†™
>
> æŽŒæ¡å¤šæž¶æž„çŸ¥è¯†ï¼Œå°†æžå¤§æå‡å·¥å…·çš„å¯ç§»æ¤æ€§ä¸Žéšè”½æ€§ã€‚

## EXE æ–‡ä»¶å’Œ PE æ–‡ä»¶çš„å…³ç³»ï¼Ÿé™¤äº† EXE è¿˜æœ‰å“ªäº› PE æ–‡ä»¶ï¼Ÿ

- **PE**ï¼ˆPortable Executableï¼‰  
  æ˜¯å¾®è½¯å®šä¹‰çš„**äºŒè¿›åˆ¶æ–‡ä»¶æ ¼å¼æ ‡å‡†**ï¼Œè§„å®šäº†å¯æ‰§è¡Œæ–‡ä»¶åœ¨ç£ç›˜ä¸Šçš„ç»“æž„ä»¥åŠåŠ è½½åˆ°å†…å­˜åŽçš„å¸ƒå±€æ–¹å¼ã€‚
- **EXE**ï¼ˆ`.exe`ï¼‰  
  æ˜¯ç¬¦åˆ PE æ ¼å¼çš„ä¸€ç§**å…·ä½“æ–‡ä»¶ç±»åž‹**ï¼Œä¸“ç”¨äºŽæ ‡è¯†â€œå¯ç›´æŽ¥å¯åŠ¨å¹¶ä½œä¸ºç‹¬ç«‹è¿›ç¨‹è¿è¡Œâ€çš„ç¨‹åºã€‚

> ðŸ—ï¸ **ç±»æ¯”**ï¼š  
>
> - PE æ ‡å‡† â‰ˆ **å»ºç­‘è§„èŒƒ**ï¼ˆè§„å®šåœ°åŸºã€æ‰¿é‡å¢™ã€é—¨çª—ä½ç½®ï¼‰  
> - EXE æ–‡ä»¶ â‰ˆ **æŒ‰è§„èŒƒå»ºæˆçš„ä½å®…**ï¼ˆå¯ç›´æŽ¥å…¥ä½ï¼‰

---

### 2. é™¤äº† EXEï¼Œè¿˜æœ‰å“ªäº›å¸¸è§çš„ PE æ–‡ä»¶ï¼Ÿ

åªè¦æ˜¯ç¬¦åˆ PE ç»“æž„çš„æ–‡ä»¶ï¼Œæ— è®ºæ‰©å±•åå¦‚ä½•ï¼Œéƒ½å±žäºŽ PE å®¶æ—ã€‚å¸¸è§ç±»åž‹åŒ…æ‹¬ï¼š

#### A. åŠ¨æ€é“¾æŽ¥åº“ï¼ˆDLLï¼‰

- **`.dll`**ï¼šæœ€å¸¸è§å½¢å¼ï¼Œä¾› EXE æˆ–å…¶ä»– DLL è°ƒç”¨ï¼Œä¸èƒ½ç‹¬ç«‹å¯åŠ¨ã€‚
- **`.ocx`**ï¼šActiveX æŽ§ä»¶ï¼ˆæ—§ç‰ˆ IE ä½¿ç”¨ï¼‰ï¼Œæœ¬è´¨æ˜¯å¸¦ COM æŽ¥å£çš„ DLLã€‚
- **`.cpl`**ï¼šæŽ§åˆ¶é¢æ¿é¡¹ï¼ˆå¦‚â€œé¼ æ ‡è®¾ç½®â€ï¼‰ï¼Œæœ¬è´¨æ˜¯å¯¼å‡º `CPlApplet` å‡½æ•°çš„ DLLã€‚

#### B. é©±åŠ¨ç¨‹åºï¼ˆDriversï¼‰

- **`.sys`**ï¼šWindows å†…æ ¸æ¨¡å¼é©±åŠ¨ï¼Œç”±å†…æ ¸åŠ è½½å™¨åŠ è½½ï¼Œè¿è¡Œåœ¨ Ring 0ã€‚

#### C. å…¶ä»–ç³»ç»Ÿ/åŠŸèƒ½æ–‡ä»¶

- **`.efi`**ï¼šUEFI å›ºä»¶å¯æ‰§è¡Œæ–‡ä»¶ï¼Œç”¨äºŽç³»ç»Ÿå¼•å¯¼é˜¶æ®µã€‚
- **`.scr`**ï¼šå±å¹•ä¿æŠ¤ç¨‹åºï¼Œæœ¬è´¨æ˜¯æ”¹åçš„ EXEã€‚
- **`.mui`**ï¼šå¤šè¯­è¨€ç”¨æˆ·ç•Œé¢èµ„æºæ–‡ä»¶ã€‚
- **`.tsp`**ï¼šç”µè¯æœåŠ¡æä¾›ç¨‹åºã€‚

---

### 3. å¦‚ä½•åŒºåˆ†ä¸åŒç±»åž‹çš„ PE æ–‡ä»¶ï¼Ÿ

å°½ç®¡ç»“æž„ç›¸åŒï¼ŒWindows é€šè¿‡ **PE æ–‡ä»¶å¤´ä¸­çš„æ ‡å¿—ä½**è¿›è¡Œè¯†åˆ«ï¼š

```rust
// src/types.rs
pub struct IMAGE_FILE_HEADER {
    pub Machine: IMAGE_FILE_MACHINE,
    pub NumberOfSections: u16,
    pub TimeDateStamp: u32,
    pub PointerToSymbolTable: u32,
    pub NumberOfSymbols: u32,
    pub SizeOfOptionalHeader: u16,
    pub Characteristics: IMAGE_FILE_CHARACTERISTICS, // â† å…³é”®å­—æ®µ
}
```

å…³é”®æ ‡å¿—ä½ï¼ˆ`Characteristics`ï¼‰ï¼š

- `IMAGE_FILE_EXECUTABLE_IMAGE` (`0x0002`) â†’ å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆEXE/SCRï¼‰
- `IMAGE_FILE_DLL` (`0x2000`) â†’ åŠ¨æ€é“¾æŽ¥åº“ï¼ˆDLL/OCX/CPLï¼‰
- `IMAGE_FILE_SYSTEM` (`0x1000`) â†’ ç³»ç»Ÿæ–‡ä»¶ï¼ˆå¦‚ `.sys` é©±åŠ¨ï¼‰

æ­¤å¤–ï¼Œ**å­ç³»ç»Ÿå­—æ®µ**ï¼ˆ`Subsystem` in `IMAGE_OPTIONAL_HEADER`ï¼‰ä¹Ÿå¯ç”¨äºŽåŒºåˆ†ï¼š

- `IMAGE_SUBSYSTEM_WINDOWS_GUI` / `CONSOLE` â†’ æ™®é€š EXE
- `IMAGE_SUBSYSTEM_NATIVE` â†’ é©±åŠ¨æˆ–å†…æ ¸ç»„ä»¶
- `IMAGE_SUBSYSTEM_EFI_APPLICATION` â†’ EFI å¯æ‰§è¡Œæ–‡ä»¶

> âœ… **æ€»ç»“**ï¼š  
>
> - **PE æ˜¯â€œç±»åâ€**ï¼ˆæŠ½è±¡æ ¼å¼æ ‡å‡†ï¼‰  
> - **EXE/DLL/SYS/EFI æ˜¯â€œå®žä¾‹â€**ï¼ˆå…·ä½“ç”¨é€”çš„å®žçŽ°ï¼‰  
> å®ƒä»¬å…±äº«ç›¸åŒçš„â€œå¿ƒè„â€ï¼ˆPE å¤´ç»“æž„ï¼‰ï¼Œä½†æ‰®æ¼”ä¸åŒçš„ç³»ç»Ÿè§’è‰²ã€‚

---
è™½ç„¶éƒ½éµå¾ª PE æ ‡å‡†ï¼Œä½†ä¸åŒæ–‡ä»¶ç±»åž‹æ‰¿æ‹…ç€**æˆªç„¶ä¸åŒçš„æ“ä½œç³»ç»ŸèŒè´£**ã€‚è¿™ç§å¤šæ ·æ€§æºäºŽå¯¹**æ¨¡å—åŒ–ã€å®‰å…¨æ€§ã€èµ„æºæ•ˆçŽ‡å’Œå¯åŠ¨æµç¨‹**çš„éœ€æ±‚ã€‚

---

### 1. EXEï¼ˆExecutableï¼‰â€”â€” ç‹¬ç«‹çš„æ‰§è¡Œä¸»ä½“

- **ç‰¹ç‚¹**ï¼š
  - æ‹¥æœ‰æ˜Žç¡®å…¥å£ç‚¹ï¼ˆå¦‚ `main`ã€`WinMain`ï¼‰ã€‚
  - æ“ä½œç³»ç»Ÿä¸ºå…¶åˆ›å»º**ç‹¬ç«‹è¿›ç¨‹**ã€PEB å’Œä¸»çº¿ç¨‹ã€‚
  - æ˜¯â€œä¸»åŠ¨â€æ‰§è¡Œå•å…ƒï¼ŒæŽ§åˆ¶ç¨‹åºä¸»æµç¨‹ã€‚
- **ä¸ºä½•éœ€è¦**ï¼Ÿ
  - ä½œä¸ºç”¨æˆ·äº¤äº’å’Œä¸šåŠ¡é€»è¾‘çš„ä¸»è¦è½½ä½“ã€‚
  - æ˜¯åº”ç”¨ç¨‹åºçš„â€œæŒ‡æŒ¥ä¸­å¿ƒâ€ï¼Œè´Ÿè´£è°ƒåº¦å…¶ä»–ç»„ä»¶ã€‚

---

### 2. DLLï¼ˆDynamic Link Libraryï¼‰â€”â€” å…±äº«çš„ä»£ç ä»“åº“

- **ç‰¹ç‚¹**ï¼š
  - **è¢«åŠ¨åŠ è½½**ï¼šéœ€ç”± EXE æˆ–å…¶ä»– DLL æ˜¾å¼/éšå¼åŠ è½½ã€‚
  - **å†…å­˜å…±äº«**ï¼šåŒä¸€ç³»ç»Ÿ DLLï¼ˆå¦‚ `kernel32.dll`ï¼‰åœ¨ç‰©ç†å†…å­˜ä¸­ä»…å­˜ä¸€ä»½ä»£ç ï¼ˆCopy-on-Writeï¼‰ã€‚
  - å…¥å£ç‚¹ä¸º `DllMain`ï¼Œä»…ç”¨äºŽåˆå§‹åŒ–/æ¸…ç†ï¼Œä¸æŒç»­è¿è¡Œã€‚
- **ä¸ºä½•æœ‰äº† EXE è¿˜è¦ DLL**ï¼Ÿ
  - âœ… **æ¨¡å—åŒ–å¼€å‘**ï¼šåŠŸèƒ½è§£è€¦ï¼Œä¾¿äºŽç‹¬ç«‹æ›´æ–°ï¼ˆæ— éœ€é‡å‘æ•´ä¸ª EXEï¼‰ã€‚
  - âœ… **å†…å­˜æ•ˆçŽ‡**ï¼šé¿å…é‡å¤é™æ€é“¾æŽ¥é€šç”¨ä»£ç ï¼ˆå¦‚ API å‡½æ•°ï¼‰ã€‚
  - âœ… **æ’ä»¶æž¶æž„**ï¼šæ”¯æŒè¿è¡Œæ—¶åŠ¨æ€æ‰©å±•åŠŸèƒ½ã€‚

---

### 3. SYSï¼ˆSystem Driverï¼‰â€”â€” å†…æ ¸çš„å»¶ä¼¸

- **ç‰¹ç‚¹**ï¼š
  - è¿è¡Œåœ¨ **Ring 0**ï¼ˆå†…æ ¸æ¨¡å¼ï¼‰ï¼Œæ‹¥æœ‰æœ€é«˜æƒé™ã€‚
  - å¯ç›´æŽ¥è®¿é—®ç¡¬ä»¶ã€I/O ç«¯å£ã€ä»»æ„å†…å­˜ã€‚
  - **æ— ç‹¬ç«‹è¿›ç¨‹**ï¼šä¾é™„äºŽç³»ç»Ÿçº¿ç¨‹æˆ–ä¸­æ–­ä¸Šä¸‹æ–‡ã€‚
  - å´©æºƒå¯¼è‡´ **è“å±**ï¼ˆBSODï¼‰ï¼Œè€Œéžæ™®é€šç¨‹åºå´©æºƒã€‚
- **ä¸ºä½•éœ€è¦**ï¼Ÿ
  - ðŸ”§ **ç¡¬ä»¶æŠ½è±¡**ï¼šEXEï¼ˆRing 3ï¼‰æ— æ³•ç›´æŽ¥æ“ä½œç¡¬ä»¶ï¼Œéœ€é©±åŠ¨â€œç¿»è¯‘â€ã€‚
  - ðŸ›¡ï¸ **ç³»ç»Ÿçº§å®‰å…¨**ï¼šæ€æ¯’è½¯ä»¶ã€EDR éœ€åœ¨å†…æ ¸å±‚ç›‘æŽ§è¡Œä¸ºã€‚
  - âš™ï¸ **æ ¸å¿ƒæœåŠ¡å®žçŽ°**ï¼šæ–‡ä»¶ç³»ç»Ÿã€ç½‘ç»œåè®®æ ˆç­‰å‡ç”±é©±åŠ¨æä¾›ã€‚

---

### 4. EFIï¼ˆExtensible Firmware Interfaceï¼‰â€”â€” ç³»ç»Ÿçš„å¯åŠ¨è€…

- **ç‰¹ç‚¹**ï¼š
  - åœ¨ **æ“ä½œç³»ç»ŸåŠ è½½å‰è¿è¡Œ**ï¼Œç”± UEFI å›ºä»¶ç›´æŽ¥æ‰§è¡Œã€‚
  - **æ—  OS ä¾èµ–**ï¼šæ­¤æ—¶æ—  Windows/Linuxï¼Œä»…èƒ½è°ƒç”¨ UEFI æœåŠ¡ã€‚
  - PE å¤´ä¸­ `Subsystem = IMAGE_SUBSYSTEM_EFI_APPLICATION`ã€‚
- **ä¸ºä½•éœ€è¦**ï¼Ÿ
  - ðŸšª **è§£å†³â€œé¸¡ç”Ÿè›‹â€é—®é¢˜**ï¼šEXE éœ€è¦ OS æ‰èƒ½è¿è¡Œï¼Œä½† OS æœ¬èº«éœ€è¢«åŠ è½½ã€‚
  - ðŸ’¾ **å¼•å¯¼åŠ è½½å™¨**ï¼šå¦‚ `bootmgfw.efi` è´Ÿè´£åŠ è½½ Windows å†…æ ¸ã€‚
  - ðŸŒ **æ ‡å‡†åŒ–å›ºä»¶æŽ¥å£**ï¼šå–ä»£ BIOSï¼Œæä¾›ç»Ÿä¸€ç¡¬ä»¶åˆå§‹åŒ–èƒ½åŠ›ã€‚

---

### 5. SCRï¼ˆScreen Saverï¼‰â€”â€” ç‰¹æ®Šç”¨é€”çš„ EXE

- **ç‰¹ç‚¹**ï¼š
  - **æœ¬è´¨æ˜¯ EXE**ï¼Œé‡å‘½åä¸º `.exe` å³å¯è¿è¡Œã€‚
  - å¿…é¡»å“åº”ç‰¹å®šå‘½ä»¤è¡Œå‚æ•°ï¼š
    - `/s`ï¼šå…¨å±è¿è¡Œ
    - `/c`ï¼šæ‰“å¼€é…ç½®çª—å£
    - `/p <hwnd>`ï¼šé¢„è§ˆæ¨¡å¼
- **ä¸ºä½•éœ€è¦ä¸“ç”¨æ ¼å¼**ï¼Ÿ
  - ä¸»è¦æ˜¯ **åŽ†å²è§„èŒƒä¸Žç³»ç»Ÿè¯†åˆ«ä¾¿åˆ©æ€§**ï¼Œä¾¿äºŽé›†æˆåˆ° Windows è®¾ç½®ä¸­ã€‚

---

### 6. OCX / CPL â€”â€” æ’ä»¶å¼æž¶æž„çš„å®žçŽ°è€…

| ç±»åž‹ | å…¨ç§° | æœ¬è´¨ | å…³é”®è¦æ±‚ |
|------|------|------|--------|
| **OCX** | OLE Control Extension | ç‰¹å®šè§„èŒƒçš„ DLL | å®žçŽ° COM æŽ¥å£ï¼ˆå¦‚ `DllRegisterServer`ï¼‰ |
| **CPL** | Control Panel Item | ç‰¹å®šè§„èŒƒçš„ DLL | å¯¼å‡º `CPlApplet` å‡½æ•° |

- **ä¸ºä½•éœ€è¦**ï¼Ÿ
  - ðŸ§© **æ ‡å‡†åŒ–æ’ä»¶æŽ¥å£**ï¼šæŽ§åˆ¶é¢æ¿åªéœ€è¯†åˆ« `.cpl` å¹¶è°ƒç”¨ `CPlApplet`ï¼Œæ— éœ€äº†è§£å†…éƒ¨é€»è¾‘ã€‚
  - ðŸ”Œ **å³æ’å³ç”¨**ï¼šç¬¬ä¸‰æ–¹å¼€å‘è€…å¯æŒ‰è§„èŒƒç¼–å†™æ¨¡å—ï¼Œæ— ç¼é›†æˆåˆ°ç³»ç»Ÿä¸­ã€‚

---

## æ€»ç»“ï¼šä¸ºä½•éœ€è¦å¦‚æ­¤å¤šæ ·çš„ PE æ ¼å¼ï¼Ÿ

çŽ°ä»£æ“ä½œç³»ç»Ÿé‡‡ç”¨ **åˆ†å±‚ã€èŒè´£åˆ†ç¦»** çš„è®¾è®¡å“²å­¦ï¼š

| å±‚çº§ | ç»„ä»¶ | èŒè´£ |
|------|------|------|
| **å›ºä»¶å±‚** | EFI | å¯åŠ¨ç¡¬ä»¶ï¼ŒåŠ è½½å†…æ ¸ |
| **å†…æ ¸å±‚** | SYS | ç®¡ç†ç¡¬ä»¶ã€å†…å­˜ã€å®‰å…¨ |
| **ç³»ç»ŸæœåŠ¡å±‚** | DLL | æä¾›é€šç”¨ APIï¼ˆæ–‡ä»¶ã€ç½‘ç»œã€å›¾å½¢ç­‰ï¼‰ |
| **åº”ç”¨å±‚** | EXE | å®žçŽ°ç”¨æˆ·åŠŸèƒ½ä¸Žäº¤äº’ |

> âŒ **å¦‚æžœåªæœ‰ EXE**ï¼š  
>
> - æ¯ä¸ªç¨‹åºéƒ½è¦è‡ªå·±å†™æ˜¾å¡é©±åŠ¨ã€å†…å­˜ç®¡ç†å™¨ã€‚  
> - æ— æ³•å®žçŽ°å¤šä»»åŠ¡åä½œæˆ–èµ„æºå…±äº«ã€‚  
> - ç³»ç»Ÿè‡ƒè‚¿ã€ä½Žæ•ˆã€æžä¸ç¨³å®šã€‚

âœ… **å¤šæ ·åŒ–çš„ PE æ ¼å¼** æ˜¯çŽ°ä»£å¤šä»»åŠ¡æ“ä½œç³»ç»Ÿ**é«˜æ•ˆã€å®‰å…¨ã€å¯æ‰©å±•**è¿è¡Œçš„åŸºçŸ³ã€‚å®ƒä»¬å…±åŒæž„æˆäº†ä»Žç¡¬ä»¶åˆ°ç”¨æˆ·åº”ç”¨çš„å®Œæ•´æ‰§è¡Œé“¾æ¡ã€‚

## æºç 

### CStr::from_ptr(ptr).to_string_lossy().into_owned()

è¿™æ®µä»£ç çš„æ ¸å¿ƒä½œç”¨æ˜¯ï¼š**å°†ç›®æ ‡ DLL å†…å­˜æ˜ å°„åŒºä¸­çš„â€œC é£Žæ ¼å­—ç¬¦ä¸²ï¼ˆä»¥ null ç»“å°¾çš„åŽŸå§‹å­—èŠ‚ï¼‰â€å®‰å…¨åœ°è½¬æ¢æˆ Rust çŽ¯å¢ƒä¸­å¯ç”¨çš„ã€æ‰€æœ‰æƒç‹¬ç«‹çš„ `String` å¯¹è±¡ã€‚**

è¿™ç§è½¬æ¢åœ¨çº¢é˜ŸåŠ è½½å™¨ï¼ˆå¦‚ `dinvk`ï¼‰ä¸­è‡³å…³é‡è¦â€”â€”æ—¢è¦æ­£ç¡®è¯»å– Windows PE ç»“æž„ä¸­çš„åŽŸå§‹æ•°æ®ï¼Œåˆè¦é¿å…å†…å­˜å®‰å…¨é—®é¢˜ã€‚æˆ‘ä»¬å¯ä»¥å°†å…¶æ‹†è§£ä¸ºä»¥ä¸‹ä¸‰ä¸ªå…³é”®æ­¥éª¤ï¼š

---

#### 1. `CStr::from_ptr(ptr)`ï¼šå°è£…åŽŸå§‹æŒ‡é’ˆï¼Œåˆ›å»ºå®‰å…¨è§†å›¾

- **èƒŒæ™¯**ï¼š  
  `ptr` æ˜¯ä¸€ä¸ªè£¸æŒ‡é’ˆï¼ˆ`*const i8`ï¼‰ï¼ŒæŒ‡å‘ DLL å†…å­˜æ˜ åƒä¸­æŸä¸ªåç§°å­—ç¬¦ä¸²ï¼ˆä¾‹å¦‚ `"kernel32.dll\0"` æˆ– `"NtAllocateVirtualMemory\0"`ï¼‰ã€‚ä»Žè£¸æŒ‡é’ˆåˆ›å»ºäº†ä¸€ä¸ªä¸´æ—¶å¼•ç”¨ &CStrï¼Œå®ƒæ²¡æœ‰åˆ†é…å†…å­˜ï¼Œä¹Ÿæ²¡æœ‰äº§ç”Ÿæ‰€æœ‰æƒã€‚

- **ä½œç”¨**ï¼š  
  `CStr::from_ptr(ptr)` å‘Šè¯‰ Rustï¼šâ€œä»Žè¿™ä¸ªåœ°å€å¼€å§‹ï¼Œé€å­—èŠ‚è¯»å–ï¼Œç›´åˆ°é‡åˆ° `\0` å­—èŠ‚ä¸ºæ­¢â€ï¼Œå¹¶å°†è¯¥å†…å­˜ç‰‡æ®µåŒ…è£…ä¸ºä¸€ä¸ª `CStr` ç±»åž‹ã€‚

- **å…³é”®ç‰¹æ€§**ï¼š  
  - **é›¶æ‹·è´**ï¼š`CStr` ä»…æ˜¯å¯¹åŽŸå§‹å†…å­˜çš„**å€Ÿç”¨ï¼ˆborrowï¼‰**ï¼Œä¸è¿›è¡Œæ•°æ®å¤åˆ¶ã€‚
  - **ç”Ÿå‘½å‘¨æœŸç»‘å®š**ï¼šå®ƒéšå«åœ°ä¾èµ–äºŽåº•å±‚å†…å­˜çš„æœ‰æ•ˆæ€§â€”â€”å¦‚æžœ DLL è¢«å¸è½½æˆ–å†…å­˜è¢«é‡Šæ”¾ï¼Œè¯¥ `CStr` å°†å˜ä¸ºæ‚¬ç©ºå¼•ç”¨ï¼ˆdangling pointerï¼‰ã€‚
  - **å®‰å…¨æŠ½è±¡**ï¼šRust é€šè¿‡ `CStr` æä¾›äº†å¯¹ C å­—ç¬¦ä¸²çš„å®‰å…¨è®¿é—®æŽ¥å£ï¼Œé˜²æ­¢è¶Šç•Œè¯»å–ã€‚

> âœ… æ­¤æ­¥å»ºç«‹äº†å¯¹ DLL å†…éƒ¨å­—ç¬¦ä¸²çš„**å—æŽ§è§†å›¾**ï¼Œä½†å°šæœªè„±ç¦»åŽŸå§‹å†…å­˜çš„æŸç¼šã€‚

---

#### 2. `.to_string_lossy()`ï¼šå®¹é”™å¼ UTF-8 è½¬æ¢

- **èƒŒæ™¯**ï¼š  
  PE æ–‡ä»¶ä¸­çš„å‡½æ•°åå’Œæ¨¡å—åé€šå¸¸ä½¿ç”¨ **ASCII** æˆ– **ANSIï¼ˆå¦‚ Windows-1252ï¼‰** ç¼–ç ï¼Œè€Œ Rust çš„ `String` **ä¸¥æ ¼è¦æ±‚åˆæ³• UTF-8**ã€‚

```rust
pub fn to_string_lossy(&self) -> Cow<'_, str>

pub enum Cow<'a, B>where
    B: ToOwned + ?Sized + 'a,{
    Borrowed(&'a B),
    Owned(<B as ToOwned>::Owned),
}
```

- **ä½œç”¨**ï¼š  
  - å°è¯•å°† `CStr` ä¸­çš„å­—èŠ‚åºåˆ—è§£é‡Šä¸º UTF-8,è¿”å›žä¸€ä¸ªæžšä¸¾ã€‚If the contents of the CStr are valid UTF-8 data, this function will return a Cow::Borrowed with the corresponding &str slice.
  - **â€œLossyâ€ï¼ˆæœ‰æŸï¼‰ç­–ç•¥**ï¼šè‹¥é‡åˆ°éžæ³• UTF-8 åºåˆ—ï¼ˆä¾‹å¦‚æŸäº›æ‰©å±• ASCII å­—ç¬¦ï¼‰ï¼Œä¸ä¼š panicï¼Œè€Œæ˜¯ç”¨ Unicode æ›¿ä»£å­—ç¬¦ ``ï¼ˆU+FFFDï¼‰ä»£æ›¿æ— æ•ˆå­—èŠ‚ã€‚
  - è¿”å›žç±»åž‹ä¸º `Cow<str>`ï¼ˆClone-on-Writeï¼‰ï¼š  
    - å¦‚æžœè¾“å…¥å·²æ˜¯åˆæ³• UTF-8ï¼Œå¯èƒ½ç›´æŽ¥è¿”å›ž `&str`ï¼ˆé›¶åˆ†é…ï¼‰ï¼›  
    - å¦åˆ™ï¼Œä¼šåˆ†é…æ–°å†…å­˜å¹¶è¿”å›žæ‹¥æœ‰æ‰€æœ‰æƒçš„ `String`ã€‚

- å®ƒçš„è¿”å›žç±»åž‹æ˜¯ Cow<'a, str>ã€‚è¿™æ˜¯ä¸€ä¸ªæ™ºèƒ½æžšä¸¾ï¼Œç”¨æ¥ä¼˜åŒ–å†…å­˜åˆ†é…ã€‚
       *æƒ…å†µ A (Borrowed): å¦‚æžœåŽŸå§‹çš„ C å­—ç¬¦ä¸²å·²ç»æ˜¯åˆæ³•çš„ UTF-8ï¼Œå®ƒç›´æŽ¥è¿”å›ž
         Cow::Borrowed(&str)ã€‚è¿™æ˜¯ä¸€ä¸ªå€Ÿç”¨ï¼Œæ²¡æœ‰å‘ç”Ÿå†…å­˜åˆ†é…/æ‹·è´ã€‚
       * æƒ…å†µ B (Owned): å¦‚æžœåŽŸå§‹å­—ç¬¦ä¸²åŒ…å«æ— æ•ˆçš„ UTF-8 å­—ç¬¦ï¼Œå®ƒä¼šå°†æ— æ•ˆå­—ç¬¦æ›¿æ¢ä¸º
         `ï¼Œå¹¶åˆ†é…ä¸€ä¸ªæ–°çš„ Stringï¼Œè¿”å›ž Cow::Owned(String)`ã€‚

- **ä¸ºä½•éœ€è¦ï¼Ÿ**  
  åœ¨çº¢é˜Ÿåœºæ™¯ä¸­ï¼Œä½ æ— æ³•æŽ§åˆ¶ç›®æ ‡ DLL çš„ç¼–ç ç»†èŠ‚ï¼ˆå°¤å…¶æ˜¯ç¬¬ä¸‰æ–¹æˆ–ç³»ç»Ÿ DLLï¼‰ã€‚`to_string_lossy()` æä¾›äº†**å¥å£®æ€§ä¿éšœ**ï¼Œé¿å…å› ä¸ªåˆ«éžæ ‡å‡†å­—ç¬¦å¯¼è‡´æ•´ä¸ªåŠ è½½å™¨å´©æºƒã€‚

---

#### 3. `.into_owned()`ï¼šå¤ºå–æ‰€æœ‰æƒï¼Œå®žçŽ°æ·±æ‹·è´

- **èƒŒæ™¯**ï¼š  
  `to_string_lossy()` è¿”å›žçš„ `Cow<str>` å¯èƒ½ä»æ˜¯å¯¹ DLL å†…å­˜çš„å¼•ç”¨ï¼ˆå°¤å…¶åœ¨çº¯ ASCII æƒ…å†µä¸‹ï¼‰.to_string_lossy(),å¯èƒ½è¿”å›žå€Ÿç”¨ï¼ˆBorrowedï¼‰ï¼Œè€Œåœ¨è¿™ä¸ªä»£ç å—ç»“æŸåŽï¼ŒåŽŸå§‹çš„æŒ‡é’ˆå¼•ç”¨ï¼ˆæˆ–è€…æ˜¯å€Ÿç”¨çš„ç”Ÿå‘½å‘¨,æœŸï¼‰å¯èƒ½ä¸å†é€‚ç”¨ï¼Œæˆ–è€…ä½ éœ€è¦ä¸€ä¸ªç¡®å®šçš„ String ç±»åž‹æ¥ä¼ å€¼/å­˜å‚¨ã€‚

- **ä½œç”¨**ï¼š  
  å¼ºåˆ¶å°†å­—ç¬¦ä¸²å†…å®¹**æ·±æ‹·è´åˆ° Rust å †å†…å­˜ä¸­**ï¼Œè¿”å›žä¸€ä¸ªå®Œå…¨ç‹¬ç«‹çš„ `String` å¯¹è±¡ã€‚
  å¦‚æžœæ˜¯ Borrowedï¼Œå®ƒä¼šè°ƒç”¨ .to_string() è¿›è¡Œæ‹·è´ï¼Œç”Ÿæˆä¸€ä¸ªæ–°çš„Stringï¼ˆæ­¤æ—¶æ‰çœŸæ­£èŽ·å–æ‰€æœ‰æƒï¼‰ã€‚å¦‚æžœæ˜¯ Ownedï¼Œå®ƒç›´æŽ¥å–å‡ºé‡Œé¢çš„ Stringï¼Œä¸è¿›è¡Œé¢å¤–æ‹·è´ã€‚

- **å®‰å…¨æ„ä¹‰**ï¼š  
  - å³ä¾¿åŽç»­ DLL è¢« `FreeLibrary` å¸è½½ï¼Œæˆ–å…¶å†…å­˜è¢«è¦†ç›–/é‡Šæ”¾ï¼Œè¯¥ `String` ä¾ç„¶æœ‰æ•ˆã€‚
  - ç¬¦åˆ Rust çš„**æ‰€æœ‰æƒæ¨¡åž‹**ï¼š`dll_name` å˜é‡çŽ°åœ¨æ‹¥æœ‰è‡ªå·±çš„æ•°æ®ï¼Œç”Ÿå‘½å‘¨æœŸä¸å†ä¾èµ–å¤–éƒ¨æ¨¡å—ã€‚

> ðŸ”’ è¿™æ˜¯å®žçŽ°â€œå†…å­˜éš”ç¦»â€çš„å…³é”®ä¸€æ­¥â€”â€”è®©æ•æ„Ÿæ“ä½œï¼ˆå¦‚æ—¥å¿—ã€è½¬å‘è§£æžã€å“ˆå¸Œæ¯”å¯¹ï¼‰åŸºäºŽ**å®‰å…¨å‰¯æœ¬**è¿›è¡Œã€‚
to_string_lossy() æ˜¯ä¸€ç§â€œæ‡’æƒ°â€çš„è½¬æ¢ï¼Œåªæœ‰åœ¨å¿…è¦æ—¶ï¼ˆé‡åˆ°æ— æ•ˆUTF-8ï¼‰æ‰åˆ†é…å†…å­˜ã€‚åŠ ä¸Š.into_owned() æ˜¯ä¸ºäº†ç¡®ä¿ä½ æœ€ç»ˆæ‹¿åˆ°çš„ä¸€å®šæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ã€æ‹¥æœ‰æ‰€æœ‰æƒçš„ String å¯¹è±¡
---

#### åœ¨ `dinvk` é¡¹ç›®ä¸­çš„å…·ä½“æ„ä¹‰

åœ¨ `get_proc_address` å‡½æ•°ä¸­ï¼ŒèŽ·å–å½“å‰ DLL çš„åç§°ï¼ˆ`dll_name`ï¼‰ä¸»è¦ç”¨äºŽå¤„ç† **å‡½æ•°è½¬å‘ï¼ˆExport Forwardingï¼‰** åœºæ™¯ï¼š

- æŸäº› DLLï¼ˆå¦‚ `kernel32.dll`ï¼‰å¹¶ä¸ç›´æŽ¥å®žçŽ°æ‰€æœ‰å¯¼å‡ºå‡½æ•°ï¼Œè€Œæ˜¯é€šè¿‡å¯¼å‡ºè¡¨ä¸­çš„**è½¬å‘æ¡ç›®**æŒ‡ç¤ºï¼šâ€œè¯·åŽ» `kernelbase.dll!SomeFunction` æ‰¾çœŸæ­£çš„å®žçŽ°â€ã€‚
- ä¸ºäº†é€’å½’è§£æžè¿™ç±»è½¬å‘ï¼Œç¨‹åºå¿…é¡»çŸ¥é“ï¼š
  1. å½“å‰æ­£åœ¨è§£æžçš„æ˜¯å“ªä¸ª DLLï¼ˆå³ `dll_name`ï¼‰ï¼›
  2. è½¬å‘ç›®æ ‡çš„æ ¼å¼ï¼ˆå¦‚ `"KERNELBASE.CreateFileW"`ï¼‰ã€‚

å› æ­¤ï¼Œ`dll_name` ä¼šè¢«ä¼ å…¥ `get_forwarded_address` å‡½æ•°ï¼Œç”¨äºŽï¼š

- åˆ†å‰²è½¬å‘å­—ç¬¦ä¸²ï¼ˆæå–ç›®æ ‡ DLL åå’Œå‡½æ•°åï¼‰
- é€’å½’åŠ è½½æˆ–æŸ¥æ‰¾ç›®æ ‡æ¨¡å—
- æœ€ç»ˆå®šä½çœŸå®žå‡½æ•°åœ°å€

---

#### ä¸€å¥è¯æ€»ç»“

> è¿™è¡Œä»£ç å®Œæˆäº†ä»Ž **â€œå±é™©çš„åŽŸå§‹å†…å­˜å­—èŠ‚â€** åˆ° **â€œå®‰å…¨çš„ã€ç¬¦åˆ Rust æ‰€æœ‰æƒæ¨¡åž‹çš„æ ‡å‡†å­—ç¬¦ä¸²â€** çš„è·¨è¶Šï¼Œæ—¢ä¿è¯äº†ä¸Ž Windows PE ç»“æž„çš„å…¼å®¹æ€§ï¼Œåˆæœç»äº†æ‚¬ç©ºæŒ‡é’ˆå’Œç¼–ç å´©æºƒé£Žé™©â€”â€”è¿™æ˜¯æž„å»ºå¯é ã€éšè”½åŠ è½½å™¨çš„åŸºçŸ³ä¹‹ä¸€ã€‚

### CStr::from_ptr((h_module + names[i] as usize) as *const i8).to_str().unwrap_or("")

#### æ€§èƒ½ä¸Žç”Ÿå‘½å‘¨æœŸé©±åŠ¨çš„è®¾è®¡ï¼šä¸ºä½•åœ¨å¾ªçŽ¯ä¸­ä½¿ç”¨ `to_str()` è€Œéž `to_string_lossy().into_owned()`

è¿™æ®µä»£ç åœ¨å¤„ç† DLL å¯¼å‡ºå‡½æ•°åæ—¶ï¼Œå¯¹ `dll_name` å’Œå¾ªçŽ¯ä¸­çš„ `name` é‡‡ç”¨äº†ä¸åŒçš„å­—ç¬¦ä¸²è½¬æ¢ç­–ç•¥ï¼Œä¸»è¦å‡ºäºŽ **æ€§èƒ½ä¼˜åŒ–** å’Œ **ç”Ÿå‘½å‘¨æœŸç®¡ç†** ä¸¤æ–¹é¢çš„æ·±æ€ç†Ÿè™‘ï¼š

---

#### 1. **æ€§èƒ½å·®å¼‚ï¼šé¿å…åœ¨å¾ªçŽ¯ä¸­äº§ç”Ÿå¤§é‡ä¸´æ—¶å†…å­˜åˆ†é…**

- **`dll_name`ï¼ˆå¾ªçŽ¯å¤–ï¼‰**ï¼š  
  æ•´ä¸ªå‡½æ•°åªéœ€è§£æžä¸€æ¬¡æ¨¡å—åç§°ï¼ˆå¦‚ `"kernel32.dll"`ï¼‰ã€‚å³ä½¿ä½¿ç”¨ `to_string_lossy().into_owned()` è¿›è¡Œä¸€æ¬¡å †å†…å­˜åˆ†é…ï¼Œå¼€é”€å¾®ä¹Žå…¶å¾®ï¼Œå®Œå…¨å¯ä»¥æŽ¥å—ã€‚

- **`name`ï¼ˆå¾ªçŽ¯å†…ï¼‰**ï¼š  
  æ­¤å¤„çš„ `for` å¾ªçŽ¯ä¼šéåŽ†ç›®æ ‡ DLL çš„**å…¨éƒ¨å¯¼å‡ºå‡½æ•°å**ã€‚åƒ `ntdll.dll` æˆ– `kernel32.dll` è¿™ç±»ç³»ç»Ÿ DLLï¼Œé€šå¸¸åŒ…å« **æ•°åƒä¸ªå¯¼å‡ºé¡¹**ã€‚
  - è‹¥å¯¹æ¯ä¸ª `name` éƒ½è°ƒç”¨ `to_string_lossy().into_owned()`ï¼Œå°†å¯¼è‡´ï¼š
    - æ¯æ¬¡è¿­ä»£éƒ½è¿›è¡Œä¸€æ¬¡ **å †å†…å­˜åˆ†é…**ï¼ˆ`malloc`/`HeapAlloc`ï¼‰
    - ç´§æŽ¥ç€åœ¨ä½œç”¨åŸŸç»“æŸæ—¶ **ç«‹å³é‡Šæ”¾**ï¼ˆ`free`/`HeapFree`ï¼‰
    - æ•°åƒæ¬¡æ— æ„ä¹‰çš„åˆ†é…/é‡Šæ”¾ä¸ä»…æµªè´¹ CPU å‘¨æœŸï¼Œè¿˜å¯èƒ½è§¦å‘å†…å­˜ç¢Žç‰‡æˆ– EDR å¯¹å¼‚å¸¸å †è¡Œä¸ºçš„ç›‘æŽ§ã€‚
  - è€Œä½¿ç”¨ `CStr::from_ptr(...).to_str()` å¾—åˆ°çš„æ˜¯ä¸€ä¸ª `&str`ï¼ˆå­—ç¬¦ä¸²åˆ‡ç‰‡ï¼‰ï¼Œå®ƒ**ç›´æŽ¥æŒ‡å‘ DLL å†…å­˜æ˜ åƒä¸­çš„åŽŸå§‹å­—èŠ‚**ï¼Œ**é›¶æ‹·è´ã€é›¶åˆ†é…**ï¼Œæ€§èƒ½æžé«˜ã€‚

> âœ… åœ¨é«˜é¢‘å¾ªçŽ¯ä¸­ï¼Œé¿å… `String` æ˜¯ Rust é«˜æ€§èƒ½ç¼–ç¨‹çš„åŸºæœ¬å‡†åˆ™ã€‚

---

#### 2. **ç”Ÿå‘½å‘¨æœŸä¸Žä½¿ç”¨åœºæ™¯çš„åŒ¹é…**

- **`name` æ˜¯ä¸´æ—¶çš„**ï¼š  
  åœ¨å¾ªçŽ¯ä½“å†…ï¼Œ`name` ä»…ç”¨äºŽï¼š
  - ä¸Žç”¨æˆ·ä¼ å…¥çš„ç›®æ ‡å‡½æ•°åï¼ˆ`api_name`ï¼‰è¿›è¡Œå­—ç¬¦ä¸²æ¯”è¾ƒ
  - æˆ–è®¡ç®—å“ˆå¸Œå€¼ç”¨äºŽå¿«é€ŸåŒ¹é…  
  ä¸€æ—¦æ¯”è¾ƒå®Œæˆï¼Œè¯¥åç§°å°±ä¸å†éœ€è¦ã€‚å› æ­¤ï¼Œä¸€ä¸ª**ä¸´æ—¶çš„ã€æ— æ‰€æœ‰æƒçš„ `&str`** å®Œå…¨æ»¡è¶³éœ€æ±‚ï¼Œä¸”ç”Ÿå‘½å‘¨æœŸå¤©ç„¶å—é™äºŽå½“å‰è¿­ä»£ã€‚

- **`dll_name` å…·æœ‰å»¶ç»­æ€§**ï¼š  
  è¯¥å˜é‡åœ¨ä¸»é€»è¾‘å—ç»“æŸåŽï¼Œè¿˜éœ€ä½œä¸ºå‚æ•°ä¼ é€’ç»™ `get_forwarded_address` å‡½æ•°ï¼ˆç”¨äºŽå¤„ç†å‡½æ•°è½¬å‘ï¼‰ã€‚è™½ç„¶åœ¨å½“å‰ä¸Šä¸‹æ–‡ä¸­ `&str` ä¹Ÿèƒ½å·¥ä½œï¼ˆå› ä¸º DLL å†…å­˜ä¸ä¼šè¢«å¸è½½ï¼‰ï¼Œä½†ä½¿ç”¨ `String` èƒ½ï¼š
  - æ˜Žç¡®è¡¨è¾¾â€œæ­¤æ•°æ®éœ€è·¨ä½œç”¨åŸŸä½¿ç”¨â€çš„æ„å›¾
  - é¿å…åœ¨æ›´å¤æ‚çš„æŽ§åˆ¶æµä¸­å› å¼•ç”¨æ‚¬ç©ºï¼ˆdangling referenceï¼‰å¼•å‘å®‰å…¨é—®é¢˜
  - æå‡ä»£ç çš„å¯ç»´æŠ¤æ€§å’Œé²æ£’æ€§

---

#### 3. **å®¹é”™ç­–ç•¥çš„å·®å¼‚åŒ–é€‰æ‹©**

- **`to_str()`ï¼ˆä¸¥æ ¼æ¨¡å¼ï¼‰**ï¼š  
  - è‹¥å‡½æ•°ååŒ…å«éžæ³• UTF-8 å­—èŠ‚ï¼ˆå¦‚æŸäº›éžæ ‡å‡† ANSI æ‰©å±•å­—ç¬¦ï¼‰ï¼Œ`to_str()` ä¼šè¿”å›ž `Err`ã€‚
  - é€šè¿‡ `unwrap_or("")`ï¼Œå¼‚å¸¸é¡¹ä¼šè¢«è½¬ä¸ºç©ºå­—ç¬¦ä¸²ï¼Œä»Žè€Œåœ¨åŽç»­æ¯”è¾ƒä¸­è‡ªç„¶è¢«è·³è¿‡ã€‚
  - **åˆç†æ€§**ï¼šåœ¨ç³»ç»Ÿ DLL ä¸­ï¼Œåˆæ³•çš„å¯¼å‡ºå‡½æ•°åå‡ ä¹Žæ€»æ˜¯ ASCIIï¼ˆUTF-8 å…¼å®¹ï¼‰ã€‚è‹¥å‡ºçŽ°ç¼–ç é”™è¯¯ï¼Œæžå¯èƒ½æ˜¯æŸåæ¡ç›®æˆ–å¹²æ‰°é¡¹ï¼Œç›´æŽ¥å¿½ç•¥æ˜¯å®‰å…¨ä¸”é«˜æ•ˆçš„é€‰æ‹©ã€‚

- **`to_string_lossy()`ï¼ˆå®½å®¹æ¨¡å¼ï¼‰**ï¼š  
  - å¯¹éžæ³•å­—èŠ‚è¿›è¡Œæ›¿æ¢ï¼ˆå¦‚ `` U+FFFDï¼‰ï¼Œä¿è¯è½¬æ¢æ°¸ä¸å¤±è´¥ã€‚
  - é€‚ç”¨äºŽ**å…³é”®å…ƒæ•°æ®**ï¼ˆå¦‚æ¨¡å—åï¼‰ï¼Œå› ä¸ºä¸¢å¤±æ•´ä¸ª DLL åå¯èƒ½å¯¼è‡´è½¬å‘è§£æžå¤±è´¥ã€‚
  - ä½œè€…å¯èƒ½è®¤ä¸ºï¼šâ€œå³ä½¿åå­—å¸¦å ä½ç¬¦ï¼Œä¹Ÿæ¯”å®Œå…¨æ— æ³•å¤„ç†æ›´å¯å–â€ã€‚

---

#### æ€»ç»“

åœ¨ Rust åº•å±‚ç³»ç»Ÿç¼–ç¨‹ä¸­ï¼Œæœ‰ä¸€æ¡é»„é‡‘æ³•åˆ™ï¼š**â€œèƒ½åœ¨å¾ªçŽ¯ä¸­ç”¨å¼•ç”¨ï¼ˆ`&str`ï¼‰å°±ç»ä¸ç”¨æ‹¥æœ‰æƒå¯¹è±¡ï¼ˆ`String`ï¼‰â€**ã€‚  
æ­¤å¤„å¯¹ `name` ä½¿ç”¨ `to_str()`ï¼Œæ­£æ˜¯ä¸ºäº†åœ¨éåŽ†æˆç™¾ä¸Šåƒä¸ªå¯¼å‡ºå‡½æ•°æ—¶ï¼Œ**å°† CPU æ—¶é—´é›†ä¸­åœ¨æ ¸å¿ƒé€»è¾‘ä¸Šï¼Œè€Œéžæµªè´¹åœ¨å †å†…å­˜çš„é¢‘ç¹ç”³è¯·ä¸Žé‡Šæ”¾ä¸­**ã€‚è¿™ç§è®¾è®¡æ—¢ä½“çŽ°äº†å¯¹æ€§èƒ½çš„æžè‡´è¿½æ±‚ï¼Œä¹Ÿå±•ç¤ºäº†å¯¹ Rust æ‰€æœ‰æƒæ¨¡åž‹å’Œç”Ÿå‘½å‘¨æœŸè¯­ä¹‰çš„ç²¾å‡†æŠŠæ¡â€”â€”è¿™æ­£æ˜¯é«˜è´¨é‡çº¢é˜Ÿå·¥å…·æˆ–ç³»ç»Ÿçº§åŠ è½½å™¨çš„å…³é”®ç‰¹è´¨ã€‚
